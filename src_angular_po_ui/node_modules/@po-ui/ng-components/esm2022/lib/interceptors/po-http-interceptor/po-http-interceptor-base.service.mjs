import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
import { poHttpInterceptorLiterals } from './po-http-interceptor-literals';
const NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `type`: É possível informar `error`, `warning` e `information`, sendo `error` o valor padrão.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 * - `detailTitle`: caso for informado, será apresentado como título dos detalhes substituindo o padrão `code - message`
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - `X-PO-No-Error`: Não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
export class PoHttpInterceptorBaseService {
    componentInjector;
    notification;
    languageService;
    notificationTypes = ['success', 'warning', 'error', 'information'];
    literals;
    httpInterceptorDetailComponent = undefined;
    constructor(componentInjector, notification, languageService) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.languageService = languageService;
        this.literals = poHttpInterceptorLiterals[this.languageService?.getShortLanguage()];
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: this.literals.serverNotResponse, detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        const errorResponseValidTypes = this.notificationTypes.slice(1);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification({
                ...errorResponse,
                type: errorResponseValidTypes.includes(errorResponse.type) ? errorResponse.type : 'error'
            });
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = this.literals.help;
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = this.literals.details;
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => {
            window.open(helpUrl, '_blank');
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLWludGVyY2VwdG9yL3BvLWh0dHAtaW50ZXJjZXB0b3ItYmFzZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFJTCxZQUFZLEVBR2IsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sbUVBQW1FLENBQUM7QUFDckgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFHM0UsTUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUM7QUFDOUMsTUFBTSx1QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztBQUVsRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBOEhHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFRdEM7SUFDQTtJQUNBO0lBVFYsaUJBQWlCLEdBQUcsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVuRSxRQUFRLENBQU07SUFFTiw4QkFBOEIsR0FBbUQsU0FBUyxDQUFDO0lBRW5HLFlBQ1UsaUJBQTZDLEVBQzdDLFlBQWlCLEVBQ2pCLGVBQWtDO1FBRmxDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBNEI7UUFDN0MsaUJBQVksR0FBWixZQUFZLENBQUs7UUFDakIsb0JBQWUsR0FBZixlQUFlLENBQW1CO1FBRTFDLElBQUksQ0FBQyxRQUFRLEdB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QUksQ0FBQyxJQUFJLENBQUMsOEJBQThCLEVBQUU7Z0JBQ3hDLElBQUksQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDbkM7UUFDSCxDQUFDLENBQUM7SUFDSixDQUFDO0lBRU8sMEJBQTBCLENBQUMsZUFBb0I7UUFDckQsSUFBSSxrQkFBa0IsQ0FBQztRQUN2QixJQUFJLGlCQUFpQixDQUFDO1FBRXRCLElBQUksZUFBZSxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsZUFBZSxDQUFDLGVBQWUsSUFBSSxlQUFlLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDNUYsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7WUFDdkMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM1RTthQUFNLElBQUksZUFBZSxDQUFDLGVBQWUsSUFBSSxlQUFlLENBQUMsT0FBTyxFQUFFO1lBQ3JFLGlCQUFpQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQzFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUNoRTtRQUNELE9BQU8sRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFDbEUsQ0FBQztJQUVPLHVCQUF1QixDQUFDLE9BQWU7UUFDN0MsT0FBTyxHQUFHLEVBQUU7WUFDVixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEh0dHBJbnRlcmNlcHRvcixcbiAgSHR0cEhhbmRsZXIsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwUmVzcG9uc2UsXG4gIEh0dHBFdmVudCxcbiAgSHR0cEVycm9yUmVzcG9uc2Vcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29tcG9uZW50LWluamVjdG9yL3BvLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsIH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBwb0h0dHBJbnRlcmNlcHRvckxpdGVyYWxzIH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWxpdGVyYWxzJztcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tbGFuZ3VhZ2UvcG8tbGFuZ3VhZ2Uuc2VydmljZSc7XG5cbmNvbnN0IE5PX0VSUk9SX0hFQURFUl9QQVJBTSA9ICdYLVBPLU5vLUVycm9yJztcbmNvbnN0IE5PX01FU1NBR0VfSEVBREVSX1BBUkFNID0gJ1gtUE8tTm8tTWVzc2FnZSc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyAqaW50ZXJjZXB0b3IqIHRlbSBhIGZpbmFsaWRhZGUgZGUgZXhpYmlyIG5vdGlmaWNhw6fDtWVzIGNvbSBtZW5zYWdlbnMgbmEgdGVsYSwgYmFzZWFkbyBuYXMgcmVzcG9zdGFzIGRhcyByZXF1aXNpw6fDtWVzIEhUVFAuXG4gKlxuICogUG9kZSBzZXIgdXRpbGl6YWRvIHBhcmEgZGFyIGZlZWRiYWNrIGRhcyBhw6fDtWVzIGRvIHVzdcOhcmlvIGNvbW8sIHBvciBleGVtcGxvOiBlcnJvIGRlIGF1dG9yaXphw6fDo28sIG1lbnNhZ2VucyBkZSByZWdyYXMgZGUgbmVnw7NjaW8sXG4gKiBhdHVhbGl6YcOnw7VlcyBkZSByZWdpc3Ryb3MsIGVycm8gcXVhbmRvIG8gc2Vydmlkb3IgZXN0aXZlciBpbmRpc3BvbsOtdmVsIGUgZW50cmUgb3V0cm9zLlxuICpcbiAqICMjIENvbmZpZ3VyYcOnw6NvXG4gKlxuICogUGFyYSBvIGNvcnJldG8gZnVuY2lvbmFtZW50byBkbyBpbnRlcmNlcHRvciBgcG8taHR0cC1pbnRlcmNlcHRvcmAsIGRldmUgc2VyIGltcG9ydGFkbyBvIGBCcm93c2VyQW5pbWF0aW9uc01vZHVsZWAgbm9cbiAqIG3Ds2R1bG8gcHJpbmNpcGFsIGRhIHN1YSBhcGxpY2HDp8Ojby5cbiAqXG4gKiBNw7NkdWxvIGRhIGFwbGljYcOnw6NvOlxuICogYGBgXG4gKiBpbXBvcnQgeyBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXIvYW5pbWF0aW9ucyc7XG4gKiBpbXBvcnQgeyBQb01vZHVsZSB9IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcbiAqIC4uLlxuICpcbiAqIEBOZ01vZHVsZSh7XG4gKiAgIGltcG9ydHM6IFtcbiAqICAgICBCcm93c2VyTW9kdWxlLFxuICogICAgIEJyb3dzZXJBbmltYXRpb25zTW9kdWxlLFxuICogICAgIC4uLlxuICogICAgIFBvTW9kdWxlXG4gKiAgIF0sXG4gKiAgIGRlY2xhcmF0aW9uczogW1xuICogICAgIEFwcENvbXBvbmVudCxcbiAqICAgICAuLi5cbiAqICAgXSxcbiAqICAgcHJvdmlkZXJzOiBbXSxcbiAqICAgYm9vdHN0cmFwOiBbQXBwQ29tcG9uZW50XVxuICogfSlcbiAqIGV4cG9ydCBjbGFzcyBBcHBNb2R1bGUgeyB9XG4gKiBgYGBcbiAqXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXG4gKiBkZSBxdWFscXVlciBjb25maWd1cmHDp8OjbyBleHRyYS5cbiAqXG4gKiBBbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemUgbyBgSHR0cENsaWVudGAsIGNvbmZvcm1lIGV4ZW1wbG8gYWJhaXhvOlxuICpcbiAqIGBgYFxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAqXG4gKiAuLi5cbiAqXG4gKiBASW5qZWN0YWJsZSgpXG4gKiBleHBvcnQgY2xhc3MgVXNlclNlcnZpY2Uge1xuICpcbiAqICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7IH1cbiAqXG4gKiAgIGdldFVzZXJzKCkge1xuICogICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KCcvYXBpL3VzZXJzJyk7XG4gKiAgIH1cbiAqXG4gKiAgIC4uLlxuICpcbiAqIH1cbiAqIGBgYFxuICpcbiAqICMjIENvbW8gdXNhclxuICpcbiAqIFBhcmEgZXhpYmlyIGFzIG5vdGljYcOnw7VlcyDDqSBuZWNlc3PDoXJpbyBpbmZvcm1hciBhIG1lbnNhZ2VtIG5vIHJldG9ybm8gZGEgcmVxdWlzacOnw6NvLiBBIGVzdHJ1dHVyYSBkYSBtZW5zYWdlbVxuICogw6kgZmVpdGEgY29tIGJhc2Ugbm8gc3RhdHVzIGRhIHJlc3Bvc3RhLCBjb25mb3JtZSBzZXLDoSBhcHJlc2VudGFkbyBub3MgcHLDs3hpbW9zIHTDs3BpY29zLlxuICpcbiAqICMjIyBFc3RydXR1cmEgZGFzIG1lbnNhZ2Vuc1xuICpcbiAqICMjIyMgTWVuc2FnZW5zIGRlIHN1Y2Vzc28gYDJ4eGBcbiAqXG4gKiBQYXJhIGV4aWJpciBtZW5zYWdlbnMgYW8gcmV0b3JuYXIgdW1hIGxpc3RhIG91IHVtIGl0ZW0sIGRldmUtc2UgaW5jbHVpciBhIHByb3ByaWVkYWRlIGBfbWVzc2FnZXNgIG5vIG9iamV0byBkZSByZXRvcm5vLlxuICogUG9yIGV4ZW1wbG86XG4gKiBgYGBcbiAqIHtcbiAqICAgXCJfbWVzc2FnZXNcIjogW1xuICogICAgIHtcbiAqICAgICAgIFwidHlwZVwiOiBcInN1Y2Nlc3NcIiB8fCBcIndhcm5pbmdcIiB8fCBcImVycm9yXCIgfHwgXCJpbmZvcm1hdGlvblwiIChzZXLDoSBleGliaWRvIGEgYHRhZ2AgYXBlbmFzIHNlIGVzdGEgcHJvcHJpZWRhZGUgcG9zc3VpciB2YWxvciksXG4gKiAgICAgICBcImNvZGVcIjogXCJ0w610dWxvIG91IGPDs2RpZ28gZGEgbWVuc2FnZW1cIixcbiAqICAgICAgIFwibWVzc2FnZVwiOiBcInRleHRvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICAgICBcImRldGFpbGVkTWVzc2FnZVwiOiBcImRldGFsaGFtZW50byBkYSBtZW5zYWdlbVwiXG4gKiAgICAgfVxuICogICBdXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiAjIyMjIE1lbnNhZ2VucyBkZSBlcnJvIGA0eHhgIG91IGA1eHhgXG4gKlxuICogQW8gcmV0b3JuYXIgZXJybywgbyBvYmpldG8gbsOjbyBuZWNlc3NpdGEgdGVyIGBfbWVzc2FnZXNgLCBkZXZlLXNlIHJldG9ybmFyIG8gb2JqZXRvIGRpcmV0YW1lbnRlOlxuICpcbiAqIGBgYFxuICoge1xuICogICAgXCJjb2RlXCI6IFwidMOtdHVsbyBvdSBjw7NkaWdvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICBcIm1lc3NhZ2VcIjogXCJ0ZXh0byBkYSBtZW5zYWdlbVwiLFxuICogICAgXCJkZXRhaWxlZE1lc3NhZ2VcIjogXCJkZXRhbGhhbWVudG8gZGEgbWVuc2FnZW1cIlxuICogfVxuICogYGBgXG4gKlxuICogVGFtYsOpbSDDqSBwb3Nzw612ZWwgaW5mb3JtYXIgYXMgc2VndWludGVzIHByb3ByaWVkYWRlczpcbiAqXG4gKiAtIGBoZWxwVXJsYDogbGluayBwYXJhIGEgZG9jdW1lbnRhw6fDo28gZG8gZXJybztcbiAqICAgIC0gQ2FzbyBmb3IgaW5mb3JtYWRvLCBzZXLDoSBleGliaWRvIHVtYSBhw6fDo28gZGUgXCJBanVkYVwiIG5hIG5vdGlmaWNhw6fDo28sIHBhcmEgaXNzbyBuw6NvIGRldmVyw6EgdGVyIGEgcHJvcHJpZWRhZGUgYGRldGFpbGVkTWVzc2FnZWAuXG4gKiAtIGB0eXBlYDogw4kgcG9zc8OtdmVsIGluZm9ybWFyIGBlcnJvcmAsIGB3YXJuaW5nYCBlIGBpbmZvcm1hdGlvbmAsIHNlbmRvIGBlcnJvcmAgbyB2YWxvciBwYWRyw6NvLlxuICogLSBgZGV0YWlsc2A6IFVtYSBsaXN0YSBkZSBvYmpldG9zIGRlIG1lbnNhZ2VtIChyZWN1cnNpdmEpIGNvbSBtYWlzIGRldGFsaGVzIHNvYnJlIGEgbWVuc2FnZW0gcHJpbmNpcGFsLlxuICogLSBgZGV0YWlsVGl0bGVgOiBjYXNvIGZvciBpbmZvcm1hZG8sIHNlcsOhIGFwcmVzZW50YWRvIGNvbW8gdMOtdHVsbyBkb3MgZGV0YWxoZXMgc3Vic3RpdHVpbmRvIG8gcGFkcsOjbyBgY29kZSAtIG1lc3NhZ2VgXG4gKlxuICogPiBWZWphIG8gW0d1aWEgZGUgaW1wbGVtZW50YcOnw6NvIGRlIEFQSXNdKGd1aWRlcy9hcGkpIHBhcmEgbWFpcyBkZXRhbGhlcyBzb2JyZSBhIGVzdHJ1dHVyYSBkYXMgbWVuc2FnZW5zLlxuICpcbiAqICMjIyBDYWJlw6dhbGhvXG4gKlxuICogw4kgcG9zc8OtdmVsIGRpc3BlbnNhciBhIG5vdGlmaWNhw6fDo28gcGFyYSBvIHVzdcOhcmlvIHV0aWxpemFuZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gb3MgcGFyw6JtZXRyb3MgbGlzdGFkb3MgYWJhaXhvIGNvbSBvIHZhbG9yXG4gKiBpZ3VhbCBhIGB0cnVlYDpcbiAqXG4gKiAtIGBYLVBPLU5vLU1lc3NhZ2VgOiBOw6NvIGV4aWJlIG5vdGlmaWNhw6fDtWVzIGRlIGVycm8gZS9vdSBzdWNlc3NvLlxuICpcbiAqIC0gYFgtUE8tTm8tRXJyb3JgOiBOw6NvIG1vc3RyYSBub3RpZmljYcOnw7VlcyBkZSBlcnJvIGNvbSBjw7NkaWdvcyBgNHh4YCBlIGA1eHhgLlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tTWVzc2FnZSc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqXG4gKiA+IEFww7NzIGEgdmFsaWRhw6fDo28gbm8gKmludGVyY2VwdG9yKiwgb3MgcGFyw6JtZXRyb3Mgc2Vyw6NvIHJlbW92aWRvcyBkbyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8Ojby5cbiAqXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQb0h0dHBJbnRlcmNlcHRvckJhc2VTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgbm90aWZpY2F0aW9uVHlwZXMgPSBbJ3N1Y2Nlc3MnLCAnd2FybmluZycsICdlcnJvcicsICdpbmZvcm1hdGlvbiddO1xuXG4gIGxpdGVyYWxzOiBhbnk7XG5cbiAgcHJpdmF0ZSBodHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQ6IENvbXBvbmVudFJlZjxQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudD4gPSB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb21wb25lbnRJbmplY3RvcjogUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBub3RpZmljYXRpb246IGFueSxcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5saXRlcmFscyA9IHBvSHR0cEludGVyY2VwdG9yTGl0ZXJhbHNbdGhpcy5sYW5ndWFnZVNlcnZpY2U/LmdldFNob3J0TGFuZ3VhZ2UoKV07XG4gIH1cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY2xvbmVSZXF1ZXN0ID0gcmVxdWVzdC5jbG9uZSgpO1xuXG4gICAgcmVxdWVzdCA9IHJlcXVlc3QgJiYgdGhpcy5oYXNQYXJhbWV0ZXJzKHJlcXVlc3QpID8gdGhpcy5jbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0KSA6IHJlcXVlc3Q7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UsIGNsb25lUmVxdWVzdCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgdGhpcy5wcm9jZXNzRXJyb3JSZXNwb25zZShlcnJvciwgY2xvbmVSZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcm9jZXNzUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzTm9NZXNzYWdlUGFyYW0gPSB0aGlzLmhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3QpO1xuXG4gICAgaWYgKCFoYXNOb01lc3NhZ2VQYXJhbSAmJiByZXNwb25zZS5ib2R5ICYmIHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzKSB7XG4gICAgICBjb25zdCBtZXNzYWdlcyA9IHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzO1xuXG4gICAgICBpZiAobWVzc2FnZXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBtZXNzYWdlcy5mb3JFYWNoKChtZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbihtZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb2Nlc3NFcnJvclJlc3BvbnNlKHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IGVycm9yUmVzcG9uc2UgPVxuICAgICAgcmVzcG9uc2Uuc3RhdHVzICE9PSAwXG4gICAgICAgID8gcmVzcG9uc2UuZXJyb3JcbiAgICAgICAgOiB7IGNvZGU6IDAsIG1lc3NhZ2U6IHRoaXMubGl0ZXJhbHMuc2VydmVyTm90UmVzcG9uc2UsIGRldGFpbGVkTWVzc2FnZTogcmVzcG9uc2UubWVzc2FnZSB9O1xuXG4gICAgY29uc3QgaGFzTm9FcnJvclBhcmFtID0gdGhpcy5oYXNOb0Vycm9yUGFyYW0ocmVxdWVzdCk7XG4gICAgY29uc3QgaGFzTm9NZXNzYWdlUGFyYW0gPSB0aGlzLmhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3QpO1xuICAgIGNvbnN0IGVycm9yUmVzcG9uc2VWYWxpZFR5cGVzID0gdGhpcy5ub3RpZmljYXRpb25UeXBlcy5zbGljZSgxKTtcblxuICAgIGlmIChlcnJvclJlc3BvbnNlICYmIGVycm9yUmVzcG9uc2UubWVzc2FnZSAmJiAhaGFzTm9FcnJvclBhcmFtICYmICFoYXNOb01lc3NhZ2VQYXJhbSkge1xuICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcbiAgICAgICAgLi4uZXJyb3JSZXNwb25zZSxcbiAgICAgICAgdHlwZTogZXJyb3JSZXNwb25zZVZhbGlkVHlwZXMuaW5jbHVkZXMoZXJyb3JSZXNwb25zZS50eXBlKSA/IGVycm9yUmVzcG9uc2UudHlwZSA6ICdlcnJvcidcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2xvbmVSZXF1ZXN0V2l0aG91dFBhcmFtZXRlcnMocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IEh0dHBSZXF1ZXN0PGFueT4ge1xuICAgIGNvbnN0IGhlYWRlcnMgPSByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKE5PX0VSUk9SX0hFQURFUl9QQVJBTSkuZGVsZXRlKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiByZXF1ZXN0LmNsb25lKHsgaGVhZGVycyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkge1xuICAgIGNvbnN0IGRldGFpbHMgPSByZXNwb25zZU1lc3NhZ2UuZGV0YWlscyA/IFtyZXNwb25zZU1lc3NhZ2UsIC4uLnJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzXSA6IFtyZXNwb25zZU1lc3NhZ2VdO1xuXG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudEluamVjdG9yLmNyZWF0ZUNvbXBvbmVudEluQXBwbGljYXRpb24oXG4gICAgICBQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudFxuICAgICk7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2UuZGV0YWlsID0gZGV0YWlscztcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5jbG9zZWQuc3Vic2NyaWJlKCgpID0+IHRoaXMuZGVzdHJveU1vZGFsKCkpO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLm9wZW4oKTtcbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveU1vZGFsKCkge1xuICAgIGlmICh0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCkge1xuICAgICAgdGhpcy5jb21wb25lbnRJbmplY3Rvci5kZXN0cm95Q29tcG9uZW50SW5BcHBsaWNhdGlvbih0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCk7XG4gICAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhc01lc3NhZ2UocmVzcG9uc2VNZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkge1xuICAgIGNvbnN0IGhhc01lc3NhZ2VQcm9wZXJ0aWVzID0gcmVzcG9uc2VNZXNzYWdlLm1lc3NhZ2U7XG5cbiAgICByZXR1cm4gcmVzcG9uc2VNZXNzYWdlICYmIGhhc01lc3NhZ2VQcm9wZXJ0aWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNOb0Vycm9yUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vRXJyb3JQYXJhbSA9IHJlcXVlc3QgJiYgcmVxdWVzdC5oZWFkZXJzLmdldChOT19FUlJPUl9IRUFERVJfUEFSQU0pO1xuXG4gICAgcmV0dXJuIG5vRXJyb3JQYXJhbSAmJiBub0Vycm9yUGFyYW0udG9TdHJpbmcoKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gIH1cblxuICBwcml2YXRlIGhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICBjb25zdCBub01lc3NhZ2VQYXJhbSA9IHJlcXVlc3QgJiYgcmVxdWVzdC5oZWFkZXJzLmdldChOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gbm9NZXNzYWdlUGFyYW0gJiYgbm9NZXNzYWdlUGFyYW0udG9TdHJpbmcoKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gIH1cblxuICBwcml2YXRlIGhhc1BhcmFtZXRlcnMocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnMuaGFzKE5PX0VSUk9SX0hFQURFUl9QQVJBTSkgfHwgcmVxdWVzdC5oZWFkZXJzLmhhcyhOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XG4gIH1cblxuICBwcml2YXRlIHNob3dOb3RpZmljYXRpb24ocmVzcG9uc2U6IGFueSkge1xuICAgIGlmICghdGhpcy5oYXNNZXNzYWdlKHJlc3BvbnNlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHR5cGVOb3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvblR5cGVzLmluY2x1ZGVzKHJlc3BvbnNlLnR5cGUpID8gcmVzcG9uc2UudHlwZSA6ICdpbmZvcm1hdGlvbic7XG5cbiAgICBjb25zdCBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlKTtcblxuICAgIHRoaXMubm90aWZpY2F0aW9uW3R5cGVOb3RpZmljYXRpb25dKHtcbiAgICAgIG1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2UsXG4gICAgICBhY3Rpb25MYWJlbDogbm90aWZpY2F0aW9uQWN0aW9uLmxhYmVsLFxuICAgICAgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24uYWN0aW9uXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlRGV0YWlsTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBhbnkpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCkge1xuICAgICAgICB0aGlzLmNyZWF0ZU1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVOb3RpZmljYXRpb25BY3Rpb24ocmVzcG9uc2VNZXNzYWdlOiBhbnkpIHtcbiAgICBsZXQgbm90aWZpY2F0aW9uQWN0aW9uO1xuICAgIGxldCBub3RpZmljYXRpb25MYWJlbDtcblxuICAgIGlmIChyZXNwb25zZU1lc3NhZ2UuaGVscFVybCAmJiAhKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpKSB7XG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9IHRoaXMubGl0ZXJhbHMuaGVscDtcbiAgICAgIG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24ocmVzcG9uc2VNZXNzYWdlLmhlbHBVcmwpO1xuICAgIH0gZWxzZSBpZiAocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykge1xuICAgICAgbm90aWZpY2F0aW9uTGFiZWwgPSB0aGlzLmxpdGVyYWxzLmRldGFpbHM7XG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlRGV0YWlsTW9kYWwocmVzcG9uc2VNZXNzYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuIHsgbGFiZWw6IG5vdGlmaWNhdGlvbkxhYmVsLCBhY3Rpb246IG5vdGlmaWNhdGlvbkFjdGlvbiB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZVVybEhlbHBGdW5jdGlvbihoZWxwVXJsOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgd2luZG93Lm9wZW4oaGVscFVybCwgJ19ibGFuaycpO1xuICAgIH07XG4gIH1cbn1cbiJdfQ==