import { DOCUMENT } from '@angular/common';
import { Inject, Injectable } from '@angular/core';
import { PoThemeTypeEnum } from './enum/po-theme-type.enum';
import { poThemeDefault } from './helpers/po-theme-poui.constant';
import * as i0 from "@angular/core";
/**
 * @description
 *
 * O `PoThemeService` possibilita a personalização das cores do tema padrão do `PO-UI`, permitindo a alteração dos valores das variáveis de estilo usadas no CSS padrão.
 *
 * > Para saber mais sobre como customizar as cores do tema padrão verifique o item [Customizando cores do tema padrão](https://po-ui.io/guides/colors-customization) na aba `Guias`.
 *
 * > Obs.: Não está documentado aqui e não indicamos a customização das cores de 'feedback' por motivos de acessibilidade e usabilidade.
 */
export class PoThemeService {
    window;
    document;
    renderer;
    theme = poThemeDefault;
    constructor(window, document, rendererFactory) {
        this.window = window;
        this.document = document;
        this.renderer = rendererFactory.createRenderer(null, null);
    }
    /**
     * Define o tema a ser aplicado no componente, de acordo com o tipo de tema especificado.
     *
     * Este método define o tema a ser aplicado no componente com base no objeto `theme` fornecido e no tipo de tema especificado.
     * Ele atualiza as propriedades do componente para refletir o tema selecionado, como cores, estilos e comportamentos.
     *
     * @param {PoTheme} theme - Objeto contendo as definições de tema a serem aplicadas no componente.
     * @param {PoThemeTypeEnum} [themeType=PoThemeTypeEnum.light] - (Opcional) Tipo de tema a ser aplicado, podendo ser 'light' (claro) ou 'dark' (escuro). Por padrão, o tema claro é aplicado.
     */
    setTheme(theme, themeType = PoThemeTypeEnum.light) {
        // Change theme name, remove special characteres and number, replace space with dash
        theme.name = theme.name
            .toLowerCase()
            .replace(/[^a-zA-Z ]/g, '')
            .replace(/\s+/g, '-');
        theme.active = themeType;
        const _themeType = theme.type[PoThemeTypeEnum[themeType]];
        if (!_themeType) {
            return;
        }
        const colorStyles = _themeType.color ? this.generateThemeStyles(_themeType.color) : '';
        const perComponentStyles = _themeType.perComponent ? this.generatePerComponentStyles(_themeType.perComponent) : '';
        const onRootStyles = _themeType.onRoot ? this.generateAdditionalStyles(_themeType.onRoot) : '';
        const additionalStyles = this.generateAdditionalStyles(_themeType);
        const combinedStyles = `
      .${theme.name}-${PoThemeTypeEnum[themeType]}:root {
        ${colorStyles}
        ${perComponentStyles}
        ${onRootStyles}
        ${additionalStyles}
      }`;
        this.applyThemeStyles(combinedStyles);
        this.changeThemeType(theme);
    }
    /**
     * @docsPrivate
     *
     * Gera estilos adicionais com base nos tokens de tema fornecidos, excluindo os tokens de cor.
     * @param theme Os tokens de tema contendo os estilos adicionais a serem gerados.
     * @returns Uma string contendo os estilos adicionais formatados.
     */
    generateAdditionalStyles(theme) {
        return Object.entries(theme)
            .filter(([key]) => !['color', 'perComponent', 'onRoot'].includes(key))
            .map(([key, value]) => `${key}: ${value};`)
            .join(' ');
    }
    /**
     * @docsPrivate
     *
     * Aplica os estilos de tema ao documento.
     * @param styleCss Os estilos CSS a serem aplicados.
     */
    applyThemeStyles(styleCss) {
        const styleElement = this.createStyleElement(styleCss);
        const existingStyleElement = document.head.querySelector('#pouiTheme');
        if (existingStyleElement) {
            this.renderer.removeChild(document.head, existingStyleElement);
        }
        this.renderer.appendChild(document.head, styleElement);
    }
    changeThemeType(theme) {
        this.cleanThemeActive();
        this.setThemeActive(theme);
        document.getElementsByTagName('html')[0].classList.add(...[`${theme.name}-${PoThemeTypeEnum[theme.active]}`]);
    }
    /**
     * Persiste e define o tema do aplicativo com base nos dados armazenados.
     *
     * Este método recupera os dados do tema armazenados e os aplica ao aplicativo.
     *
     * @returns {PoTheme} Recupera o tema armazenado.
     */
    persistThemeActive() {
        const _theme = this.getThemeActive();
        this.setTheme(_theme, _theme.active);
        return _theme;
    }
    /**
     * Altera o tipo do tema armazenado e aplica os novos estilos ao documento.
     *
     * Este método altera o tipo do tema armazenado ativo (light/dark)
     *
     * @param {PoThemeTypeEnum} themeType O tipo de tema a ser aplicado, light ou dark.
     */
    changeCurrentThemeType(type) {
        const _theme = this.getThemeActive();
        _theme.active = type;
        this.changeThemeType(_theme);
    }
    /**
     * Método remove o tema armazenado e limpa todos os estilos de tema
     * aplicados ao documento.
     */
    cleanThemeActive() {
        const _theme = this.getThemeActive();
        document.getElementsByTagName('html')[0].classList.remove(`${_theme.name}-${PoThemeTypeEnum[_theme.active]}`);
        localStorage.removeItem('totvs-theme');
    }
    /**
     * @docsPrivate
     *
     * Este método define um dados do tema e o armazena.
     * @param theme Os tokens de tema contendo os estilos adicionais a serem gerados.
     */
    setThemeActive(theme) {
        if (theme) {
            localStorage.setItem('totvs-theme', JSON.stringify(theme));
            this.theme = theme;
        }
    }
    /**
     * Retorna o tema ativo como um observable.
     * @returns {PoTheme} Tema ativo.
     */
    getThemeActive() {
        try {
            const themeData = JSON.parse(localStorage.getItem('totvs-theme'));
            if (themeData && JSON.stringify(themeData) !== JSON.stringify(this.theme)) {
                this.theme = themeData;
            }
        }
        catch (error) {
            console.error('Erro ao obter o tema do armazenamento local:', error);
        }
        return this.theme;
    }
    /**
     * @docsPrivate
     *
     * Gera estilos CSS com base nos tokens de cores fornecidos.
     * @param themeColor Os tokens de cor a serem usados para gerar os estilos.
     * @returns Uma string contendo os estilos CSS gerados.
     */
    createStyleElement(css) {
        const styleElement = this.renderer.createElement('style');
        styleElement.id = 'pouiTheme';
        this.renderer.appendChild(styleElement, this.renderer.createText(css));
        return styleElement;
    }
    /**
     * @docsPrivate
     *
     * Gera estilos CSS com base nos tokens de cores fornecidos.
     * @param themeColor Os tokens de cor a serem usados para gerar os estilos.
     * @returns Uma string contendo os estilos CSS gerados.
     */
    generateThemeStyles(themeColor) {
        const selectBgIconStyle = this.getSelectBgIconsStyle(themeColor);
        return [
            Object.entries(themeColor)
                .flatMap(([type, values]) => Object.entries(values).flatMap(([tonality, tonalityValues]) => {
                if (type === 'action') {
                    return [`--color-${type}-${tonality}: ${tonalityValues};`];
                }
                else {
                    return Object.entries(tonalityValues).map(([level, colorValue]) => `--color-${type}-${tonality}-${level}: ${colorValue};`);
                }
            }))
                .join(''),
            selectBgIconStyle
        ].join('');
    }
    /**
     * @docsPrivate
     *
     * Gera estilos CSS com base nos tokens per Component fornecidos.
     * @param themePerComponent Os tokens de cor a serem usados para gerar os estilos.
     * @returns Uma string contendo os estilos CSS gerados.
     */
    generatePerComponentStyles(themePerComponent) {
        return Object.entries(themePerComponent)
            .flatMap(([type, values]) => Object.entries(values).flatMap(([level, colorValue]) => [`${type} {${level}: ${colorValue};};`]))
            .join('');
    }
    /**
     * Define o tema atual como o tema "PoUI Padrão".
     *
     * @param {PoThemeTypeEnum} type O tipo de Tema a ser aplicado, light / dark.
     */
    setDefaultTheme(type) {
        this.setTheme(poThemeDefault, type);
    }
    /**
     * @docsPrivate
     *
     * Retorna o estilo CSS para o fundo dos ícones do componente po-select, com base nas cores do tema.
     *
     * @param {PoThemeColor} themeColor - Objeto contendo as cores do tema.
     * @returns {string} - Estilo CSS para o fundo dos ícones do po-select.
     */
    getSelectBgIconsStyle(themeColor) {
        let selectBgIcon = '';
        if (themeColor?.brand?.['01']?.dark) {
            selectBgIcon += `po-select { --background-image: url(${this.getSelectBgIcon(themeColor.brand['01'].dark)}); };`;
        }
        if (themeColor?.feedback?.negative?.base)
            selectBgIcon += `po-select.ng-dirty.ng-invalid select { --background-image: url(${this.getSelectBgIcon(themeColor.feedback.negative.base)}); };`;
        if (themeColor?.neutral?.light?.['30'])
            selectBgIcon += `select:disabled { --background-image: url(${this.getSelectBgIcon(themeColor.neutral.light['30'])}); };`;
        return selectBgIcon;
    }
    /**
     * @docsPrivate
     *
     * Retorna a imagem SVG utilizada como fundo do po-select.
     *
     * @param {string} color Cor da Imagem - Utilizada no atributo 'fill'.
     * @returns {string} Imagem SVG utilizada no po-select.
     */
    getSelectBgIcon(color) {
        let svg = `"data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' `;
        svg = svg.concat(`xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' `);
        svg = svg.concat(`d='M18.707 8.29301C18.316 7.90201 17.684 7.90201 17.293 8.29301L12 13.586L6.70701 `);
        svg = svg.concat(`8.29301C6.31601 7.90201 5.68401 7.90201 5.29301 8.29301C4.90201 8.68401 4.90201 `);
        svg = svg.concat(`9.31601 5.29301 9.70701L11.293 15.707C11.488 15.902 11.744 16 12 16C12.256 16 12.512 `);
        svg = svg.concat(`15.902 12.707 15.707L18.707 9.70701C19.098 9.31601 19.098 8.68401 18.707 8.29301Z' `);
        svg = svg.concat(`fill='${color.replace('#', '%23')}'/%3E%3C/svg%3E%0A");`);
        return svg;
    }
    static ɵfac = function PoThemeService_Factory(t) { return new (t || PoThemeService)(i0.ɵɵinject('Window'), i0.ɵɵinject(DOCUMENT), i0.ɵɵinject(i0.RendererFactory2)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: PoThemeService, factory: PoThemeService.ɵfac, providedIn: 'root' });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoThemeService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], () => [{ type: Window, decorators: [{
                type: Inject,
                args: ['Window']
            }] }, { type: Document, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: i0.RendererFactory2 }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdGhlbWUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvc2VydmljZXMvcG8tdGhlbWUvcG8tdGhlbWUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQStCLE1BQU0sZUFBZSxDQUFDO0FBRWhGLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7O0FBS2xFOzs7Ozs7OztHQVFHO0FBSUgsTUFBTSxPQUFPLGNBQWM7SUFLRztJQUNBO0lBTHBCLFFBQVEsQ0FBWTtJQUNwQixLQUFLLEdBQVksY0FBYyxDQUFDO0lBRXhDLFlBQzRCLE1BQWMsRUFDZCxRQUFrQixFQUM1QyxlQUFpQztRQUZQLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRzVDLElBQUksQ0FBQyxRQUFRLEdBQUcsZUFBZSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsUUFBUSxDQUFDLEtBQWMsRUFBRSxZQUE2QixlQUFlLENBQUMsS0FBSztRQUN6RSxvRkFBb0Y7UUFDcEYsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSTthQUNwQixXQUFXLEVBQUU7YUFDYixPQUFPLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQzthQUMxQixPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3hCLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO1FBRXpCLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMs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RU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBvVGhlbWVUeXBlRW51bSB9IGZyb20gJy4vZW51bS9wby10aGVtZS10eXBlLmVudW0nO1xuaW1wb3J0IHsgcG9UaGVtZURlZmF1bHQgfSBmcm9tICcuL2hlbHBlcnMvcG8tdGhlbWUtcG91aS5jb25zdGFudCc7XG5pbXBvcnQgeyBQb1RoZW1lQ29sb3IgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tdGhlbWUtY29sb3IuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvVGhlbWVUb2tlbnMgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tdGhlbWUtdG9rZW5zLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb1RoZW1lIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLXRoZW1lLmludGVyZmFjZSc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyBgUG9UaGVtZVNlcnZpY2VgIHBvc3NpYmlsaXRhIGEgcGVyc29uYWxpemHDp8OjbyBkYXMgY29yZXMgZG8gdGVtYSBwYWRyw6NvIGRvIGBQTy1VSWAsIHBlcm1pdGluZG8gYSBhbHRlcmHDp8OjbyBkb3MgdmFsb3JlcyBkYXMgdmFyacOhdmVpcyBkZSBlc3RpbG8gdXNhZGFzIG5vIENTUyBwYWRyw6NvLlxuICpcbiAqID4gUGFyYSBzYWJlciBtYWlzIHNvYnJlIGNvbW8gY3VzdG9taXphciBhcyBjb3JlcyBkbyB0ZW1hIHBhZHLDo28gdmVyaWZpcXVlIG8gaXRlbSBbQ3VzdG9taXphbmRvIGNvcmVzIGRvIHRlbWEgcGFkcsOjb10oaHR0cHM6Ly9wby11aS5pby9ndWlkZXMvY29sb3JzLWN1c3RvbWl6YXRpb24pIG5hIGFiYSBgR3VpYXNgLlxuICpcbiAqID4gT2JzLjogTsOjbyBlc3TDoSBkb2N1bWVudGFkbyBhcXVpIGUgbsOjbyBpbmRpY2Ftb3MgYSBjdXN0b21pemHDp8OjbyBkYXMgY29yZXMgZGUgJ2ZlZWRiYWNrJyBwb3IgbW90aXZvcyBkZSBhY2Vzc2liaWxpZGFkZSBlIHVzYWJpbGlkYWRlLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBQb1RoZW1lU2VydmljZSB7XG4gIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMjtcbiAgcHJpdmF0ZSB0aGVtZTogUG9UaGVtZSA9IHBvVGhlbWVEZWZhdWx0O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoJ1dpbmRvdycpIHByaXZhdGUgd2luZG93OiBXaW5kb3csXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQsXG4gICAgcmVuZGVyZXJGYWN0b3J5OiBSZW5kZXJlckZhY3RvcnkyXG4gICkge1xuICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG4gIH1cblxuICAvKipcbiAgICogRGVmaW5lIG8gdGVtYSBhIHNlciBhcGxpY2FkbyBubyBjb21wb25lbnRlLCBkZSBhY29yZG8gY29tIG8gdGlwbyBkZSB0ZW1hIGVzcGVjaWZpY2Fkby5cbiAgICpcbiAgICogRXN0ZSBtw6l0b2RvIGRlZmluZSBvIHRlbWEgYSBzZXIgYXBsaWNhZG8gbm8gY29tcG9uZW50ZSBjb20gYmFzZSBubyBvYmpldG8gYHRoZW1lYCBmb3JuZWNpZG8gZSBubyB0aXBvIGRlIHRlbWEgZXNwZWNpZmljYWRvLlxuICAgKiBFbGUgYXR1YWxpemEgYXMgcHJvcHJpZWRhZGVzIGRvIGNvbXBvbmVudGUgcGFyYSByZWZsZXRpciBvIHRlbWEgc2VsZWNpb25hZG8sIGNvbW8gY29yZXMsIGVzdGlsb3MgZSBjb21wb3J0YW1lbnRvcy5cbiAgICpcbiAgICogQHBhcmFtIHtQb1RoZW1lfSB0aGVtZSAtIE9iamV0byBjb250ZW5kbyBhcyBkZWZpbmnDp8O1ZXMgZGUgdGVtYSBhIHNlcmVtIGFwbGljYWRhcyBubyBjb21wb25lbnRlLlxuICAgKiBAcGFyYW0ge1BvVGhlbWVUeXBlRW51bX0gW3RoZW1lVHlwZT1Qb1RoZW1lVHlwZUVudW0ubGlnaHRdIC0gKE9wY2lvbmFsKSBUaXBvIGRlIHRlbWEgYSBzZXIgYXBsaWNhZG8sIHBvZGVuZG8gc2VyICdsaWdodCcgKGNsYXJvKSBvdSAnZGFyaycgKGVzY3VybykuIFBvciBwYWRyw6NvLCBvIHRlbWEgY2xhcm8gw6kgYXBsaWNhZG8uXG4gICAqL1xuICBzZXRUaGVtZSh0aGVtZTogUG9UaGVtZSwgdGhlbWVUeXBlOiBQb1RoZW1lVHlwZUVudW0gPSBQb1RoZW1lVHlwZUVudW0ubGlnaHQpOiB2b2lkIHtcbiAgICAvLyBDaGFuZ2UgdGhlbWUgbmFtZSwgcmVtb3ZlIHNwZWNpYWwgY2hhcmFjdGVyZXMgYW5kIG51bWJlciwgcmVwbGFjZSBzcGFjZSB3aXRoIGRhc2hcbiAgICB0aGVtZS5uYW1lID0gdGhlbWUubmFtZVxuICAgICAgLnRvTG93ZXJDYXNlKClcbiAgICAgIC5yZXBsYWNlKC9bXmEtekEtWiBdL2csICcnKVxuICAgICAgLnJlcGxhY2UoL1xccysvZywgJy0nKTtcbiAgICB0aGVtZS5hY3RpdmUgPSB0aGVtZVR5cGU7XG5cbiAgICBjb25zdCBfdGhlbWVUeXBlID0gdGhlbWUudHlwZVtQb1RoZW1lVHlwZUVudW1bdGhlbWVUeXBlXV07XG4gICAgaWYgKCFfdGhlbWVUeXBlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY29sb3JTdHlsZXMgPSBfdGhlbWVUeXBlLmNvbG9yID8gdGhpcy5nZW5lcmF0ZVRoZW1lU3R5bGVzKF90aGVtZVR5cGUuY29sb3IpIDogJyc7XG4gICAgY29uc3QgcGVyQ29tcG9uZW50U3R5bGVzID0gX3RoZW1lVHlwZS5wZXJDb21wb25lbnQgPyB0aGlzLmdlbmVyYXRlUGVyQ29tcG9uZW50U3R5bGVzKF90aGVtZVR5cGUucGVyQ29tcG9uZW50KSA6ICcnO1xuICAgIGNvbnN0IG9uUm9vdFN0eWxlcyA9IF90aGVtZVR5cGUub25Sb290ID8gdGhpcy5nZW5lcmF0ZUFkZGl0aW9uYWxTdHlsZXMoX3RoZW1lVHlwZS5vblJvb3QpIDogJyc7XG4gICAgY29uc3QgYWRkaXRpb25hbFN0eWxlcyA9IHRoaXMuZ2VuZXJhdGVBZGRpdGlvbmFsU3R5bGVzKF90aGVtZVR5cGUpO1xuXG4gICAgY29uc3QgY29tYmluZWRTdHlsZXMgPSBgXG4gICAgICAuJHt0aGVtZS5uYW1lfS0ke1BvVGhlbWVUeXBlRW51bVt0aGVtZVR5cGVdfTpyb290IHtcbiAgICAgICAgJHtjb2xvclN0eWxlc31cbiAgICAgICAgJHtwZXJDb21wb25lbnRTdHlsZXN9XG4gICAgICAgICR7b25Sb290U3R5bGVzfVxuICAgICAgICAke2FkZGl0aW9uYWxTdHlsZXN9XG4gICAgICB9YDtcblxuICAgIHRoaXMuYXBwbHlUaGVtZVN0eWxlcyhjb21iaW5lZFN0eWxlcyk7XG4gICAgdGhpcy5jaGFuZ2VUaGVtZVR5cGUodGhlbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkb2NzUHJpdmF0ZVxuICAgKlxuICAgKiBHZXJhIGVzdGlsb3MgYWRpY2lvbmFpcyBjb20gYmFzZSBub3MgdG9rZW5zIGRlIHRlbWEgZm9ybmVjaWRvcywgZXhjbHVpbmRvIG9zIHRva2VucyBkZSBjb3IuXG4gICAqIEBwYXJhbSB0aGVtZSBPcyB0b2tlbnMgZGUgdGVtYSBjb250ZW5kbyBvcyBlc3RpbG9zIGFkaWNpb25haXMgYSBzZXJlbSBnZXJhZG9zLlxuICAgKiBAcmV0dXJucyBVbWEgc3RyaW5nIGNvbnRlbmRvIG9zIGVzdGlsb3MgYWRpY2lvbmFpcyBmb3JtYXRhZG9zLlxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUFkZGl0aW9uYWxTdHlsZXModGhlbWU6IFBvVGhlbWVUb2tlbnMpOiBzdHJpbmcge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyh0aGVtZSlcbiAgICAgIC5maWx0ZXIoKFtrZXldKSA9PiAhWydjb2xvcicsICdwZXJDb21wb25lbnQnLCAnb25Sb290J10uaW5jbHVkZXMoa2V5KSlcbiAgICAgIC5tYXAoKFtrZXksIHZhbHVlXSkgPT4gYCR7a2V5fTogJHt2YWx1ZX07YClcbiAgICAgIC5qb2luKCcgJyk7XG4gIH1cblxuICAvKipcbiAgICogQGRvY3NQcml2YXRlXG4gICAqXG4gICAqIEFwbGljYSBvcyBlc3RpbG9zIGRlIHRlbWEgYW8gZG9jdW1lbnRvLlxuICAgKiBAcGFyYW0gc3R5bGVDc3MgT3MgZXN0aWxvcyBDU1MgYSBzZXJlbSBhcGxpY2Fkb3MuXG4gICAqL1xuICBwcml2YXRlIGFwcGx5VGhlbWVTdHlsZXMoc3R5bGVDc3M6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHN0eWxlRWxlbWVudCA9IHRoaXMuY3JlYXRlU3R5bGVFbGVtZW50KHN0eWxlQ3NzKTtcbiAgICBjb25zdCBleGlzdGluZ1N0eWxlRWxlbWVudCA9IGRvY3VtZW50LmhlYWQucXVlcnlTZWxlY3RvcignI3BvdWlUaGVtZScpO1xuXG4gICAgaWYgKGV4aXN0aW5nU3R5bGVFbGVtZW50KSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKGRvY3VtZW50LmhlYWQsIGV4aXN0aW5nU3R5bGVFbGVtZW50KTtcbiAgICB9XG5cbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmhlYWQsIHN0eWxlRWxlbWVudCk7XG4gIH1cblxuICBwcml2YXRlIGNoYW5nZVRoZW1lVHlwZSh0aGVtZTogUG9UaGVtZSkge1xuICAgIHRoaXMuY2xlYW5UaGVtZUFjdGl2ZSgpO1xuICAgIHRoaXMuc2V0VGhlbWVBY3RpdmUodGhlbWUpO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdodG1sJylbMF0uY2xhc3NMaXN0LmFkZCguLi5bYCR7dGhlbWUubmFtZX0tJHtQb1RoZW1lVHlwZUVudW1bdGhlbWUuYWN0aXZlXX1gXSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyc2lzdGUgZSBkZWZpbmUgbyB0ZW1hIGRvIGFwbGljYXRpdm8gY29tIGJhc2Ugbm9zIGRhZG9zIGFybWF6ZW5hZG9zLlxuICAgKlxuICAgKiBFc3RlIG3DqXRvZG8gcmVjdXBlcmEgb3MgZGFkb3MgZG8gdGVtYSBhcm1hemVuYWRvcyBlIG9zIGFwbGljYSBhbyBhcGxpY2F0aXZvLlxuICAgKlxuICAgKiBAcmV0dXJucyB7UG9UaGVtZX0gUmVjdXBlcmEgbyB0ZW1hIGFybWF6ZW5hZG8uXG4gICAqL1xuICBwZXJzaXN0VGhlbWVBY3RpdmUoKSB7XG4gICAgY29uc3QgX3RoZW1lID0gdGhpcy5nZXRUaGVtZUFjdGl2ZSgpO1xuICAgIHRoaXMuc2V0VGhlbWUoX3RoZW1lLCBfdGhlbWUuYWN0aXZlKTtcbiAgICByZXR1cm4gX3RoZW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsdGVyYSBvIHRpcG8gZG8gdGVtYSBhcm1hemVuYWRvIGUgYXBsaWNhIG9zIG5vdm9zIGVzdGlsb3MgYW8gZG9jdW1lbnRvLlxuICAgKlxuICAgKiBFc3RlIG3DqXRvZG8gYWx0ZXJhIG8gdGlwbyBkbyB0ZW1hIGFybWF6ZW5hZG8gYXRpdm8gKGxpZ2h0L2RhcmspXG4gICAqXG4gICAqIEBwYXJhbSB7UG9UaGVtZVR5cGVFbnVtfSB0aGVtZVR5cGUgTyB0aXBvIGRlIHRlbWEgYSBzZXIgYXBsaWNhZG8sIGxpZ2h0IG91IGRhcmsuXG4gICAqL1xuICBjaGFuZ2VDdXJyZW50VGhlbWVUeXBlKHR5cGU6IFBvVGhlbWVUeXBlRW51bSk6IHZvaWQge1xuICAgIGNvbnN0IF90aGVtZSA9IHRoaXMuZ2V0VGhlbWVBY3RpdmUoKTtcbiAgICBfdGhlbWUuYWN0aXZlID0gdHlwZTtcbiAgICB0aGlzLmNoYW5nZVRoZW1lVHlwZShfdGhlbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIE3DqXRvZG8gcmVtb3ZlIG8gdGVtYSBhcm1hemVuYWRvIGUgbGltcGEgdG9kb3Mgb3MgZXN0aWxvcyBkZSB0ZW1hXG4gICAqIGFwbGljYWRvcyBhbyBkb2N1bWVudG8uXG4gICAqL1xuICBjbGVhblRoZW1lQWN0aXZlKCk6IHZvaWQge1xuICAgIGNvbnN0IF90aGVtZSA9IHRoaXMuZ2V0VGhlbWVBY3RpdmUoKTtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaHRtbCcpWzBdLmNsYXNzTGlzdC5yZW1vdmUoYCR7X3RoZW1lLm5hbWV9LSR7UG9UaGVtZVR5cGVFbnVtW190aGVtZS5hY3RpdmVdfWApO1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCd0b3R2cy10aGVtZScpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkb2NzUHJpdmF0ZVxuICAgKlxuICAgKiBFc3RlIG3DqXRvZG8gZGVmaW5lIHVtIGRhZG9zIGRvIHRlbWEgZSBvIGFybWF6ZW5hLlxuICAgKiBAcGFyYW0gdGhlbWUgT3MgdG9rZW5zIGRlIHRlbWEgY29udGVuZG8gb3MgZXN0aWxvcyBhZGljaW9uYWlzIGEgc2VyZW0gZ2VyYWRvcy5cbiAgICovXG4gIHByaXZhdGUgc2V0VGhlbWVBY3RpdmUodGhlbWU6IFBvVGhlbWUpOiB2b2lkIHtcbiAgICBpZiAodGhlbWUpIHtcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd0b3R2cy10aGVtZScsIEpTT04uc3RyaW5naWZ5KHRoZW1lKSk7XG4gICAgICB0aGlzLnRoZW1lID0gdGhlbWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldG9ybmEgbyB0ZW1hIGF0aXZvIGNvbW8gdW0gb2JzZXJ2YWJsZS5cbiAgICogQHJldHVybnMge1BvVGhlbWV9IFRlbWEgYXRpdm8uXG4gICAqL1xuICBnZXRUaGVtZUFjdGl2ZSgpOiBQb1RoZW1lIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdGhlbWVEYXRhID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndG90dnMtdGhlbWUnKSk7XG4gICAgICBpZiAodGhlbWVEYXRhICYmIEpTT04uc3RyaW5naWZ5KHRoZW1lRGF0YSkgIT09IEpTT04uc3RyaW5naWZ5KHRoaXMudGhlbWUpKSB7XG4gICAgICAgIHRoaXMudGhlbWUgPSB0aGVtZURhdGE7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm8gYW8gb2J0ZXIgbyB0ZW1hIGRvIGFybWF6ZW5hbWVudG8gbG9jYWw6JywgZXJyb3IpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy50aGVtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZG9jc1ByaXZhdGVcbiAgICpcbiAgICogR2VyYSBlc3RpbG9zIENTUyBjb20gYmFzZSBub3MgdG9rZW5zIGRlIGNvcmVzIGZvcm5lY2lkb3MuXG4gICAqIEBwYXJhbSB0aGVtZUNvbG9yIE9zIHRva2VucyBkZSBjb3IgYSBzZXJlbSB1c2Fkb3MgcGFyYSBnZXJhciBvcyBlc3RpbG9zLlxuICAgKiBAcmV0dXJucyBVbWEgc3RyaW5nIGNvbnRlbmRvIG9zIGVzdGlsb3MgQ1NTIGdlcmFkb3MuXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZVN0eWxlRWxlbWVudChjc3M6IHN0cmluZyk6IEhUTUxTdHlsZUVsZW1lbnQge1xuICAgIGNvbnN0IHN0eWxlRWxlbWVudCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICBzdHlsZUVsZW1lbnQuaWQgPSAncG91aVRoZW1lJztcbiAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHN0eWxlRWxlbWVudCwgdGhpcy5yZW5kZXJlci5jcmVhdGVUZXh0KGNzcykpO1xuICAgIHJldHVybiBzdHlsZUVsZW1lbnQ7XG4gIH1cblxuICAvKipcbiAgICogQGRvY3NQcml2YXRlXG4gICAqXG4gICAqIEdlcmEgZXN0aWxvcyBDU1MgY29tIGJhc2Ugbm9zIHRva2VucyBkZSBjb3JlcyBmb3JuZWNpZG9zLlxuICAgKiBAcGFyYW0gdGhlbWVDb2xvciBPcyB0b2tlbnMgZGUgY29yIGEgc2VyZW0gdXNhZG9zIHBhcmEgZ2VyYXIgb3MgZXN0aWxvcy5cbiAgICogQHJldHVybnMgVW1hIHN0cmluZyBjb250ZW5kbyBvcyBlc3RpbG9zIENTUyBnZXJhZG9zLlxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVRoZW1lU3R5bGVzKHRoZW1lQ29sb3I6IFBvVGhlbWVDb2xvcik6IHN0cmluZyB7XG4gICAgY29uc3Qgc2VsZWN0QmdJY29uU3R5bGUgPSB0aGlzLmdldFNlbGVjdEJnSWNvbnNTdHlsZSh0aGVtZUNvbG9yKTtcblxuICAgIHJldHVybiBbXG4gICAgICBPYmplY3QuZW50cmllcyh0aGVtZUNvbG9yKVxuICAgICAgICAuZmxhdE1hcCgoW3R5cGUsIHZhbHVlc10pID0+XG4gICAgICAgICAgT2JqZWN0LmVudHJpZXModmFsdWVzKS5mbGF0TWFwKChbdG9uYWxpdHksIHRvbmFsaXR5VmFsdWVzXSkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdhY3Rpb24nKSB7XG4gICAgICAgICAgICAgIHJldHVybiBbYC0tY29sb3ItJHt0eXBlfS0ke3RvbmFsaXR5fTogJHt0b25hbGl0eVZhbHVlc307YF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModG9uYWxpdHlWYWx1ZXMpLm1hcChcbiAgICAgICAgICAgICAgICAoW2xldmVsLCBjb2xvclZhbHVlXSkgPT4gYC0tY29sb3ItJHt0eXBlfS0ke3RvbmFsaXR5fS0ke2xldmVsfTogJHtjb2xvclZhbHVlfTtgXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICAuam9pbignJyksXG4gICAgICBzZWxlY3RCZ0ljb25TdHlsZVxuICAgIF0uam9pbignJyk7XG4gIH1cblxuICAvKipcbiAgICogQGRvY3NQcml2YXRlXG4gICAqXG4gICAqIEdlcmEgZXN0aWxvcyBDU1MgY29tIGJhc2Ugbm9zIHRva2VucyBwZXIgQ29tcG9uZW50IGZvcm5lY2lkb3MuXG4gICAqIEBwYXJhbSB0aGVtZVBlckNvbXBvbmVudCBPcyB0b2tlbnMgZGUgY29yIGEgc2VyZW0gdXNhZG9zIHBhcmEgZ2VyYXIgb3MgZXN0aWxvcy5cbiAgICogQHJldHVybnMgVW1hIHN0cmluZyBjb250ZW5kbyBvcyBlc3RpbG9zIENTUyBnZXJhZG9zLlxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVBlckNvbXBvbmVudFN0eWxlcyh0aGVtZVBlckNvbXBvbmVudDogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXModGhlbWVQZXJDb21wb25lbnQpXG4gICAgICAuZmxhdE1hcCgoW3R5cGUsIHZhbHVlc10pID0+XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHZhbHVlcykuZmxhdE1hcCgoW2xldmVsLCBjb2xvclZhbHVlXSkgPT4gW2Ake3R5cGV9IHske2xldmVsfTogJHtjb2xvclZhbHVlfTt9O2BdKVxuICAgICAgKVxuICAgICAgLmpvaW4oJycpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlZmluZSBvIHRlbWEgYXR1YWwgY29tbyBvIHRlbWEgXCJQb1VJIFBhZHLDo29cIi5cbiAgICpcbiAgICogQHBhcmFtIHtQb1RoZW1lVHlwZUVudW19IHR5cGUgTyB0aXBvIGRlIFRlbWEgYSBzZXIgYXBsaWNhZG8sIGxpZ2h0IC8gZGFyay5cbiAgICovXG4gIHNldERlZmF1bHRUaGVtZSh0eXBlOiBQb1RoZW1lVHlwZUVudW0pOiB2b2lkIHtcbiAgICB0aGlzLnNldFRoZW1lKHBvVGhlbWVEZWZhdWx0LCB0eXBlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZG9jc1ByaXZhdGVcbiAgICpcbiAgICogUmV0b3JuYSBvIGVzdGlsbyBDU1MgcGFyYSBvIGZ1bmRvIGRvcyDDrWNvbmVzIGRvIGNvbXBvbmVudGUgcG8tc2VsZWN0LCBjb20gYmFzZSBuYXMgY29yZXMgZG8gdGVtYS5cbiAgICpcbiAgICogQHBhcmFtIHtQb1RoZW1lQ29sb3J9IHRoZW1lQ29sb3IgLSBPYmpldG8gY29udGVuZG8gYXMgY29yZXMgZG8gdGVtYS5cbiAgICogQHJldHVybnMge3N0cmluZ30gLSBFc3RpbG8gQ1NTIHBhcmEgbyBmdW5kbyBkb3Mgw61jb25lcyBkbyBwby1zZWxlY3QuXG4gICAqL1xuICBwcml2YXRlIGdldFNlbGVjdEJnSWNvbnNTdHlsZSh0aGVtZUNvbG9yOiBQb1RoZW1lQ29sb3IpOiBzdHJpbmcge1xuICAgIGxldCBzZWxlY3RCZ0ljb24gPSAnJztcblxuICAgIGlmICh0aGVtZUNvbG9yPy5icmFuZD8uWycwMSddPy5kYXJrKSB7XG4gICAgICBzZWxlY3RCZ0ljb24gKz0gYHBvLXNlbGVjdCB7IC0tYmFja2dyb3VuZC1pbWFnZTogdXJsKCR7dGhpcy5nZXRTZWxlY3RCZ0ljb24odGhlbWVDb2xvci5icmFuZFsnMDEnXS5kYXJrKX0pOyB9O2A7XG4gICAgfVxuICAgIGlmICh0aGVtZUNvbG9yPy5mZWVkYmFjaz8ubmVnYXRpdmU/LmJhc2UpXG4gICAgICBzZWxlY3RCZ0ljb24gKz0gYHBvLXNlbGVjdC5uZy1kaXJ0eS5uZy1pbnZhbGlkIHNlbGVjdCB7IC0tYmFja2dyb3VuZC1pbWFnZTogdXJsKCR7dGhpcy5nZXRTZWxlY3RCZ0ljb24odGhlbWVDb2xvci5mZWVkYmFjay5uZWdhdGl2ZS5iYXNlKX0pOyB9O2A7XG5cbiAgICBpZiAodGhlbWVDb2xvcj8ubmV1dHJhbD8ubGlnaHQ/LlsnMzAnXSlcbiAgICAgIHNlbGVjdEJnSWNvbiArPSBgc2VsZWN0OmRpc2FibGVkIHsgLS1iYWNrZ3JvdW5kLWltYWdlOiB1cmwoJHt0aGlzLmdldFNlbGVjdEJnSWNvbih0aGVtZUNvbG9yLm5ldXRyYWwubGlnaHRbJzMwJ10pfSk7IH07YDtcblxuICAgIHJldHVybiBzZWxlY3RCZ0ljb247XG4gIH1cblxuICAvKipcbiAgICogQGRvY3NQcml2YXRlXG4gICAqXG4gICAqIFJldG9ybmEgYSBpbWFnZW0gU1ZHIHV0aWxpemFkYSBjb21vIGZ1bmRvIGRvIHBvLXNlbGVjdC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIENvciBkYSBJbWFnZW0gLSBVdGlsaXphZGEgbm8gYXRyaWJ1dG8gJ2ZpbGwnLlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSBJbWFnZW0gU1ZHIHV0aWxpemFkYSBubyBwby1zZWxlY3QuXG4gICAqL1xuICBwcml2YXRlIGdldFNlbGVjdEJnSWNvbihjb2xvcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgc3ZnOiBzdHJpbmcgPSBgXCJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHdpZHRoPScyNCcgaGVpZ2h0PScyNCcgdmlld0JveD0nMCAwIDI0IDI0JyBmaWxsPSdub25lJyBgO1xuXG4gICAgc3ZnID0gc3ZnLmNvbmNhdChgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUzRSUzQ3BhdGggZmlsbC1ydWxlPSdldmVub2RkJyBjbGlwLXJ1bGU9J2V2ZW5vZGQnIGApO1xuICAgIHN2ZyA9IHN2Zy5jb25jYXQoYGQ9J00xOC43MDcgOC4yOTMwMUMxOC4zMTYgNy45MDIwMSAxNy42ODQgNy45MDIwMSAxNy4yOTMgOC4yOTMwMUwxMiAxMy41ODZMNi43MDcwMSBgKTtcbiAgICBzdmcgPSBzdmcuY29uY2F0KGA4LjI5MzAxQzYuMzE2MDEgNy45MDIwMSA1LjY4NDAxIDcuOTAyMDEgNS4yOTMwMSA4LjI5MzAxQzQuOTAyMDEgOC42ODQwMSA0LjkwMjAxIGApO1xuICAgIHN2ZyA9IHN2Zy5jb25jYXQoYDkuMzE2MDEgNS4yOTMwMSA5LjcwNzAxTDExLjI5MyAxNS43MDdDMTEuNDg4IDE1LjkwMiAxMS43NDQgMTYgMTIgMTZDMTIuMjU2IDE2IDEyLjUxMiBgKTtcbiAgICBzdmcgPSBzdmcuY29uY2F0KGAxNS45MDIgMTIuNzA3IDE1LjcwN0wxOC43MDcgOS43MDcwMUMxOS4wOTggOS4zMTYwMSAxOS4wOTggOC42ODQwMSAxOC43MDcgOC4yOTMwMVonIGApO1xuICAgIHN2ZyA9IHN2Zy5jb25jYXQoYGZpbGw9JyR7Y29sb3IucmVwbGFjZSgnIycsICclMjMnKX0nLyUzRSUzQy9zdmclM0UlMEFcIik7YCk7XG5cbiAgICByZXR1cm4gc3ZnO1xuICB9XG59XG4iXX0=