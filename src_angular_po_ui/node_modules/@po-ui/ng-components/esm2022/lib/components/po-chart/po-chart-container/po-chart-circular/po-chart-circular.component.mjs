import { Directive, EventEmitter, Input, Output, ViewChildren } from '@angular/core';
import { PoChartStartAngle, PoChartCompleteCircle, PoChartAngleStepInterval } from '../../helpers/po-chart-default-values.constant';
import * as i0 from "@angular/core";
const _c0 = ["svgPaths"];
const _c1 = ["svgLabels"];
export class PoChartCircularComponent {
    ngZone;
    changeDetector;
    containerSize;
    circularClick = new EventEmitter();
    circularHover = new EventEmitter();
    svgPaths;
    svgLabels;
    canDisplayLabels = false;
    seriesLabels = [];
    seriesList;
    showLabels = false;
    innerRadius;
    totalValue;
    _options;
    _series;
    animate;
    set options(value) {
        if (!isNaN(value?.innerRadius)) {
            this._options = value;
            this.innerRadius = Math.min(Math.max(this._options.innerRadius, 0), 100);
        }
    }
    get options() {
        return this._options;
    }
    set series(value) {
        this._series = value;
        this.animate = true;
    }
    get series() {
        return this._series;
    }
    constructor(ngZone, changeDetector) {
        this.ngZone = ngZone;
        this.changeDetector = changeDetector;
    }
    onSerieClick(selectedItem) {
        this.circularClick.emit(selectedItem);
    }
    onSerieHover(selectedItem) {
        this.circularHover.emit(selectedItem);
    }
    calculateAngle(data, totalValue) {
        return (data / totalValue) * (Math.PI * 2);
    }
    drawSeries(series = [], height) {
        this.seriesList = [];
        this.showLabels = false;
        this.totalValue = this.calculateTotalValue(series);
        if (this.totalValue && this.totalValue > 0) {
            this.seriesList = this.validateSeries(series);
            this.changeDetector.detectChanges();
            if (this.seriesList.length && this.svgPaths) {
                this.initDrawPaths(this.seriesList, this.totalValue, height);
            }
        }
    }
    calculateTotalValue(series) {
        return series.reduce((previousValue, serie) => {
            const data = serie.data ? serie.data : serie.value;
            return previousValue + (data > 0 ? data : 0);
        }, 0);
    }
    calculateSerieCoordinates(series, totalValue, height) {
        let startRadianAngle;
        let endRadianAngle = PoChartStartAngle;
        series.forEach((serie, index) => {
            startRadianAngle = endRadianAngle;
            endRadianAngle = startRadianAngle + this.calculateAngle(serie.data, totalValue) - PoChartCompleteCircle;
            const coordinates = this.calculateCoordinates(height, startRadianAngle, endRadianAngle);
            this.svgPaths.toArray()[index].applyCoordinates(coordinates);
            this.showLabels = this.canDisplayLabels;
        });
    }
    calculateCoordinatesWithAnimation(series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle = 0, seriesIndex = 0) {
        const finishedCurrentSerie = currentRadianAngle > endRadianAngle;
        const finishedAllSeries = seriesIndex === series.length;
        if (finishedAllSeries) {
            this.animate = false;
            return;
        }
        if (finishedCurrentSerie) {
            this.setSerieLabelCoordinates(seriesIndex);
            currentRadianAngle = 0;
            seriesIndex++;
            startRadianAngle = startRadianAngle + endRadianAngle;
            endRadianAngle =
                seriesIndex < series.length ? this.calculateAngle(series[seriesIndex].data, totalValue) : undefined;
        }
        else {
            currentRadianAngle += PoChartAngleStepInterval;
            const currentEndRadianAngle = this.calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle);
            const coordinates = this.calculateCoordinates(height, startRadianAngle, currentEndRadianAngle);
            this.svgPaths.toArray()[seriesIndex].applyCoordinates(coordinates);
        }
        window.requestAnimationFrame(this.calculateCoordinatesWithAnimation.bind(this, series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle, seriesIndex));
    }
    calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle) {
        const isSerieDrawCompleted = startRadianAngle + currentRadianAngle > startRadianAngle + endRadianAngle;
        return isSerieDrawCompleted
            ? startRadianAngle + endRadianAngle - PoChartCompleteCircle
            : startRadianAngle + currentRadianAngle;
    }
    initDrawPaths(seriesList, totalValue, height) {
        if (!this.animate) {
            this.calculateSerieCoordinates(seriesList, totalValue, height);
        }
        else {
            const startRadianAngle = PoChartStartAngle;
            const endRadianAngle = this.calculateAngle(seriesList[0].data, totalValue);
            this.ngZone.runOutsideAngular(() => this.calculateCoordinatesWithAnimation(seriesList, totalValue, height, startRadianAngle, endRadianAngle));
        }
    }
    setSerieLabelCoordinates(index) {
        if (this.svgLabels.toArray().length) {
            this.svgLabels.toArray()[index].applyCoordinates(this.seriesLabels[index]);
        }
    }
    validateSeries(series) {
        return series.reduce((seriesList, serie) => {
            const data = serie.data ?? serie.value;
            if (data && data > 0) {
                const color = serie.color;
                const label = serie.label;
                const tooltip = serie.tooltip;
                const tooltipLabel = this.getTooltipLabel(data, label, tooltip);
                seriesList = [...seriesList, { data, color, label, tooltipLabel }];
            }
            return seriesList;
        }, []);
    }
    static ɵfac = function PoChartCircularComponent_Factory(t) { return new (t || PoChartCircularComponent)(i0.ɵɵdirectiveInject(i0.NgZone), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef)); };
    static ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: PoChartCircularComponent, viewQuery: function PoChartCircularComponent_Query(rf, ctx) { if (rf & 1) {
            i0.ɵɵviewQuery(_c0, 5);
            i0.ɵɵviewQuery(_c1, 5);
        } if (rf & 2) {
            let _t;
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.svgPaths = _t);
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.svgLabels = _t);
        } }, inputs: { containerSize: [i0.ɵɵInputFlags.None, "p-container-size", "containerSize"], options: [i0.ɵɵInputFlags.None, "p-options", "options"], series: [i0.ɵɵInputFlags.None, "p-series", "series"] }, outputs: { circularClick: "p-circular-click", circularHover: "p-circular-hover" } });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoChartCircularComponent, [{
        type: Directive
    }], () => [{ type: i0.NgZone }, { type: i0.ChangeDetectorRef }], { containerSize: [{
            type: Input,
            args: ['p-container-size']
        }], circularClick: [{
            type: Output,
            args: ['p-circular-click']
        }], circularHover: [{
            type: Output,
            args: ['p-circular-hover']
        }], svgPaths: [{
            type: ViewChildren,
            args: ['svgPaths']
        }], svgLabels: [{
            type: ViewChildren,
            args: ['svgLabels']
        }], options: [{
            type: Input,
            args: ['p-options']
        }], series: [{
            type: Input,
            args: ['p-series']
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtY2lyY3VsYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWNoYXJ0L3BvLWNoYXJ0LWNvbnRhaW5lci9wby1jaGFydC1jaXJjdWxhci9wby1jaGFydC1jaXJjdWxhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUVMLE1BQU0sRUFFTixZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixxQkFBcUIsRUFDckIsd0JBQXdCLEVBQ3pCLE1BQU0sZ0RBQWdELENBQUM7Ozs7QUFXeEQsTUFBTSxPQUFnQix3QkFBd0I7SUE4Q2xDO0lBQ0E7SUE5Q2lCLGFBQWEsQ0FBdUI7SUFFbkMsYUFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7SUFFeEMsYUFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7SUFFbEMsUUFBUSxDQUEwQztJQUVqRCxTQUFTLENBQTJDO0lBRXZGLGdCQUFnQixHQUFZLEtBQUssQ0FBQztJQUNsQyxZQUFZLEdBQW1DLEVBQUUsQ0FBQztJQUNsRCxVQUFVLENBQWdDO0lBQzFDLFVBQVUsR0FBWSxLQUFLLENBQUM7SUFFbEIsV0FBVyxDQUFTO0lBQ3BCLFVBQVUsQ0FBUztJQUVyQixRQUFRLENBQWlCO0lBQ3pCLE9BQU8sQ0FBc0I7SUFFN0IsT0FBTyxDQUFVO0lBRXpCLElBQXdCLE9BQU8sQ0FBQyxLQUFxQjtRQUNuRCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsRUFBRTtZQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztZQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxD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QkFBd0I7Ozs7Ozs7OztpRkFBeEIsd0JBQXdCO2NBRDdDLFNBQVM7dUVBRW1CLGFBQWE7a0JBQXZDLEtBQUs7bUJBQUMsa0JBQWtCO1lBRUcsYUFBYTtrQkFBeEMsTUFBTTttQkFBQyxrQkFBa0I7WUFFRSxhQUFhO2tCQUF4QyxNQUFNO21CQUFDLGtCQUFrQjtZQUVRLFFBQVE7a0JBQXpDLFlBQVk7bUJBQUMsVUFBVTtZQUVXLFNBQVM7a0JBQTNDLFlBQVk7bUJBQUMsV0FBVztZQWVELE9BQU87a0JBQTlCLEtBQUs7bUJBQUMsV0FBVztZQVdLLE1BQU07a0JBQTVCLEtBQUs7bUJBQUMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBEaXJlY3RpdmUsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFZpZXdDaGlsZHJlblxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgUG9DaGFydFN0YXJ0QW5nbGUsXG4gIFBvQ2hhcnRDb21wbGV0ZUNpcmNsZSxcbiAgUG9DaGFydEFuZ2xlU3RlcEludGVydmFsXG59IGZyb20gJy4uLy4uL2hlbHBlcnMvcG8tY2hhcnQtZGVmYXVsdC12YWx1ZXMuY29uc3RhbnQnO1xuXG5pbXBvcnQgeyBQb0NoYXJ0Q2lyY3VsYXJMYWJlbENvbXBvbmVudCB9IGZyb20gJy4vcG8tY2hhcnQtY2lyY3VsYXItbGFiZWwvcG8tY2hhcnQtY2lyY3VsYXItbGFiZWwuY29tcG9uZW50JztcbmltcG9ydCB7IFBvQ2hhcnRDaXJjdWxhclBhdGhDb21wb25lbnQgfSBmcm9tICcuL3BvLWNoYXJ0LWNpcmN1bGFyLXBhdGgvcG8tY2hhcnQtY2lyY3VsYXItcGF0aC5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9DaGFydENvbnRhaW5lclNpemUgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LWNvbnRhaW5lci1zaXplLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NoYXJ0TGFiZWxDb29yZGluYXRlcyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvcG8tY2hhcnQtbGFiZWwtY29vcmRpbmF0ZXMuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvQ2hhcnRPcHRpb25zIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1vcHRpb25zLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NoYXJ0UGF0aENvb3JkaW5hdGVzIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1wYXRoLWNvb3JkaW5hdGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NoYXJ0U2VyaWUgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LXNlcmllLmludGVyZmFjZSc7XG5cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFBvQ2hhcnRDaXJjdWxhckNvbXBvbmVudCB7XG4gIEBJbnB1dCgncC1jb250YWluZXItc2l6ZScpIGNvbnRhaW5lclNpemU6IFBvQ2hhcnRDb250YWluZXJTaXplO1xuXG4gIEBPdXRwdXQoJ3AtY2lyY3VsYXItY2xpY2snKSBjaXJjdWxhckNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQE91dHB1dCgncC1jaXJjdWxhci1ob3ZlcicpIGNpcmN1bGFySG92ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAVmlld0NoaWxkcmVuKCdzdmdQYXRocycpIHByaXZhdGUgc3ZnUGF0aHM6IFF1ZXJ5TGlzdDxQb0NoYXJ0Q2lyY3VsYXJQYXRoQ29tcG9uZW50PjtcblxuICBAVmlld0NoaWxkcmVuKCdzdmdMYWJlbHMnKSBwcml2YXRlIHN2Z0xhYmVsczogUXVlcnlMaXN0PFBvQ2hhcnRDaXJjdWxhckxhYmVsQ29tcG9uZW50PjtcblxuICBjYW5EaXNwbGF5TGFiZWxzOiBib29sZWFuID0gZmFsc2U7XG4gIHNlcmllc0xhYmVsczogQXJyYXk8UG9DaGFydExhYmVsQ29vcmRpbmF0ZXM+ID0gW107XG4gIHNlcmllc0xpc3Q6IEFycmF5PFBvQ2hhcnRQYXRoQ29vcmRpbmF0ZXM+O1xuICBzaG93TGFiZWxzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgcHJvdGVjdGVkIGlubmVyUmFkaXVzOiBudW1iZXI7XG4gIHByb3RlY3RlZCB0b3RhbFZhbHVlOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfb3B0aW9uczogUG9DaGFydE9wdGlvbnM7XG4gIHByaXZhdGUgX3NlcmllczogQXJyYXk8UG9DaGFydFNlcmllPjtcblxuICBwcml2YXRlIGFuaW1hdGU6IGJvb2xlYW47XG5cbiAgQElucHV0KCdwLW9wdGlvbnMnKSBzZXQgb3B0aW9ucyh2YWx1ZTogUG9DaGFydE9wdGlvbnMpIHtcbiAgICBpZiAoIWlzTmFOKHZhbHVlPy5pbm5lclJhZGl1cykpIHtcbiAgICAgIHRoaXMuX29wdGlvbnMgPSB2YWx1ZTtcbiAgICAgIHRoaXMuaW5uZXJSYWRpdXMgPSBNYXRoLm1pbihNYXRoLm1heCh0aGlzLl9vcHRpb25zLmlubmVyUmFkaXVzLCAwKSwgMTAwKTtcbiAgICB9XG4gIH1cblxuICBnZXQgb3B0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9ucztcbiAgfVxuXG4gIEBJbnB1dCgncC1zZXJpZXMnKSBzZXQgc2VyaWVzKHZhbHVlOiBBcnJheTxQb0NoYXJ0U2VyaWU+KSB7XG4gICAgdGhpcy5fc2VyaWVzID0gdmFsdWU7XG5cbiAgICB0aGlzLmFuaW1hdGUgPSB0cnVlO1xuICB9XG5cbiAgZ2V0IHNlcmllcygpIHtcbiAgICByZXR1cm4gdGhpcy5fc2VyaWVzO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHt9XG5cbiAgb25TZXJpZUNsaWNrKHNlbGVjdGVkSXRlbTogYW55KSB7XG4gICAgdGhpcy5jaXJjdWxhckNsaWNrLmVtaXQoc2VsZWN0ZWRJdGVtKTtcbiAgfVxuXG4gIG9uU2VyaWVIb3ZlcihzZWxlY3RlZEl0ZW06IGFueSkge1xuICAgIHRoaXMuY2lyY3VsYXJIb3Zlci5lbWl0KHNlbGVjdGVkSXRlbSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY2FsY3VsYXRlQW5nbGUoZGF0YTogbnVtYmVyLCB0b3RhbFZhbHVlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gKGRhdGEgLyB0b3RhbFZhbHVlKSAqIChNYXRoLlBJICogMik7XG4gIH1cblxuICBwcm90ZWN0ZWQgZHJhd1NlcmllcyhzZXJpZXM6IEFycmF5PFBvQ2hhcnRTZXJpZT4gPSBbXSwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICB0aGlzLnNlcmllc0xpc3QgPSBbXTtcbiAgICB0aGlzLnNob3dMYWJlbHMgPSBmYWxzZTtcbiAgICB0aGlzLnRvdGFsVmFsdWUgPSB0aGlzLmNhbGN1bGF0ZVRvdGFsVmFsdWUoc2VyaWVzKTtcbiAgICBpZiAodGhpcy50b3RhbFZhbHVlICYmIHRoaXMudG90YWxWYWx1ZSA+IDApIHtcbiAgICAgIHRoaXMuc2VyaWVzTGlzdCA9IHRoaXMudmFsaWRhdGVTZXJpZXMoc2VyaWVzKTtcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgICBpZiAodGhpcy5zZXJpZXNMaXN0Lmxlbmd0aCAmJiB0aGlzLnN2Z1BhdGhzKSB7XG4gICAgICAgIHRoaXMuaW5pdERyYXdQYXRocyh0aGlzLnNlcmllc0xpc3QsIHRoaXMudG90YWxWYWx1ZSwgaGVpZ2h0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZVRvdGFsVmFsdWUoc2VyaWVzOiBBcnJheTxQb0NoYXJ0U2VyaWU+KSB7XG4gICAgcmV0dXJuIHNlcmllcy5yZWR1Y2UoKHByZXZpb3VzVmFsdWUsIHNlcmllOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBzZXJpZS5kYXRhID8gc2VyaWUuZGF0YSA6IHNlcmllLnZhbHVlO1xuXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSArIChkYXRhID4gMCA/IGRhdGEgOiAwKTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIHByaXZhdGUgY2FsY3VsYXRlU2VyaWVDb29yZGluYXRlcyhzZXJpZXM6IEFycmF5PFBvQ2hhcnRQYXRoQ29vcmRpbmF0ZXM+LCB0b3RhbFZhbHVlOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgbGV0IHN0YXJ0UmFkaWFuQW5nbGU7XG4gICAgbGV0IGVuZFJhZGlhbkFuZ2xlID0gUG9DaGFydFN0YXJ0QW5nbGU7XG5cbiAgICBzZXJpZXMuZm9yRWFjaCgoc2VyaWU6IGFueSwgaW5kZXgpID0+IHtcbiAgICAgIHN0YXJ0UmFkaWFuQW5nbGUgPSBlbmRSYWRpYW5BbmdsZTtcbiAgICAgIGVuZFJhZGlhbkFuZ2xlID0gc3RhcnRSYWRpYW5BbmdsZSArIHRoaXMuY2FsY3VsYXRlQW5nbGUoc2VyaWUuZGF0YSwgdG90YWxWYWx1ZSkgLSBQb0NoYXJ0Q29tcGxldGVDaXJjbGU7XG5cbiAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gdGhpcy5jYWxjdWxhdGVDb29yZGluYXRlcyhoZWlnaHQsIHN0YXJ0UmFkaWFuQW5nbGUsIGVuZFJhZGlhbkFuZ2xlKTtcblxuICAgICAgdGhpcy5zdmdQYXRocy50b0FycmF5KClbaW5kZXhdLmFwcGx5Q29vcmRpbmF0ZXMoY29vcmRpbmF0ZXMpO1xuICAgICAgdGhpcy5zaG93TGFiZWxzID0gdGhpcy5jYW5EaXNwbGF5TGFiZWxzO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVDb29yZGluYXRlc1dpdGhBbmltYXRpb24oXG4gICAgc2VyaWVzOiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPixcbiAgICB0b3RhbFZhbHVlOiBudW1iZXIsXG4gICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgc3RhcnRSYWRpYW5BbmdsZTogbnVtYmVyLFxuICAgIGVuZFJhZGlhbkFuZ2xlOiBudW1iZXIsXG4gICAgY3VycmVudFJhZGlhbkFuZ2xlOiBudW1iZXIgPSAwLFxuICAgIHNlcmllc0luZGV4OiBudW1iZXIgPSAwXG4gICkge1xuICAgIGNvbnN0IGZpbmlzaGVkQ3VycmVudFNlcmllID0gY3VycmVudFJhZGlhbkFuZ2xlID4gZW5kUmFkaWFuQW5nbGU7XG4gICAgY29uc3QgZmluaXNoZWRBbGxTZXJpZXMgPSBzZXJpZXNJbmRleCA9PT0gc2VyaWVzLmxlbmd0aDtcblxuICAgIGlmIChmaW5pc2hlZEFsbFNlcmllcykge1xuICAgICAgdGhpcy5hbmltYXRlID0gZmFsc2U7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGZpbmlzaGVkQ3VycmVudFNlcmllKSB7XG4gICAgICB0aGlzLnNldFNlcmllTGFiZWxDb29yZGluYXRlcyhzZXJpZXNJbmRleCk7XG4gICAgICBjdXJyZW50UmFkaWFuQW5nbGUgPSAwO1xuICAgICAgc2VyaWVzSW5kZXgrKztcbiAgICAgIHN0YXJ0UmFkaWFuQW5nbGUgPSBzdGFydFJhZGlhbkFuZ2xlICsgZW5kUmFkaWFuQW5nbGU7XG4gICAgICBlbmRSYWRpYW5BbmdsZSA9XG4gICAgICAgIHNlcmllc0luZGV4IDwgc2VyaWVzLmxlbmd0aCA/IHRoaXMuY2FsY3VsYXRlQW5nbGUoc2VyaWVzW3Nlcmllc0luZGV4XS5kYXRhLCB0b3RhbFZhbHVlKSA6IHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgY3VycmVudFJhZGlhbkFuZ2xlICs9IFBvQ2hhcnRBbmdsZVN0ZXBJbnRlcnZhbDtcblxuICAgICAgY29uc3QgY3VycmVudEVuZFJhZGlhbkFuZ2xlID0gdGhpcy5jYWxjdWxhdGVDdXJyZW50RW5kQW5nbGUoY3VycmVudFJhZGlhbkFuZ2xlLCBzdGFydFJhZGlhbkFuZ2xlLCBlbmRSYWRpYW5BbmdsZSk7XG4gICAgICBjb25zdCBjb29yZGluYXRlcyA9IHRoaXMuY2FsY3VsYXRlQ29vcmRpbmF0ZXMoaGVpZ2h0LCBzdGFydFJhZGlhbkFuZ2xlLCBjdXJyZW50RW5kUmFkaWFuQW5nbGUpO1xuXG4gICAgICB0aGlzLnN2Z1BhdGhzLnRvQXJyYXkoKVtzZXJpZXNJbmRleF0uYXBwbHlDb29yZGluYXRlcyhjb29yZGluYXRlcyk7XG4gICAgfVxuXG4gICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShcbiAgICAgIHRoaXMuY2FsY3VsYXRlQ29vcmRpbmF0ZXNXaXRoQW5pbWF0aW9uLmJpbmQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIHNlcmllcyxcbiAgICAgICAgdG90YWxWYWx1ZSxcbiAgICAgICAgaGVpZ2h0LFxuICAgICAgICBzdGFydFJhZGlhbkFuZ2xlLFxuICAgICAgICBlbmRSYWRpYW5BbmdsZSxcbiAgICAgICAgY3VycmVudFJhZGlhbkFuZ2xlLFxuICAgICAgICBzZXJpZXNJbmRleFxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUN1cnJlbnRFbmRBbmdsZShjdXJyZW50UmFkaWFuQW5nbGU6IG51bWJlciwgc3RhcnRSYWRpYW5BbmdsZTogbnVtYmVyLCBlbmRSYWRpYW5BbmdsZTogbnVtYmVyKSB7XG4gICAgY29uc3QgaXNTZXJpZURyYXdDb21wbGV0ZWQgPSBzdGFydFJhZGlhbkFuZ2xlICsgY3VycmVudFJhZGlhbkFuZ2xlID4gc3RhcnRSYWRpYW5BbmdsZSArIGVuZFJhZGlhbkFuZ2xlO1xuXG4gICAgcmV0dXJuIGlzU2VyaWVEcmF3Q29tcGxldGVkXG4gICAgICA/IHN0YXJ0UmFkaWFuQW5nbGUgKyBlbmRSYWRpYW5BbmdsZSAtIFBvQ2hhcnRDb21wbGV0ZUNpcmNsZVxuICAgICAgOiBzdGFydFJhZGlhbkFuZ2xlICsgY3VycmVudFJhZGlhbkFuZ2xlO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0RHJhd1BhdGhzKHNlcmllc0xpc3Q6IEFycmF5PFBvQ2hhcnRQYXRoQ29vcmRpbmF0ZXM+LCB0b3RhbFZhbHVlOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgaWYgKCF0aGlzLmFuaW1hdGUpIHtcbiAgICAgIHRoaXMuY2FsY3VsYXRlU2VyaWVDb29yZGluYXRlcyhzZXJpZXNMaXN0LCB0b3RhbFZhbHVlLCBoZWlnaHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzdGFydFJhZGlhbkFuZ2xlID0gUG9DaGFydFN0YXJ0QW5nbGU7XG4gICAgICBjb25zdCBlbmRSYWRpYW5BbmdsZSA9IHRoaXMuY2FsY3VsYXRlQW5nbGUoc2VyaWVzTGlzdFswXS5kYXRhLCB0b3RhbFZhbHVlKTtcblxuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT5cbiAgICAgICAgdGhpcy5jYWxjdWxhdGVDb29yZGluYXRlc1dpdGhBbmltYXRpb24oc2VyaWVzTGlzdCwgdG90YWxWYWx1ZSwgaGVpZ2h0LCBzdGFydFJhZGlhbkFuZ2xlLCBlbmRSYWRpYW5BbmdsZSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRTZXJpZUxhYmVsQ29vcmRpbmF0ZXMoaW5kZXg6IG51bWJlcikge1xuICAgIGlmICh0aGlzLnN2Z0xhYmVscy50b0FycmF5KCkubGVuZ3RoKSB7XG4gICAgICB0aGlzLnN2Z0xhYmVscy50b0FycmF5KClbaW5kZXhdLmFwcGx5Q29vcmRpbmF0ZXModGhpcy5zZXJpZXNMYWJlbHNbaW5kZXhdKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlU2VyaWVzKHNlcmllczogQXJyYXk8UG9DaGFydFNlcmllPikge1xuICAgIHJldHVybiBzZXJpZXMucmVkdWNlKChzZXJpZXNMaXN0LCBzZXJpZTogYW55KSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gc2VyaWUuZGF0YSA/PyBzZXJpZS52YWx1ZTtcbiAgICAgIGlmIChkYXRhICYmIGRhdGEgPiAwKSB7XG4gICAgICAgIGNvbnN0IGNvbG9yID0gc2VyaWUuY29sb3I7XG4gICAgICAgIGNvbnN0IGxhYmVsID0gc2VyaWUubGFiZWw7XG4gICAgICAgIGNvbnN0IHRvb2x0aXAgPSBzZXJpZS50b29sdGlwO1xuICAgICAgICBjb25zdCB0b29sdGlwTGFiZWwgPSB0aGlzLmdldFRvb2x0aXBMYWJlbChkYXRhLCBsYWJlbCwgdG9vbHRpcCk7XG5cbiAgICAgICAgc2VyaWVzTGlzdCA9IFsuLi5zZXJpZXNMaXN0LCB7IGRhdGEsIGNvbG9yLCBsYWJlbCwgdG9vbHRpcExhYmVsIH1dO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc2VyaWVzTGlzdDtcbiAgICB9LCBbXSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgY2FsY3VsYXRlQ29vcmRpbmF0ZXMoaGVpZ2h0LCBzdGFydFJhZGlhbkFuZ2xlLCBjdXJyZW50RW5kUmFkaWFuQW5nbGUpO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0VG9vbHRpcExhYmVsKGRhdGEsIGxhYmVsLCB0b29sdGlwKTtcbn1cbiJdfQ==