import { Component, EventEmitter, Input, Output } from '@angular/core';
import { from, timer } from 'rxjs';
import { concatMap, mapTo, scan, tap } from 'rxjs/operators';
import { convertToBoolean, isIE } from '../../../../../utils/util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "../../../../../directives/po-tooltip/po-tooltip.directive";
const _c0 = ["po-chart-series-point", ""];
function PoChartSeriesPointComponent__svg_circle_0_Template(rf, ctx) { if (rf & 1) {
    const _r3 = i0.ɵɵgetCurrentView();
    i0.ɵɵnamespaceSVG();
    i0.ɵɵelementStart(0, "circle", 1);
    i0.ɵɵlistener("click", function PoChartSeriesPointComponent__svg_circle_0_Template__svg_circle_click_0_listener() { const restoredCtx = i0.ɵɵrestoreView(_r3); const item_r1 = restoredCtx.$implicit; const ctx_r2 = i0.ɵɵnextContext(); return i0.ɵɵresetView(ctx_r2.onClick(item_r1)); })("mouseenter", function PoChartSeriesPointComponent__svg_circle_0_Template__svg_circle_mouseenter_0_listener($event) { const restoredCtx = i0.ɵɵrestoreView(_r3); const item_r1 = restoredCtx.$implicit; const ctx_r4 = i0.ɵɵnextContext(); return i0.ɵɵresetView(ctx_r4.onMouseEnter($event, item_r1)); })("mouseleave", function PoChartSeriesPointComponent__svg_circle_0_Template__svg_circle_mouseleave_0_listener($event) { i0.ɵɵrestoreView(_r3); const ctx_r5 = i0.ɵɵnextContext(); return i0.ɵɵresetView(ctx_r5.onMouseLeave($event)); });
    i0.ɵɵelementEnd();
} if (rf & 2) {
    const item_r1 = ctx.$implicit;
    const ctx_r0 = i0.ɵɵnextContext();
    i0.ɵɵclassMap((ctx_r0.strokeColor == null ? null : ctx_r0.strokeColor.includes("po-border-color")) ? ctx_r0.strokeColor : "");
    i0.ɵɵclassProp("po-chart-active-point", item_r1.isActive);
    i0.ɵɵproperty("p-tooltip", item_r1.tooltipLabel)("p-append-in-body", true)("p-display-tooltip", !ctx_r0.chartLine && item_r1.isActive);
    i0.ɵɵattribute("cx", item_r1.xCoordinate)("cy", item_r1.yCoordinate)("r", ctx_r0.radius)("stroke", ctx_r0.strokeColor);
} }
const RADIUS_DEFAULT_SIZE = 5;
const RADIUS_HOVER_SIZE = 10;
const ANIMATION_DURATION_TIME = 700;
export class PoChartSeriesPointComponent {
    renderer;
    elementRef;
    animate;
    isActive;
    chartLine = false;
    // Referência para o svgPathGroup ao qual pertence o ponto. Necessário para reordenação dos svgElements no DOM para tratamento onHover
    relativeTo;
    pointClick = new EventEmitter();
    pointHover = new EventEmitter();
    coordinates$;
    radius = RADIUS_DEFAULT_SIZE;
    strokeColor;
    _color;
    _coordinates = [];
    animationState = true;
    set color(value) {
        this.strokeColor = value.includes('po-color') ? value.replace('po-color', 'po-border-color') : value;
        this._color = value;
    }
    get color() {
        return this._color;
    }
    set coordinates(value) {
        this._coordinates = value;
        this.coordinates$ = this.displayPointsWithDelay(this._coordinates);
    }
    get coordinates() {
        return this._coordinates;
    }
    constructor(renderer, elementRef) {
        this.renderer = renderer;
        this.elementRef = elementRef;
    }
    trackBy(index) {
        return index;
    }
    onClick(point) {
        const selectedItem = { label: point.label, data: point.data, category: point.category };
        this.pointClick.emit(selectedItem);
    }
    onMouseEnter(event, point) {
        this.setPointAttribute(event.target, true);
        const selectedItem = { label: point.label, data: point.data, category: point.category };
        this.pointHover.emit({ relativeTo: this.relativeTo, ...selectedItem });
    }
    onMouseLeave(event) {
        this.setPointAttribute(event.target, false);
    }
    displayPointsWithDelay(coordinates) {
        if (this.animationState && !isIE()) {
            const animationTimer = ANIMATION_DURATION_TIME / coordinates.length;
            return from(coordinates).pipe(concatMap((item, index) => timer(index === 0 || !this.animate ? 0 : animationTimer).pipe(mapTo(item))), scan((acc, curr) => acc.concat(curr), []), tap(() => (this.animationState = false)));
        }
        else {
            return from([coordinates]);
        }
    }
    setPointAttribute(target, isHover) {
        this.renderer.setAttribute(target, 'r', isHover ? RADIUS_HOVER_SIZE.toString() : RADIUS_DEFAULT_SIZE.toString());
        if (this.color.includes('po-color')) {
            this.renderer.setAttribute(target, 'class', isHover ? `${this.strokeColor} ${this.color}` : `po-chart-line-point po-chart-active-point ${this.strokeColor}`);
        }
        else {
            this.renderer[isHover ? 'setStyle' : 'removeStyle'](target, 'fill', isHover ? this.color : undefined);
        }
    }
    static ɵfac = function PoChartSeriesPointComponent_Factory(t) { return new (t || PoChartSeriesPointComponent)(i0.ɵɵdirectiveInject(i0.Renderer2), i0.ɵɵdirectiveInject(i0.ElementRef)); };
    static ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: PoChartSeriesPointComponent, selectors: [["", "po-chart-series-point", ""]], inputs: { animate: [i0.ɵɵInputFlags.None, "p-animate", "animate"], isActive: [i0.ɵɵInputFlags.HasDecoratorInputTransform, "p-is-active", "isActive", convertToBoolean], chartLine: [i0.ɵɵInputFlags.HasDecoratorInputTransform, "p-chart-line", "chartLine", convertToBoolean], relativeTo: [i0.ɵɵInputFlags.None, "p-relative-to", "relativeTo"], color: [i0.ɵɵInputFlags.None, "p-color", "color"], coordinates: [i0.ɵɵInputFlags.None, "p-coordinates", "coordinates"] }, outputs: { pointClick: "p-point-click", pointHover: "p-point-hover" }, features: [i0.ɵɵInputTransformsFeature], attrs: _c0, decls: 2, vars: 4, consts: [["p-tooltip-position", "top", "class", "po-chart-line-point", 3, "p-tooltip", "p-append-in-body", "p-display-tooltip", "class", "po-chart-active-point", "click", "mouseenter", "mouseleave", 4, "ngFor", "ngForOf", "ngForTrackBy"], ["p-tooltip-position", "top", 1, "po-chart-line-point", 3, "p-tooltip", "p-append-in-body", "p-display-tooltip", "click", "mouseenter", "mouseleave"]], template: function PoChartSeriesPointComponent_Template(rf, ctx) { if (rf & 1) {
            i0.ɵɵtemplate(0, PoChartSeriesPointComponent__svg_circle_0_Template, 1, 11, "circle", 0);
            i0.ɵɵpipe(1, "async");
        } if (rf & 2) {
            i0.ɵɵproperty("ngForOf", i0.ɵɵpipeBind1(1, 2, ctx.coordinates$))("ngForTrackBy", ctx.trackBy);
        } }, dependencies: [i1.NgForOf, i2.PoTooltipDirective, i1.AsyncPipe], encapsulation: 2 });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoChartSeriesPointComponent, [{
        type: Component,
        args: [{ selector: '[po-chart-series-point]', template: "<svg:circle *ngFor=\"let item of coordinates$ | async; trackBy: trackBy\" \n  [p-tooltip]=\"item.tooltipLabel\"\n  [p-append-in-body]='true'\n  [p-display-tooltip]=\"!chartLine && item.isActive\"\n  p-tooltip-position=\"top\"\n  class=\"po-chart-line-point\"\n  [class]=\"strokeColor?.includes('po-border-color') ? strokeColor : ''\"\n  [class.po-chart-active-point]=\"item.isActive\"\n  [attr.cx]=\"item.xCoordinate\"\n  [attr.cy]=\"item.yCoordinate\"\n  [attr.r]=\"radius\"\n  [attr.stroke]=\"strokeColor\"\n  (click)=\"onClick(item)\"\n  (mouseenter)=\"onMouseEnter($event, item)\"\n  (mouseleave)=\"onMouseLeave($event)\"\n  >\n</svg:circle>\n" }]
    }], () => [{ type: i0.Renderer2 }, { type: i0.ElementRef }], { animate: [{
            type: Input,
            args: ['p-animate']
        }], isActive: [{
            type: Input,
            args: [{ alias: 'p-is-active', transform: convertToBoolean }]
        }], chartLine: [{
            type: Input,
            args: [{ alias: 'p-chart-line', transform: convertToBoolean }]
        }], relativeTo: [{
            type: Input,
            args: ['p-relative-to']
        }], pointClick: [{
            type: Output,
            args: ['p-point-click']
        }], pointHover: [{
            type: Output,
            args: ['p-point-hover']
        }], color: [{
            type: Input,
            args: ['p-color']
        }], coordinates: [{
            type: Input,
            args: ['p-coordinates']
        }] }); })();
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassDebugInfo(PoChartSeriesPointComponent, { className: "PoChartSeriesPointComponent", filePath: "lib/components/po-chart/po-chart-container/po-chart-line/po-chart-series-point/po-chart-series-point.component.ts", lineNumber: 17 }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1jaGFydC9wby1jaGFydC1jb250YWluZXIvcG8tY2hhcnQtbGluZS9wby1jaGFydC1zZXJpZXMtcG9pbnQvcG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1jaGFydC9wby1jaGFydC1jb250YWluZXIvcG8tY2hhcnQtbGluZS9wby1jaGFydC1zZXJpZXMtcG9pbnQvcG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC5zdmciXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUM5RixPQUFPLEVBQWMsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7Ozs7O0lDSm5FLG1CQWVHO0lBZkgsaUNBZUc7SUFIRCxnUEFBUyxlQUFBLHVCQUFhLENBQUEsSUFBQyxtUEFDVCxlQUFBLG9DQUEwQixDQUFBLElBRGpCLHdMQUVULGVBQUEsMkJBQW9CLENBQUEsSUFGWDtJQUl6QixpQkFBYTs7OztJQVZYLDZIQUFxRTtJQUNyRSx5REFBNkM7SUFON0MsZ0RBQStCLDBCQUFBLDREQUFBO0lBTy9CLHlDQUE0QiwyQkFBQSxvQkFBQSw4QkFBQTs7QURBOUIsTUFB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QUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3ZHO0lBQ0gsQ0FBQztxRkEvRlUsMkJBQTJCOzZEQUEzQiwyQkFBMkIsdU1BR0ksZ0JBQWdCLHdGQUVmLGdCQUFnQjtZQ3JCN0Qsd0ZBZ0JhOzs7WUFoQmdCLGdFQUF5Qiw2QkFBQTs7O2lGRGdCekMsMkJBQTJCO2NBSnZDLFNBQVM7MkJBQ0UseUJBQXlCO21FQUlmLE9BQU87a0JBQTFCLEtBQUs7bUJBQUMsV0FBVztZQUU0QyxRQUFRO2tCQUFyRSxLQUFLO21CQUFDLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7WUFFRyxTQUFTO2tCQUF2RSxLQUFLO21CQUFDLEVBQUUsS0FBSyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUU7WUFHckMsVUFBVTtrQkFBakMsS0FBSzttQkFBQyxlQUFlO1lBRUcsVUFBVTtrQkFBbEMsTUFBTTttQkFBQyxlQUFlO1lBRUUsVUFBVTtrQkFBbEMsTUFBTTttQkFBQyxlQUFlO1lBV0QsS0FBSztrQkFBMUIsS0FBSzttQkFBQyxTQUFTO1lBU1ksV0FBVztrQkFBdEMsS0FBSzttQkFBQyxlQUFlOztrRkFoQ1gsMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvbmNhdE1hcCwgbWFwVG8sIHNjYW4sIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgY29udmVydFRvQm9vbGVhbiwgaXNJRSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuXG5pbXBvcnQgeyBQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXMgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LXBvaW50cy1jb29yZGluYXRlcy5pbnRlcmZhY2UnO1xuXG5jb25zdCBSQURJVVNfREVGQVVMVF9TSVpFID0gNTtcbmNvbnN0IFJBRElVU19IT1ZFUl9TSVpFID0gMTA7XG5jb25zdCBBTklNQVRJT05fRFVSQVRJT05fVElNRSA9IDcwMDtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnW3BvLWNoYXJ0LXNlcmllcy1wb2ludF0nLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC5zdmcnXG59KVxuZXhwb3J0IGNsYXNzIFBvQ2hhcnRTZXJpZXNQb2ludENvbXBvbmVudCB7XG4gIEBJbnB1dCgncC1hbmltYXRlJykgYW5pbWF0ZTogYm9vbGVhbjtcblxuICBASW5wdXQoeyBhbGlhczogJ3AtaXMtYWN0aXZlJywgdHJhbnNmb3JtOiBjb252ZXJ0VG9Cb29sZWFuIH0pIGlzQWN0aXZlPzogYm9vbGVhbjtcblxuICBASW5wdXQoeyBhbGlhczogJ3AtY2hhcnQtbGluZScsIHRyYW5zZm9ybTogY29udmVydFRvQm9vbGVhbiB9KSBjaGFydExpbmU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvLyBSZWZlcsOqbmNpYSBwYXJhIG8gc3ZnUGF0aEdyb3VwIGFvIHF1YWwgcGVydGVuY2UgbyBwb250by4gTmVjZXNzw6FyaW8gcGFyYSByZW9yZGVuYcOnw6NvIGRvcyBzdmdFbGVtZW50cyBubyBET00gcGFyYSB0cmF0YW1lbnRvIG9uSG92ZXJcbiAgQElucHV0KCdwLXJlbGF0aXZlLXRvJykgcmVsYXRpdmVUbzogc3RyaW5nO1xuXG4gIEBPdXRwdXQoJ3AtcG9pbnQtY2xpY2snKSBwb2ludENsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQE91dHB1dCgncC1wb2ludC1ob3ZlcicpIHBvaW50SG92ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBjb29yZGluYXRlcyQ6IE9ic2VydmFibGU8QXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPj47XG4gIHJhZGl1czogbnVtYmVyID0gUkFESVVTX0RFRkFVTFRfU0laRTtcbiAgc3Ryb2tlQ29sb3I6IHN0cmluZztcblxuICBwcml2YXRlIF9jb2xvcjogc3RyaW5nO1xuICBwcml2YXRlIF9jb29yZGluYXRlczogQXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPiA9IFtdO1xuXG4gIHByaXZhdGUgYW5pbWF0aW9uU3RhdGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIEBJbnB1dCgncC1jb2xvcicpIHNldCBjb2xvcih2YWx1ZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zdHJva2VDb2xvciA9IHZhbHVlLmluY2x1ZGVzKCdwby1jb2xvcicpID8gdmFsdWUucmVwbGFjZSgncG8tY29sb3InLCAncG8tYm9yZGVyLWNvbG9yJykgOiB2YWx1ZTtcbiAgICB0aGlzLl9jb2xvciA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGNvbG9yKCkge1xuICAgIHJldHVybiB0aGlzLl9jb2xvcjtcbiAgfVxuXG4gIEBJbnB1dCgncC1jb29yZGluYXRlcycpIHNldCBjb29yZGluYXRlcyh2YWx1ZTogQXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPikge1xuICAgIHRoaXMuX2Nvb3JkaW5hdGVzID0gdmFsdWU7XG5cbiAgICB0aGlzLmNvb3JkaW5hdGVzJCA9IHRoaXMuZGlzcGxheVBvaW50c1dpdGhEZWxheSh0aGlzLl9jb29yZGluYXRlcyk7XG4gIH1cblxuICBnZXQgY29vcmRpbmF0ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2Nvb3JkaW5hdGVzO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZlxuICApIHt9XG5cbiAgdHJhY2tCeShpbmRleCkge1xuICAgIHJldHVybiBpbmRleDtcbiAgfVxuXG4gIG9uQ2xpY2socG9pbnQ6IFBvQ2hhcnRQb2ludHNDb29yZGluYXRlcykge1xuICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IHsgbGFiZWw6IHBvaW50LmxhYmVsLCBkYXRhOiBwb2ludC5kYXRhLCBjYXRlZ29yeTogcG9pbnQuY2F0ZWdvcnkgfTtcblxuICAgIHRoaXMucG9pbnRDbGljay5lbWl0KHNlbGVjdGVkSXRlbSk7XG4gIH1cblxuICBvbk1vdXNlRW50ZXIoZXZlbnQ6IGFueSwgcG9pbnQ6IFBvQ2hhcnRQb2ludHNDb29yZGluYXRlcykge1xuICAgIHRoaXMuc2V0UG9pbnRBdHRyaWJ1dGUoZXZlbnQudGFyZ2V0LCB0cnVlKTtcblxuICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IHsgbGFiZWw6IHBvaW50LmxhYmVsLCBkYXRhOiBwb2ludC5kYXRhLCBjYXRlZ29yeTogcG9pbnQuY2F0ZWdvcnkgfTtcbiAgICB0aGlzLnBvaW50SG92ZXIuZW1pdCh7IHJlbGF0aXZlVG86IHRoaXMucmVsYXRpdmVUbywgLi4uc2VsZWN0ZWRJdGVtIH0pO1xuICB9XG5cbiAgb25Nb3VzZUxlYXZlKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLnNldFBvaW50QXR0cmlidXRlKGV2ZW50LnRhcmdldCwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwbGF5UG9pbnRzV2l0aERlbGF5KFxuICAgIGNvb3JkaW5hdGVzOiBBcnJheTxQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXM+XG4gICk6IE9ic2VydmFibGU8QXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPj4ge1xuICAgIGlmICh0aGlzLmFuaW1hdGlvblN0YXRlICYmICFpc0lFKCkpIHtcbiAgICAgIGNvbnN0IGFuaW1hdGlvblRpbWVyID0gQU5JTUFUSU9OX0RVUkFUSU9OX1RJTUUgLyBjb29yZGluYXRlcy5sZW5ndGg7XG5cbiAgICAgIHJldHVybiBmcm9tKGNvb3JkaW5hdGVzKS5waXBlKFxuICAgICAgICBjb25jYXRNYXAoKGl0ZW0sIGluZGV4KSA9PiB0aW1lcihpbmRleCA9PT0gMCB8fCAhdGhpcy5hbmltYXRlID8gMCA6IGFuaW1hdGlvblRpbWVyKS5waXBlKG1hcFRvKGl0ZW0pKSksXG4gICAgICAgIHNjYW4oKGFjYywgY3VycjogUG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzKSA9PiBhY2MuY29uY2F0KGN1cnIpLCBbXSksXG4gICAgICAgIHRhcCgoKSA9PiAodGhpcy5hbmltYXRpb25TdGF0ZSA9IGZhbHNlKSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmcm9tKFtjb29yZGluYXRlc10pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0UG9pbnRBdHRyaWJ1dGUodGFyZ2V0OiBTVkdFbGVtZW50LCBpc0hvdmVyOiBib29sZWFuKSB7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGFyZ2V0LCAncicsIGlzSG92ZXIgPyBSQURJVVNfSE9WRVJfU0laRS50b1N0cmluZygpIDogUkFESVVTX0RFRkFVTFRfU0laRS50b1N0cmluZygpKTtcbiAgICBpZiAodGhpcy5jb2xvci5pbmNsdWRlcygncG8tY29sb3InKSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoXG4gICAgICAgIHRhcmdldCxcbiAgICAgICAgJ2NsYXNzJyxcbiAgICAgICAgaXNIb3ZlciA/IGAke3RoaXMuc3Ryb2tlQ29sb3J9ICR7dGhpcy5jb2xvcn1gIDogYHBvLWNoYXJ0LWxpbmUtcG9pbnQgcG8tY2hhcnQtYWN0aXZlLXBvaW50ICR7dGhpcy5zdHJva2VDb2xvcn1gXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbmRlcmVyW2lzSG92ZXIgPyAnc2V0U3R5bGUnIDogJ3JlbW92ZVN0eWxlJ10odGFyZ2V0LCAnZmlsbCcsIGlzSG92ZXIgPyB0aGlzLmNvbG9yIDogdW5kZWZpbmVkKTtcbiAgICB9XG4gIH1cbn1cbiIsIjxzdmc6Y2lyY2xlICpuZ0Zvcj1cImxldCBpdGVtIG9mIGNvb3JkaW5hdGVzJCB8IGFzeW5jOyB0cmFja0J5OiB0cmFja0J5XCIgXG4gIFtwLXRvb2x0aXBdPVwiaXRlbS50b29sdGlwTGFiZWxcIlxuICBbcC1hcHBlbmQtaW4tYm9keV09J3RydWUnXG4gIFtwLWRpc3BsYXktdG9vbHRpcF09XCIhY2hhcnRMaW5lICYmIGl0ZW0uaXNBY3RpdmVcIlxuICBwLXRvb2x0aXAtcG9zaXRpb249XCJ0b3BcIlxuICBjbGFzcz1cInBvLWNoYXJ0LWxpbmUtcG9pbnRcIlxuICBbY2xhc3NdPVwic3Ryb2tlQ29sb3I/LmluY2x1ZGVzKCdwby1ib3JkZXItY29sb3InKSA/IHN0cm9rZUNvbG9yIDogJydcIlxuICBbY2xhc3MucG8tY2hhcnQtYWN0aXZlLXBvaW50XT1cIml0ZW0uaXNBY3RpdmVcIlxuICBbYXR0ci5jeF09XCJpdGVtLnhDb29yZGluYXRlXCJcbiAgW2F0dHIuY3ldPVwiaXRlbS55Q29vcmRpbmF0ZVwiXG4gIFthdHRyLnJdPVwicmFkaXVzXCJcbiAgW2F0dHIuc3Ryb2tlXT1cInN0cm9rZUNvbG9yXCJcbiAgKGNsaWNrKT1cIm9uQ2xpY2soaXRlbSlcIlxuICAobW91c2VlbnRlcik9XCJvbk1vdXNlRW50ZXIoJGV2ZW50LCBpdGVtKVwiXG4gIChtb3VzZWxlYXZlKT1cIm9uTW91c2VMZWF2ZSgkZXZlbnQpXCJcbiAgPlxuPC9zdmc6Y2lyY2xlPlxuIl19