import { Component, EventEmitter, Output, ViewChild } from '@angular/core';
import { isExternalLink, isIE } from '../../../../utils/util';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import * as i0 from "@angular/core";
import * as i1 from "./../../../../services/po-language/po-language.service";
import * as i2 from "@angular/forms";
import * as i3 from "../../../po-modal/po-modal.component";
import * as i4 from "../../po-input/po-input.component";
import * as i5 from "../../po-url/po-url.component";
const _c0 = ["modal"];
const _c1 = ["modalLinkForm"];
export class PoRichTextLinkModalComponent {
    languageService;
    modal;
    modalLinkForm;
    command = new EventEmitter();
    linkEditing = new EventEmitter();
    savedCursorPosition;
    selection = document.getSelection();
    urlLink;
    urlLinkText;
    literals;
    modalCancelAction;
    modalConfirmAction;
    isLinkEditing;
    isSelectedLink;
    linkElement;
    savedSelection;
    constructor(languageService) {
        this.languageService = languageService;
        this.literals = {
            ...poRichTextLiteralsDefault[this.languageService?.getShortLanguage()]
        };
    }
    ngOnInit() {
        this.setModalCancelAction();
        this.setModalConfirmAction();
    }
    linkConfirmAction() {
        return this.isLinkEditing ? this.literals.editLink : this.literals.insertLink;
    }
    formModelValidate() {
        return (this.modalConfirmAction.disabled = this.modalLinkForm?.invalid);
    }
    openModal(selectedLinkElement) {
        this.saveCursorPosition();
        this.prepareModalForLink(selectedLinkElement);
        this.modalConfirmAction.label = this.linkConfirmAction();
        this.modal.open();
    }
    selectedLink(linkElement) {
        this.isSelectedLink = !!linkElement;
        this.linkElement = linkElement;
    }
    checkIfIsEmpty(urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    }
    cleanUpFields() {
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.isLinkEditing = false;
        this.isSelectedLink = false;
        this.linkElement = undefined;
    }
    formReset(control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    }
    prepareModalForLink(selectedLinkElement) {
        this.saveSelectionText();
        if (this.modalLinkForm) {
            this.formReset(this.modalLinkForm.control);
        }
        setTimeout(() => {
            this.formModelValidate();
        });
        this.selectedLink(selectedLinkElement);
        if (this.isSelectedLink) {
            this.isLinkEditing = true;
            this.setLinkEditableForModal();
        }
        this.linkEditing.emit(this.isLinkEditing);
    }
    restoreSelection() {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    }
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
    saveSelectionText() {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    }
    setLinkEditableForModal() {
        this.urlLinkText = this.linkElement.innerText;
        this.urlLink = this.linkElement.getAttribute('href');
    }
    setModalCancelAction() {
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: () => {
                this.modal.close();
                this.command.emit();
                this.retrieveCursorPosition();
                this.cleanUpFields();
            }
        };
    }
    setModalConfirmAction() {
        this.modalConfirmAction = {
            label: this.linkConfirmAction(),
            disabled: true,
            action: () => (this.isLinkEditing ? this.toEditLink() : this.toInsertLink(this.urlLink, this.urlLinkText))
        };
    }
    toEditLink() {
        if (isIE()) {
            this.linkElement.parentNode.removeChild(this.linkElement);
        }
        else {
            this.linkElement.remove();
        }
        this.toInsertLink(this.urlLink, this.urlLinkText);
    }
    toInsertLink(urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        const urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        const urlAsExternalLink = isExternalLink(urlLink) ? urlLink : `http://${urlLink}`;
        const command = 'InsertHTML';
        const value = { urlLink: urlAsExternalLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command, value });
        this.cleanUpFields();
    }
    static ɵfac = function PoRichTextLinkModalComponent_Factory(t) { return new (t || PoRichTextLinkModalComponent)(i0.ɵɵdirectiveInject(i1.PoLanguageService)); };
    static ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: PoRichTextLinkModalComponent, selectors: [["po-rich-text-link-modal"]], viewQuery: function PoRichTextLinkModalComponent_Query(rf, ctx) { if (rf & 1) {
            i0.ɵɵviewQuery(_c0, 7);
            i0.ɵɵviewQuery(_c1, 5);
        } if (rf & 2) {
            let _t;
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modal = _t.first);
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modalLinkForm = _t.first);
        } }, outputs: { command: "p-command", linkEditing: "p-link-editing" }, decls: 7, vars: 9, consts: [["p-hide-close", "", 3, "p-primary-action", "p-secondary-action", "p-title"], ["modal", ""], ["modalLinkForm", "ngForm"], [1, "po-row"], ["name", "urlLinkText", "p-optional", "", 1, "po-md-12", "po-mb-2", 3, "ngModel", "p-label", "p-placeholder", "ngModelChange"], ["name", "urlLink", "p-label", "Link", "p-required", "", 1, "po-md-12", 3, "ngModel", "p-help", "p-placeholder", "ngModelChange", "p-change-model"]], template: function PoRichTextLinkModalComponent_Template(rf, ctx) { if (rf & 1) {
            i0.ɵɵelementStart(0, "po-modal", 0, 1)(2, "form", null, 2)(4, "div", 3)(5, "po-input", 4);
            i0.ɵɵtwoWayListener("ngModelChange", function PoRichTextLinkModalComponent_Template_po_input_ngModelChange_5_listener($event) { i0.ɵɵtwoWayBindingSet(ctx.urlLinkText, $event) || (ctx.urlLinkText = $event); return $event; });
            i0.ɵɵelementEnd();
            i0.ɵɵelementStart(6, "po-url", 5);
            i0.ɵɵtwoWayListener("ngModelChange", function PoRichTextLinkModalComponent_Template_po_url_ngModelChange_6_listener($event) { i0.ɵɵtwoWayBindingSet(ctx.urlLink, $event) || (ctx.urlLink = $event); return $event; });
            i0.ɵɵlistener("p-change-model", function PoRichTextLinkModalComponent_Template_po_url_p_change_model_6_listener() { return ctx.formModelValidate(); });
            i0.ɵɵelementEnd()()()();
        } if (rf & 2) {
            i0.ɵɵproperty("p-primary-action", ctx.modalConfirmAction)("p-secondary-action", ctx.modalCancelAction)("p-title", ctx.linkConfirmAction());
            i0.ɵɵadvance(5);
            i0.ɵɵtwoWayProperty("ngModel", ctx.urlLinkText);
            i0.ɵɵproperty("p-label", ctx.literals.linkTextLabel)("p-placeholder", ctx.literals.linkTextLabel);
            i0.ɵɵadvance();
            i0.ɵɵtwoWayProperty("ngModel", ctx.urlLink);
            i0.ɵɵproperty("p-help", ctx.literals.linkUrlTextHelper)("p-placeholder", ctx.literals.linkUrlTextPlaceholder);
        } }, dependencies: [i2.ɵNgNoValidate, i2.NgControlStatus, i2.NgControlStatusGroup, i2.NgModel, i2.NgForm, i3.PoModalComponent, i4.PoInputComponent, i5.PoUrlComponent], encapsulation: 2 });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoRichTextLinkModalComponent, [{
        type: Component,
        args: [{ selector: 'po-rich-text-link-modal', template: "<po-modal\n  #modal\n  p-hide-close\n  [p-primary-action]=\"modalConfirmAction\"\n  [p-secondary-action]=\"modalCancelAction\"\n  [p-title]=\"linkConfirmAction()\"\n>\n  <form #modalLinkForm=\"ngForm\">\n    <div class=\"po-row\">\n      <po-input\n        class=\"po-md-12 po-mb-2\"\n        name=\"urlLinkText\"\n        [(ngModel)]=\"urlLinkText\"\n        p-optional\n        [p-label]=\"literals.linkTextLabel\"\n        [p-placeholder]=\"literals.linkTextLabel\"\n      >\n      </po-input>\n\n      <po-url\n        class=\"po-md-12\"\n        name=\"urlLink\"\n        [(ngModel)]=\"urlLink\"\n        p-label=\"Link\"\n        p-required\n        [p-help]=\"literals.linkUrlTextHelper\"\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\n        (p-change-model)=\"formModelValidate()\"\n      >\n      </po-url>\n    </div>\n  </form>\n</po-modal>\n" }]
    }], () => [{ type: i1.PoLanguageService }], { modal: [{
            type: ViewChild,
            args: ['modal', { static: true }]
        }], modalLinkForm: [{
            type: ViewChild,
            args: ['modalLinkForm']
        }], command: [{
            type: Output,
            args: ['p-command']
        }], linkEditing: [{
            type: Output,
            args: ['p-link-editing']
        }] }); })();
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassDebugInfo(PoRichTextLinkModalComponent, { className: "PoRichTextLinkModalComponent", filePath: "lib/components/po-field/po-rich-text/po-rich-text-link-modal/po-rich-text-link-modal.component.ts", lineNumber: 14 }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWxpbmstbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXJpY2gtdGV4dC9wby1yaWNoLXRleHQtbGluay1tb2RhbC9wby1yaWNoLXRleHQtbGluay1tb2RhbC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1saW5rLW1vZGFsL3BvLXJpY2gtdGV4dC1saW5rLW1vZGFsLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQWMsWUFBWSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFHL0YsT0FBTyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7O0FBTXJFLE1BQU0sT0FBTyw0QkFBNEI7SUF3Qm5CO0lBdkJrQixLQUFLLENBQW1CO0lBRWxDLGFBQWEsQ0FBUztJQUU3QixPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQXFELENBQUM7SUFFM0UsV0FBVyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7SUFFaEUsbUJBQW1CLENBQUM7SUFDcEIsU0FBUyxHQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNwQyxPQUFPLENBQVM7SUFDaEIsV0FBVyxDQUFTO0lBRVgsUUFBUSxDQUFNO0lBRXZCLGlCQUFpQixDQUFnQjtJQUNqQyxrQkFBa0IsQ0FBZ0I7SUFFMUIsYUFBYSxDQUFVO0lBQ3ZCLGNBQWMsQ0FBVTtJQUN4QixXQUFXLENBQU07SUFD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RXZlbnRFbWl0dGVyLCBPdXRwdXQsIFZpZXdDaGlsZCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgaXNFeHRlcm5hbExpbmssIGlzSUUgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcblxuaW1wb3J0IHsgUG9Nb2RhbEFjdGlvbiwgUG9Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3BvLW1vZGFsJztcbmltcG9ydCB7IHBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHQgfSBmcm9tICcuLi9wby1yaWNoLXRleHQtbGl0ZXJhbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwby1yaWNoLXRleHQtbGluay1tb2RhbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1yaWNoLXRleHQtbGluay1tb2RhbC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9SaWNoVGV4dExpbmtNb2RhbENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBWaWV3Q2hpbGQoJ21vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWw6IFBvTW9kYWxDb21wb25lbnQ7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxMaW5rRm9ybScpIG1vZGFsTGlua0Zvcm06IE5nRm9ybTtcblxuICBAT3V0cHV0KCdwLWNvbW1hbmQnKSBjb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCB7IGNvbW1hbmQ6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB8IGFueSB9PigpO1xuXG4gIEBPdXRwdXQoJ3AtbGluay1lZGl0aW5nJykgbGlua0VkaXRpbmcgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBzYXZlZEN1cnNvclBvc2l0aW9uO1xuICBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcbiAgdXJsTGluazogc3RyaW5nO1xuICB1cmxMaW5rVGV4dDogc3RyaW5nO1xuXG4gIHJlYWRvbmx5IGxpdGVyYWxzOiBhbnk7XG5cbiAgbW9kYWxDYW5jZWxBY3Rpb246IFBvTW9kYWxBY3Rpb247XG4gIG1vZGFsQ29uZmlybUFjdGlvbjogUG9Nb2RhbEFjdGlvbjtcblxuICBwcml2YXRlIGlzTGlua0VkaXRpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgaXNTZWxlY3RlZExpbms6IGJvb2xlYW47XG4gIHByaXZhdGUgbGlua0VsZW1lbnQ6IGFueTtcbiAgcHJpdmF0ZSBzYXZlZFNlbGVjdGlvbjogUmFuZ2UgfCBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZSkge1xuICAgIHRoaXMubGl0ZXJhbHMgPSB7XG4gICAgICAuLi5wb1JpY2hUZXh0TGl0ZXJhbHNEZWZhdWx0W3RoaXMubGFuZ3VhZ2VTZXJ2aWNlPy5nZXRTaG9ydExhbmd1YWdlKCldXG4gICAgfTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuc2V0TW9kYWxDYW5jZWxBY3Rpb24oKTtcbiAgICB0aGlzLnNldE1vZGFsQ29uZmlybUFjdGlvbigpO1xuICB9XG5cbiAgbGlua0NvbmZpcm1BY3Rpb24oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5pc0xpbmtFZGl0aW5nID8gdGhpcy5saXRlcmFscy5lZGl0TGluayA6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0TGluaztcbiAgfVxuXG4gIGZvcm1Nb2RlbFZhbGlkYXRlKCkge1xuICAgIHJldHVybiAodGhpcy5tb2RhbENvbmZpcm1BY3Rpb24uZGlzYWJsZWQgPSB0aGlzLm1vZGFsTGlua0Zvcm0/LmludmFsaWQpO1xuICB9XG5cbiAgb3Blbk1vZGFsKHNlbGVjdGVkTGlua0VsZW1lbnQ6IEVsZW1lbnRSZWYpIHtcbiAgICB0aGlzLnNhdmVDdXJzb3JQb3NpdGlvbigpO1xuICAgIHRoaXMucHJlcGFyZU1vZGFsRm9yTGluayhzZWxlY3RlZExpbmtFbGVtZW50KTtcblxuICAgIHRoaXMubW9kYWxDb25maXJtQWN0aW9uLmxhYmVsID0gdGhpcy5saW5rQ29uZmlybUFjdGlvbigpO1xuICAgIHRoaXMubW9kYWwub3BlbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RlZExpbmsobGlua0VsZW1lbnQ6IEVsZW1lbnRSZWYpIHtcbiAgICB0aGlzLmlzU2VsZWN0ZWRMaW5rID0gISFsaW5rRWxlbWVudDtcbiAgICB0aGlzLmxpbmtFbGVtZW50ID0gbGlua0VsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrSWZJc0VtcHR5KHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xuICAgIHJldHVybiB1cmxMaW5rVGV4dCA9PT0gdW5kZWZpbmVkIHx8IHVybExpbmtUZXh0LnRyaW0oKSA9PT0gJycgPyB1cmxMaW5rIDogdXJsTGlua1RleHQ7XG4gIH1cblxuICBwcml2YXRlIGNsZWFuVXBGaWVsZHMoKSB7XG4gICAgdGhpcy51cmxMaW5rID0gdW5kZWZpbmVkO1xuICAgIHRoaXMudXJsTGlua1RleHQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gZmFsc2U7XG4gICAgdGhpcy5pc1NlbGVjdGVkTGluayA9IGZhbHNlO1xuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGZvcm1SZXNldChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpIHtcbiAgICBjb250cm9sLm1hcmtBc1ByaXN0aW5lKCk7XG4gICAgY29udHJvbC5tYXJrQXNVbnRvdWNoZWQoKTtcbiAgICBjb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZU1vZGFsRm9yTGluayhzZWxlY3RlZExpbmtFbGVtZW50OiBFbGVtZW50UmVmKSB7XG4gICAgdGhpcy5zYXZlU2VsZWN0aW9uVGV4dCgpO1xuICAgIGlmICh0aGlzLm1vZGFsTGlua0Zvcm0pIHtcbiAgICAgIHRoaXMuZm9ybVJlc2V0KHRoaXMubW9kYWxMaW5rRm9ybS5jb250cm9sKTtcbiAgICB9XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuZm9ybU1vZGVsVmFsaWRhdGUoKTtcbiAgICB9KTtcblxuICAgIHRoaXMuc2VsZWN0ZWRMaW5rKHNlbGVjdGVkTGlua0VsZW1lbnQpO1xuXG4gICAgaWYgKHRoaXMuaXNTZWxlY3RlZExpbmspIHtcbiAgICAgIHRoaXMuaXNMaW5rRWRpdGluZyA9IHRydWU7XG4gICAgICB0aGlzLnNldExpbmtFZGl0YWJsZUZvck1vZGFsKCk7XG4gICAgfVxuXG4gICAgdGhpcy5saW5rRWRpdGluZy5lbWl0KHRoaXMuaXNMaW5rRWRpdGluZyk7XG4gIH1cblxuICBwcml2YXRlIHJlc3RvcmVTZWxlY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuc2F2ZWRTZWxlY3Rpb24pIHtcbiAgICAgIGlmICh0aGlzLnNlbGVjdGlvbikge1xuICAgICAgICB0aGlzLnNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24uYWRkUmFuZ2UodGhpcy5zYXZlZFNlbGVjdGlvbik7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmV0cmlldmVDdXJzb3JQb3NpdGlvbigpIHtcbiAgICB0aGlzLnNlbGVjdGlvbi5jb2xsYXBzZSh0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb25bMF0sIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblsxXSk7XG4gIH1cblxuICBwcml2YXRlIHNhdmVDdXJzb3JQb3NpdGlvbigpIHtcbiAgICB0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb24gPSBbdGhpcy5zZWxlY3Rpb24uZm9jdXNOb2RlLCB0aGlzLnNlbGVjdGlvbi5mb2N1c09mZnNldF07XG4gIH1cblxuICBwcml2YXRlIHNhdmVTZWxlY3Rpb25UZXh0KCkge1xuICAgIGlmICh0aGlzLnNlbGVjdGlvbi5hbmNob3JOb2RlICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnNhdmVkU2VsZWN0aW9uID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKTtcbiAgICAgIHRoaXMudXJsTGlua1RleHQgPSB0aGlzLnNlbGVjdGlvbi50b1N0cmluZygpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldExpbmtFZGl0YWJsZUZvck1vZGFsKCkge1xuICAgIHRoaXMudXJsTGlua1RleHQgPSB0aGlzLmxpbmtFbGVtZW50LmlubmVyVGV4dDtcbiAgICB0aGlzLnVybExpbmsgPSB0aGlzLmxpbmtFbGVtZW50LmdldEF0dHJpYnV0ZSgnaHJlZicpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRNb2RhbENhbmNlbEFjdGlvbigpIHtcbiAgICB0aGlzLm1vZGFsQ2FuY2VsQWN0aW9uID0ge1xuICAgICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuY2FuY2VsLFxuICAgICAgYWN0aW9uOiAoKSA9PiB7XG4gICAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKTtcbiAgICAgICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHNldE1vZGFsQ29uZmlybUFjdGlvbigpIHtcbiAgICB0aGlzLm1vZGFsQ29uZmlybUFjdGlvbiA9IHtcbiAgICAgIGxhYmVsOiB0aGlzLmxpbmtDb25maXJtQWN0aW9uKCksXG4gICAgICBkaXNhYmxlZDogdHJ1ZSxcbiAgICAgIGFjdGlvbjogKCkgPT4gKHRoaXMuaXNMaW5rRWRpdGluZyA/IHRoaXMudG9FZGl0TGluaygpIDogdGhpcy50b0luc2VydExpbmsodGhpcy51cmxMaW5rLCB0aGlzLnVybExpbmtUZXh0KSlcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB0b0VkaXRMaW5rKCkge1xuICAgIGlmIChpc0lFKCkpIHtcbiAgICAgIHRoaXMubGlua0VsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmxpbmtFbGVtZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5saW5rRWxlbWVudC5yZW1vdmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLnRvSW5zZXJ0TGluayh0aGlzLnVybExpbmssIHRoaXMudXJsTGlua1RleHQpO1xuICB9XG5cbiAgcHJpdmF0ZSB0b0luc2VydExpbmsodXJsTGluaywgdXJsTGlua1RleHQpIHtcbiAgICB0aGlzLm1vZGFsLmNsb3NlKCk7XG4gICAgdGhpcy5yZXN0b3JlU2VsZWN0aW9uKCk7XG5cbiAgICBjb25zdCB1cmxMaW5rVGV4dFZhbHVlID0gdGhpcy5jaGVja0lmSXNFbXB0eSh1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG4gICAgY29uc3QgdXJsQXNFeHRlcm5hbExpbmsgPSBpc0V4dGVybmFsTGluayh1cmxMaW5rKSA/IHVybExpbmsgOiBgaHR0cDovLyR7dXJsTGlua31gO1xuXG4gICAgY29uc3QgY29tbWFuZDogc3RyaW5nID0gJ0luc2VydEhUTUwnO1xuXG4gICAgY29uc3QgdmFsdWUgPSB7IHVybExpbms6IHVybEFzRXh0ZXJuYWxMaW5rLCB1cmxMaW5rVGV4dDogdXJsTGlua1RleHRWYWx1ZSB9O1xuXG4gICAgdGhpcy5jb21tYW5kLmVtaXQoeyBjb21tYW5kLCB2YWx1ZSB9KTtcblxuICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICB9XG59XG4iLCI8cG8tbW9kYWxcbiAgI21vZGFsXG4gIHAtaGlkZS1jbG9zZVxuICBbcC1wcmltYXJ5LWFjdGlvbl09XCJtb2RhbENvbmZpcm1BY3Rpb25cIlxuICBbcC1zZWNvbmRhcnktYWN0aW9uXT1cIm1vZGFsQ2FuY2VsQWN0aW9uXCJcbiAgW3AtdGl0bGVdPVwibGlua0NvbmZpcm1BY3Rpb24oKVwiXG4+XG4gIDxmb3JtICNtb2RhbExpbmtGb3JtPVwibmdGb3JtXCI+XG4gICAgPGRpdiBjbGFzcz1cInBvLXJvd1wiPlxuICAgICAgPHBvLWlucHV0XG4gICAgICAgIGNsYXNzPVwicG8tbWQtMTIgcG8tbWItMlwiXG4gICAgICAgIG5hbWU9XCJ1cmxMaW5rVGV4dFwiXG4gICAgICAgIFsobmdNb2RlbCldPVwidXJsTGlua1RleHRcIlxuICAgICAgICBwLW9wdGlvbmFsXG4gICAgICAgIFtwLWxhYmVsXT1cImxpdGVyYWxzLmxpbmtUZXh0TGFiZWxcIlxuICAgICAgICBbcC1wbGFjZWhvbGRlcl09XCJsaXRlcmFscy5saW5rVGV4dExhYmVsXCJcbiAgICAgID5cbiAgICAgIDwvcG8taW5wdXQ+XG5cbiAgICAgIDxwby11cmxcbiAgICAgICAgY2xhc3M9XCJwby1tZC0xMlwiXG4gICAgICAgIG5hbWU9XCJ1cmxMaW5rXCJcbiAgICAgICAgWyhuZ01vZGVsKV09XCJ1cmxMaW5rXCJcbiAgICAgICAgcC1sYWJlbD1cIkxpbmtcIlxuICAgICAgICBwLXJlcXVpcmVkXG4gICAgICAgIFtwLWhlbHBdPVwibGl0ZXJhbHMubGlua1VybFRleHRIZWxwZXJcIlxuICAgICAgICBbcC1wbGFjZWhvbGRlcl09XCJsaXRlcmFscy5saW5rVXJsVGV4dFBsYWNlaG9sZGVyXCJcbiAgICAgICAgKHAtY2hhbmdlLW1vZGVsKT1cImZvcm1Nb2RlbFZhbGlkYXRlKClcIlxuICAgICAgPlxuICAgICAgPC9wby11cmw+XG4gICAgPC9kaXY+XG4gIDwvZm9ybT5cbjwvcG8tbW9kYWw+XG4iXX0=