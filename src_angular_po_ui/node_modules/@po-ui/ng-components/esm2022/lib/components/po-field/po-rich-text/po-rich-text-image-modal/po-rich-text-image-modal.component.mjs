import { Component, EventEmitter, Output, ViewChild } from '@angular/core';
import { convertImageToBase64 } from '../../../../utils/util';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import * as i0 from "@angular/core";
import * as i1 from "./../../../../services/po-language/po-language.service";
import * as i2 from "@angular/forms";
import * as i3 from "../../../po-modal/po-modal.component";
import * as i4 from "../../po-upload/po-upload.component";
import * as i5 from "../../po-url/po-url.component";
const _c0 = ["modal"];
const _c1 = ["modalImageForm"];
const _c2 = ["upload"];
const uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
export class PoRichTextImageModalComponent {
    languageService;
    modal;
    modalImageForm;
    upload;
    command = new EventEmitter();
    savedCursorPosition;
    selection = document.getSelection();
    uploadModel;
    uploadRestrictions = {
        allowedExtensions: uploadRestrictions
    };
    urlImage;
    literals;
    modalCancelAction;
    modalConfirmAction;
    get isUploadValid() {
        return !!(this.uploadModel && this.uploadModel.length);
    }
    get isUrlValid() {
        return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
    }
    constructor(languageService) {
        this.languageService = languageService;
        this.literals = {
            ...poRichTextLiteralsDefault[this.languageService.getShortLanguage()]
        };
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: () => {
                this.modal.close();
                this.command.emit();
                this.retrieveCursorPosition();
                this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: () => this.insertElementRef()
        };
    }
    openModal() {
        this.saveCursorPosition();
        this.modal.open();
    }
    cleanUpFields() {
        this.urlImage = undefined;
        this.uploadModel = undefined;
    }
    async convertToBase64() {
        if (this.isUploadValid) {
            const uploadImage = this.uploadModel[0].rawFile;
            return await convertImageToBase64(uploadImage);
        }
    }
    emitCommand(value) {
        let command;
        if (value) {
            command = 'insertImage';
            this.command.emit({ command, value });
        }
    }
    async insertElementRef() {
        let uploadImage;
        if (!this.urlImage) {
            uploadImage = await this.convertToBase64();
        }
        this.retrieveCursorPosition();
        this.modal.close();
        if (this.isUrlValid || this.isUploadValid) {
            this.emitCommand(this.urlImage || uploadImage);
        }
        this.cleanUpFields();
    }
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
    static ɵfac = function PoRichTextImageModalComponent_Factory(t) { return new (t || PoRichTextImageModalComponent)(i0.ɵɵdirectiveInject(i1.PoLanguageService)); };
    static ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: PoRichTextImageModalComponent, selectors: [["po-rich-text-image-modal"]], viewQuery: function PoRichTextImageModalComponent_Query(rf, ctx) { if (rf & 1) {
            i0.ɵɵviewQuery(_c0, 7);
            i0.ɵɵviewQuery(_c1, 5);
            i0.ɵɵviewQuery(_c2, 7);
        } if (rf & 2) {
            let _t;
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modal = _t.first);
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.modalImageForm = _t.first);
            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.upload = _t.first);
        } }, outputs: { command: "p-command" }, decls: 9, vars: 10, consts: [["p-hide-close", "", 3, "p-primary-action", "p-secondary-action", "p-title"], ["modal", ""], ["modalImageForm", "ngForm"], [1, "po-row"], ["name", "upload", "p-drag-drop-height", "160", "p-hide-restrictions-info", "", "p-hide-send-button", "", "p-url", "x", 1, "po-md-12", 3, "ngModel", "p-drag-drop", "p-disabled", "p-restrictions", "ngModelChange"], ["upload", ""], ["name", "url", 1, "po-md-12", "po-mt-3", 3, "ngModel", "p-label", "p-disabled", "ngModelChange"]], template: function PoRichTextImageModalComponent_Template(rf, ctx) { if (rf & 1) {
            i0.ɵɵelementStart(0, "po-modal", 0, 1)(2, "form", null, 2)(4, "div", 3)(5, "po-upload", 4, 5);
            i0.ɵɵtwoWayListener("ngModelChange", function PoRichTextImageModalComponent_Template_po_upload_ngModelChange_5_listener($event) { i0.ɵɵtwoWayBindingSet(ctx.uploadModel, $event) || (ctx.uploadModel = $event); return $event; });
            i0.ɵɵelementEnd()();
            i0.ɵɵelementStart(7, "div", 3)(8, "po-url", 6);
            i0.ɵɵtwoWayListener("ngModelChange", function PoRichTextImageModalComponent_Template_po_url_ngModelChange_8_listener($event) { i0.ɵɵtwoWayBindingSet(ctx.urlImage, $event) || (ctx.urlImage = $event); return $event; });
            i0.ɵɵelementEnd()()()();
        } if (rf & 2) {
            const _r0 = i0.ɵɵreference(1);
            i0.ɵɵproperty("p-primary-action", ctx.modalConfirmAction)("p-secondary-action", ctx.modalCancelAction)("p-title", ctx.literals.insertImage);
            i0.ɵɵadvance(5);
            i0.ɵɵtwoWayProperty("ngModel", ctx.uploadModel);
            i0.ɵɵproperty("p-drag-drop", !_r0.isHidden)("p-disabled", ctx.isUrlValid)("p-restrictions", ctx.uploadRestrictions);
            i0.ɵɵadvance(3);
            i0.ɵɵtwoWayProperty("ngModel", ctx.urlImage);
            i0.ɵɵproperty("p-label", ctx.literals.urlImage)("p-disabled", ctx.isUploadValid);
        } }, dependencies: [i2.ɵNgNoValidate, i2.NgControlStatus, i2.NgControlStatusGroup, i2.NgModel, i2.NgForm, i3.PoModalComponent, i4.PoUploadComponent, i5.PoUrlComponent], encapsulation: 2 });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoRichTextImageModalComponent, [{
        type: Component,
        args: [{ selector: 'po-rich-text-image-modal', template: "<po-modal\n  #modal\n  p-hide-close\n  [p-primary-action]=\"modalConfirmAction\"\n  [p-secondary-action]=\"modalCancelAction\"\n  [p-title]=\"literals.insertImage\"\n>\n  <form #modalImageForm=\"ngForm\">\n    <div class=\"po-row\">\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\n      <po-upload\n        #upload\n        class=\"po-md-12\"\n        name=\"upload\"\n        [(ngModel)]=\"uploadModel\"\n        p-drag-drop-height=\"160\"\n        p-hide-restrictions-info\n        p-hide-send-button\n        p-url=\"x\"\n        [p-drag-drop]=\"!modal.isHidden\"\n        [p-disabled]=\"isUrlValid\"\n        [p-restrictions]=\"uploadRestrictions\"\n      >\n      </po-upload>\n    </div>\n\n    <div class=\"po-row\">\n      <po-url\n        class=\"po-md-12 po-mt-3\"\n        name=\"url\"\n        [(ngModel)]=\"urlImage\"\n        [p-label]=\"literals.urlImage\"\n        [p-disabled]=\"isUploadValid\"\n      >\n      </po-url>\n    </div>\n  </form>\n</po-modal>\n" }]
    }], () => [{ type: i1.PoLanguageService }], { modal: [{
            type: ViewChild,
            args: ['modal', { static: true }]
        }], modalImageForm: [{
            type: ViewChild,
            args: ['modalImageForm']
        }], upload: [{
            type: ViewChild,
            args: ['upload', { static: true }]
        }], command: [{
            type: Output,
            args: ['p-command']
        }] }); })();
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassDebugInfo(PoRichTextImageModalComponent, { className: "PoRichTextImageModalComponent", filePath: "lib/components/po-field/po-rich-text/po-rich-text-image-modal/po-rich-text-image-modal.component.ts", lineNumber: 18 }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWltYWdlLW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1maWVsZC9wby1yaWNoLXRleHQvcG8tcmljaC10ZXh0LWltYWdlLW1vZGFsL3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbC9wby1yaWNoLXRleHQtaW1hZ2UtbW9kYWwuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7OztBQUlyRSxNQUFNLGtCQUFrQixHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBTTlGLE1BQU0sT0FBTyw2QkFBNkI7SUErQnBCO0lBOUJrQixLQUFLLENBQW1CO0lBRWpDLGNBQWMsQ0FBUztJQUViLE1BQU0sQ0FBb0I7SUFFNUMsT0FBTyxHQUFHLElBQUksWUFBWSxFQUFxRCxDQUFDO0lBRXJHLG1CQUFtQixDQUFDO0lBQ3BCLFNBQVMsR0FBRyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDcEMsV0FBVyxDQUFhO0lBQ3hCLGtCQUFrQixHQUE2QjtRQUM3QyxpQkFB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NUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLENBQUM7SUFFTyxrQkFBa0I7UUFDeEIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwRixDQUFDO3VGQXBHVSw2QkFBNkI7NkRBQTdCLDZCQUE2Qjs7Ozs7Ozs7OztZQ2pCMUMsc0NBTUMsb0JBQUEsYUFBQSxzQkFBQTtZQVFPLGlPQUF5QjtZQVMzQixpQkFBWSxFQUFBO1lBR2QsOEJBQW9CLGdCQUFBO1lBSWhCLHdOQUFzQjtZQUl4QixpQkFBUyxFQUFBLEVBQUEsRUFBQTs7O1lBL0JiLHlEQUF1Qyw2Q0FBQSxxQ0FBQTtZQVdqQyxlQUF5QjtZQUF6QiwrQ0FBeUI7WUFLekIsMkNBQStCLDhCQUFBLDBDQUFBO1lBVy9CLGVBQXNCO1lBQXRCLDRDQUFzQjtZQUN0QiwrQ0FBNkIsaUNBQUE7OztpRkRkeEIsNkJBQTZCO2NBSnpDLFNBQVM7MkJBQ0UsMEJBQTBCO2tEQUlFLEtBQUs7a0JBQTFDLFNBQVM7bUJBQUMsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtZQUVQLGNBQWM7a0JBQTFDLFNBQVM7bUJBQUMsZ0JBQWdCO1lBRVksTUFBTTtrQkFBNUMsU0FBUzttQkFBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO1lBRWhCLE9BQU87a0JBQTNCLE1BQU07bUJBQUMsV0FBVzs7a0ZBUFIsNkJBQTZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgY29udmVydEltYWdlVG9CYXNlNjQgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcblxuaW1wb3J0IHsgUG9Nb2RhbEFjdGlvbiwgUG9Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3BvLW1vZGFsJztcbmltcG9ydCB7IHBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHQgfSBmcm9tICcuLi9wby1yaWNoLXRleHQtbGl0ZXJhbHMnO1xuaW1wb3J0IHsgUG9VcGxvYWRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvcG8tdXBsb2FkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb1VwbG9hZEZpbGVSZXN0cmljdGlvbnMgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvaW50ZXJmYWNlcy9wby11cGxvYWQtZmlsZS1yZXN0cmljdGlvbi5pbnRlcmZhY2UnO1xuXG5jb25zdCB1cGxvYWRSZXN0cmljdGlvbnMgPSBbJy5hcG5nJywgJy5ibXAnLCAnLmdpZicsICcuaWNvJywgJy5qcGVnJywgJy5qcGcnLCAnLnBuZycsICcuc3ZnJ107XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1pbWFnZS1tb2RhbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1yaWNoLXRleHQtaW1hZ2UtbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvUmljaFRleHRJbWFnZU1vZGFsQ29tcG9uZW50IHtcbiAgQFZpZXdDaGlsZCgnbW9kYWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RhbDogUG9Nb2RhbENvbXBvbmVudDtcblxuICBAVmlld0NoaWxkKCdtb2RhbEltYWdlRm9ybScpIG1vZGFsSW1hZ2VGb3JtOiBOZ0Zvcm07XG5cbiAgQFZpZXdDaGlsZCgndXBsb2FkJywgeyBzdGF0aWM6IHRydWUgfSkgdXBsb2FkOiBQb1VwbG9hZENvbXBvbmVudDtcblxuICBAT3V0cHV0KCdwLWNvbW1hbmQnKSBjb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCB7IGNvbW1hbmQ6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB8IGFueSB9PigpO1xuXG4gIHNhdmVkQ3Vyc29yUG9zaXRpb247XG4gIHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xuICB1cGxvYWRNb2RlbDogQXJyYXk8YW55PjtcbiAgdXBsb2FkUmVzdHJpY3Rpb25zOiBQb1VwbG9hZEZpbGVSZXN0cmljdGlvbnMgPSB7XG4gICAgYWxsb3dlZEV4dGVuc2lvbnM6IHVwbG9hZFJlc3RyaWN0aW9uc1xuICB9O1xuICB1cmxJbWFnZTogc3RyaW5nO1xuXG4gIHJlYWRvbmx5IGxpdGVyYWxzOiBhbnk7XG5cbiAgbW9kYWxDYW5jZWxBY3Rpb246IFBvTW9kYWxBY3Rpb247XG5cbiAgbW9kYWxDb25maXJtQWN0aW9uOiBQb01vZGFsQWN0aW9uO1xuXG4gIGdldCBpc1VwbG9hZFZhbGlkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhISh0aGlzLnVwbG9hZE1vZGVsICYmIHRoaXMudXBsb2FkTW9kZWwubGVuZ3RoKTtcbiAgfVxuXG4gIGdldCBpc1VybFZhbGlkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMudXJsSW1hZ2UgJiYgdGhpcy5tb2RhbEltYWdlRm9ybSAmJiB0aGlzLm1vZGFsSW1hZ2VGb3JtLnZhbGlkO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IFBvTGFuZ3VhZ2VTZXJ2aWNlKSB7XG4gICAgdGhpcy5saXRlcmFscyA9IHtcbiAgICAgIC4uLnBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHRbdGhpcy5sYW5ndWFnZVNlcnZpY2UuZ2V0U2hvcnRMYW5ndWFnZSgpXVxuICAgIH07XG5cbiAgICB0aGlzLm1vZGFsQ2FuY2VsQWN0aW9uID0ge1xuICAgICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuY2FuY2VsLFxuICAgICAgYWN0aW9uOiAoKSA9PiB7XG4gICAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKTtcbiAgICAgICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm1vZGFsQ29uZmlybUFjdGlvbiA9IHtcbiAgICAgIGxhYmVsOiB0aGlzLmxpdGVyYWxzLmluc2VydCxcbiAgICAgIGRpc2FibGVkOiBmYWxzZSxcbiAgICAgIGFjdGlvbjogKCkgPT4gdGhpcy5pbnNlcnRFbGVtZW50UmVmKClcbiAgICB9O1xuICB9XG5cbiAgb3Blbk1vZGFsKCkge1xuICAgIHRoaXMuc2F2ZUN1cnNvclBvc2l0aW9uKCk7XG4gICAgdGhpcy5tb2RhbC5vcGVuKCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFuVXBGaWVsZHMoKSB7XG4gICAgdGhpcy51cmxJbWFnZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnVwbG9hZE1vZGVsID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjb252ZXJ0VG9CYXNlNjQoKSB7XG4gICAgaWYgKHRoaXMuaXNVcGxvYWRWYWxpZCkge1xuICAgICAgY29uc3QgdXBsb2FkSW1hZ2UgPSB0aGlzLnVwbG9hZE1vZGVsWzBdLnJhd0ZpbGU7XG4gICAgICByZXR1cm4gYXdhaXQgY29udmVydEltYWdlVG9CYXNlNjQodXBsb2FkSW1hZ2UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZW1pdENvbW1hbmQodmFsdWUpIHtcbiAgICBsZXQgY29tbWFuZDogc3RyaW5nO1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgY29tbWFuZCA9ICdpbnNlcnRJbWFnZSc7XG4gICAgICB0aGlzLmNvbW1hbmQuZW1pdCh7IGNvbW1hbmQsIHZhbHVlIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaW5zZXJ0RWxlbWVudFJlZigpIHtcbiAgICBsZXQgdXBsb2FkSW1hZ2U6IHN0cmluZztcblxuICAgIGlmICghdGhpcy51cmxJbWFnZSkge1xuICAgICAgdXBsb2FkSW1hZ2UgPSBhd2FpdCB0aGlzLmNvbnZlcnRUb0Jhc2U2NCgpO1xuICAgIH1cblxuICAgIHRoaXMucmV0cmlldmVDdXJzb3JQb3NpdGlvbigpO1xuICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcblxuICAgIGlmICh0aGlzLmlzVXJsVmFsaWQgfHwgdGhpcy5pc1VwbG9hZFZhbGlkKSB7XG4gICAgICB0aGlzLmVtaXRDb21tYW5kKHRoaXMudXJsSW1hZ2UgfHwgdXBsb2FkSW1hZ2UpO1xuICAgIH1cbiAgICB0aGlzLmNsZWFuVXBGaWVsZHMoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmV0cmlldmVDdXJzb3JQb3NpdGlvbigpIHtcbiAgICB0aGlzLnNlbGVjdGlvbi5jb2xsYXBzZSh0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb25bMF0sIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblsxXSk7XG4gIH1cblxuICBwcml2YXRlIHNhdmVDdXJzb3JQb3NpdGlvbigpIHtcbiAgICB0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb24gPSBbdGhpcy5zZWxlY3Rpb24uZm9jdXNOb2RlLCB0aGlzLnNlbGVjdGlvbi5mb2N1c09mZnNldF07XG4gIH1cbn1cbiIsIjxwby1tb2RhbFxuICAjbW9kYWxcbiAgcC1oaWRlLWNsb3NlXG4gIFtwLXByaW1hcnktYWN0aW9uXT1cIm1vZGFsQ29uZmlybUFjdGlvblwiXG4gIFtwLXNlY29uZGFyeS1hY3Rpb25dPVwibW9kYWxDYW5jZWxBY3Rpb25cIlxuICBbcC10aXRsZV09XCJsaXRlcmFscy5pbnNlcnRJbWFnZVwiXG4+XG4gIDxmb3JtICNtb2RhbEltYWdlRm9ybT1cIm5nRm9ybVwiPlxuICAgIDxkaXYgY2xhc3M9XCJwby1yb3dcIj5cbiAgICAgIDwhLS0gcG8tdXBsb2FkIGRlc2FiaWxpdGEgbyBkcmFnIGRyb3AgY2FzbyBuw6NvIHRlbmhhIHZhbG9yIGF0cmlidWlkbyBwYXJhIGEgcHJvcHJpZWRhZGUgcC11cmwgLS0+XG4gICAgICA8cG8tdXBsb2FkXG4gICAgICAgICN1cGxvYWRcbiAgICAgICAgY2xhc3M9XCJwby1tZC0xMlwiXG4gICAgICAgIG5hbWU9XCJ1cGxvYWRcIlxuICAgICAgICBbKG5nTW9kZWwpXT1cInVwbG9hZE1vZGVsXCJcbiAgICAgICAgcC1kcmFnLWRyb3AtaGVpZ2h0PVwiMTYwXCJcbiAgICAgICAgcC1oaWRlLXJlc3RyaWN0aW9ucy1pbmZvXG4gICAgICAgIHAtaGlkZS1zZW5kLWJ1dHRvblxuICAgICAgICBwLXVybD1cInhcIlxuICAgICAgICBbcC1kcmFnLWRyb3BdPVwiIW1vZGFsLmlzSGlkZGVuXCJcbiAgICAgICAgW3AtZGlzYWJsZWRdPVwiaXNVcmxWYWxpZFwiXG4gICAgICAgIFtwLXJlc3RyaWN0aW9uc109XCJ1cGxvYWRSZXN0cmljdGlvbnNcIlxuICAgICAgPlxuICAgICAgPC9wby11cGxvYWQ+XG4gICAgPC9kaXY+XG5cbiAgICA8ZGl2IGNsYXNzPVwicG8tcm93XCI+XG4gICAgICA8cG8tdXJsXG4gICAgICAgIGNsYXNzPVwicG8tbWQtMTIgcG8tbXQtM1wiXG4gICAgICAgIG5hbWU9XCJ1cmxcIlxuICAgICAgICBbKG5nTW9kZWwpXT1cInVybEltYWdlXCJcbiAgICAgICAgW3AtbGFiZWxdPVwibGl0ZXJhbHMudXJsSW1hZ2VcIlxuICAgICAgICBbcC1kaXNhYmxlZF09XCJpc1VwbG9hZFZhbGlkXCJcbiAgICAgID5cbiAgICAgIDwvcG8tdXJsPlxuICAgIDwvZGl2PlxuICA8L2Zvcm0+XG48L3BvLW1vZGFsPlxuIl19