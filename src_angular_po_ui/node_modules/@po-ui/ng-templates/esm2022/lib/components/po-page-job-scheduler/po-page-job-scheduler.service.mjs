import { HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class PoPageJobSchedulerService {
    http;
    headers = new HttpHeaders({
        'X-PO-SCREEN-LOCK': 'true'
    });
    endpoint = '/';
    constructor(http) {
        this.http = http;
    }
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    createResource(resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, newResouce, { headers: this.headers });
    }
    getHeadProcesses() {
        const headers = { 'X-PO-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    getParametersByProcess(processId) {
        return this.http
            .get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((resource) => resource.items));
    }
    // Busca um único recurso
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    getResource(id) {
        return this.http
            .get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map(resource => this.convertToJobSchedulerInternal(resource)));
    }
    // Atualiza um recurso
    updateResource(id, resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, newResouce, { headers: this.headers });
    }
    convertToJobScheduler(jobSchedulerInternal) {
        const jobScheduler = { ...jobSchedulerInternal };
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution = this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (jobSchedulerInternal.frequency && jobSchedulerInternal.frequency.type) {
            jobScheduler.rangeExecutions = {
                frequency: { ...jobSchedulerInternal.frequency }
            };
            if (jobSchedulerInternal.rangeLimitHour) {
                const splitRangeLimitHour = jobSchedulerInternal.rangeLimitHour.split(':');
                jobScheduler.rangeExecutions.rangeLimit = {
                    hour: parseInt(splitRangeLimitHour[0], 10),
                    minute: parseInt(splitRangeLimitHour[1], 10)
                };
            }
            if (jobSchedulerInternal.rangeLimitDay) {
                jobScheduler.rangeExecutions.rangeLimit = {
                    ...jobScheduler.rangeExecutions.rangeLimit,
                    day: jobSchedulerInternal.rangeLimitDay
                };
            }
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    convertToJobSchedulerInternal(jobScheduler = {}) {
        const jobSchedulerInternal = { ...jobScheduler };
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        if (jobScheduler.rangeExecutions) {
            jobSchedulerInternal.rangeLimitHour = `${jobScheduler.rangeExecutions.rangeLimit.hour < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.hour
                : jobScheduler.rangeExecutions.rangeLimit.hour}:${jobScheduler.rangeExecutions.rangeLimit.minute < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.minute
                : jobScheduler.rangeExecutions.rangeLimit.minute}`;
            jobSchedulerInternal.rangeLimitDay = jobScheduler.rangeExecutions.rangeLimit.day;
            jobSchedulerInternal.frequency = {
                type: jobScheduler.rangeExecutions.frequency.type,
                value: jobScheduler.rangeExecutions.frequency.value
            };
        }
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    convertToPeriodicity(value) {
        const newValue = {};
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    convertToPeriodicityInternal(value = {}) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    getCurrentHour(date) {
        const hours = addZero(date.getHours());
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    removeInvalidKeys(value, keys) {
        const invalidKeys = keys || [
            'periodicity',
            'hour',
            'minute',
            'day',
            'daysOfWeek',
            'dayOfMonth',
            'firstExecutionHour',
            'frequency',
            'rangeLimitHour',
            'rangeLimitDay'
        ];
        Object.keys(value).forEach(key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
            else if (key === 'rangeExecutions' && value['periodicity'] === 'single') {
                delete value[key];
            }
        });
    }
    replaceHourFirstExecution(date, time) {
        const firstExecutionDate = new Date(date);
        const timeSplited = time.split(':');
        const hours = parseInt(timeSplited[0], 10);
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    returnValidExecutionParameter(parameter) {
        const newParameter = { ...parameter };
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
    static ɵfac = function PoPageJobSchedulerService_Factory(t) { return new (t || PoPageJobSchedulerService)(i0.ɵɵinject(i1.HttpClient)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: PoPageJobSchedulerService, factory: PoPageJobSchedulerService.ɵfac });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoPageJobSchedulerService, [{
        type: Injectable
    }], () => [{ type: i1.HttpClient }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90ZW1wbGF0ZXMvc3JjL2xpYi9jb21wb25lbnRzL3BvLXBhZ2Utam9iLXNjaGVkdWxlci9wby1wYWdlLWpvYi1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsT0FBTyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7QUFPckUsTUFBTSxPQUFPLHlCQUF5QjtJQU9oQjtJQU5YLE9BQU8sR0FBZ0IsSUFBSSxXQUFXLENBQUM7UUFDOUMsa0JBQWtCLEVBQUUsTUFBTTtLQUMzQixDQUFDLENBQUM7SUFFSyxRQUFRLEdBQUcsR0FBRyxDQUFDO0lBRXZCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7SUFBRyxDQUFDO0lBRXhDLGdCQUFnQixDQUFDLFNBQWdDLEVBQUU7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsY0FBYyxDQUFDLFFBQVE7UUFDckIsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXhELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsVUFBVSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ25GLENBQUM7SUFFRCxn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UUFFdEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxZQUFZLEVBQUU7WUFDOUIsSUFBSSxZQUFZLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLFlBQVksQ0FBQyxHQUFHLENBQUMsS0FBSyxTQUFTLEVBQUU7Z0JBQ3ZFLE9BQU8sWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzFCO1NBQ0Y7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO21GQW5QVSx5QkFBeUI7Z0VBQXpCLHlCQUF5QixXQUF6Qix5QkFBeUI7O2lGQUF6Qix5QkFBeUI7Y0FEckMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGFkZFplcm8sIGNvbnZlcnREYXRlVG9JU09FeHRlbmRlZCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xuXG5pbXBvcnQgeyBQb0pvYlNjaGVkdWxlciB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1qb2Itc2NoZWR1bGVyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0pvYlNjaGVkdWxlckludGVybmFsIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLWpvYi1zY2hlZHVsZXItaW50ZXJuYWwuaW50ZXJmYWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBvUGFnZUpvYlNjaGVkdWxlclNlcnZpY2Uge1xuICByZWFkb25seSBoZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7XG4gICAgJ1gtUE8tU0NSRUVOLUxPQ0snOiAndHJ1ZSdcbiAgfSk7XG5cbiAgcHJpdmF0ZSBlbmRwb2ludCA9ICcvJztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHt9XG5cbiAgY29uZmlnU2VydmljZUFwaShjb25maWc6IHsgZW5kcG9pbnQ/OiBzdHJpbmcgfSA9IHt9KSB7XG4gICAgdGhpcy5lbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludDtcbiAgfVxuXG4gIC8vIENyaWEgdW0gcmVjdXJzb1xuICBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbmV3UmVzb3VjZSA9IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVyKHJlc291cmNlKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdChgJHt0aGlzLmVuZHBvaW50fWAsIG5ld1Jlc291Y2UsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgZ2V0SGVhZFByb2Nlc3NlcygpIHtcbiAgICBjb25zdCBoZWFkZXJzID0geyAnWC1QTy1Oby1FcnJvcic6ICd0cnVlJyB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5oZWFkKGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlc2AsIHsgaGVhZGVycyB9KTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHBhcmFtZXRyb3MgcGVsbyBwcm9jZXNzbyBpZFxuICBnZXRQYXJhbWV0ZXJzQnlQcm9jZXNzKHByb2Nlc3NJZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlcy8ke3Byb2Nlc3NJZH0vcGFyYW1ldGVyc2AsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXG4gICAgICAucGlwZShtYXAoKHJlc291cmNlOiB7IGl0ZW1zOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+IH0pID0+IHJlc291cmNlLml0ZW1zKSk7XG4gIH1cblxuICAvLyBCdXNjYSB1bSDDum5pY28gcmVjdXJzb1xuICBnZXRQcm9jZXNzKGlkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlcy8ke2lkfWAsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgdW1hIGxpc3RhIGRlIHByb2Nlc3Nvc1xuICBnZXRQcm9jZXNzZXMocGFyYW1zOiB7fSA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXNgLCB7IHBhcmFtcyB9KTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHVtIMO6bmljbyByZWN1cnNvXG4gIGdldFJlc291cmNlKGlkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxuICAgICAgLnBpcGUobWFwKHJlc291cmNlID0+IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVySW50ZXJuYWwocmVzb3VyY2UpKSk7XG4gIH1cblxuICAvLyBBdHVhbGl6YSB1bSByZWN1cnNvXG4gIHVwZGF0ZVJlc291cmNlKGlkLCByZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbmV3UmVzb3VjZSA9IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVyKHJlc291cmNlKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnB1dChgJHt0aGlzLmVuZHBvaW50fS8ke2lkfWAsIG5ld1Jlc291Y2UsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgY29udmVydFRvSm9iU2NoZWR1bGVyKGpvYlNjaGVkdWxlckludGVybmFsKTogUG9Kb2JTY2hlZHVsZXIge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlciA9IHsgLi4uam9iU2NoZWR1bGVySW50ZXJuYWwgfTtcblxuICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5wZXJpb2RpY2l0eSkge1xuICAgICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnBlcmlvZGljaXR5ID09PSAnc2luZ2xlJykge1xuICAgICAgICBqb2JTY2hlZHVsZXIucmVjdXJyZW50ID0gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3QuYXNzaWduKGpvYlNjaGVkdWxlciwgdGhpcy5jb252ZXJ0VG9QZXJpb2RpY2l0eShqb2JTY2hlZHVsZXJJbnRlcm5hbCkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbkhvdXIpIHtcbiAgICAgIGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbiA9IHRoaXMucmVwbGFjZUhvdXJGaXJzdEV4ZWN1dGlvbihcbiAgICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb24sXG4gICAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91clxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwuZnJlcXVlbmN5ICYmIGpvYlNjaGVkdWxlckludGVybmFsLmZyZXF1ZW5jeS50eXBlKSB7XG4gICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zID0ge1xuICAgICAgICBmcmVxdWVuY3k6IHsgLi4uam9iU2NoZWR1bGVySW50ZXJuYWwuZnJlcXVlbmN5IH1cbiAgICAgIH07XG5cbiAgICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5yYW5nZUxpbWl0SG91cikge1xuICAgICAgICBjb25zdCBzcGxpdFJhbmdlTGltaXRIb3VyID0gam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdEhvdXIuc3BsaXQoJzonKTtcblxuICAgICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQgPSB7XG4gICAgICAgICAgaG91cjogcGFyc2VJbnQoc3BsaXRSYW5nZUxpbWl0SG91clswXSwgMTApLFxuICAgICAgICAgIG1pbnV0ZTogcGFyc2VJbnQoc3BsaXRSYW5nZUxpbWl0SG91clsxXSwgMTApXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5yYW5nZUxpbWl0RGF5KSB7XG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdCA9IHtcbiAgICAgICAgICAuLi5qb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQsXG4gICAgICAgICAgZGF5OiBqb2JTY2hlZHVsZXJJbnRlcm5hbC5yYW5nZUxpbWl0RGF5XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFPYmplY3Qua2V5cyh0aGlzLnJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKGpvYlNjaGVkdWxlci5leGVjdXRpb25QYXJhbWV0ZXIpKS5sZW5ndGgpIHtcbiAgICAgIGRlbGV0ZSBqb2JTY2hlZHVsZXIuZXhlY3V0aW9uUGFyYW1ldGVyO1xuICAgIH1cblxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVyKTtcblxuICAgIHJldHVybiBqb2JTY2hlZHVsZXI7XG4gIH1cblxuICBjb252ZXJ0VG9Kb2JTY2hlZHVsZXJJbnRlcm5hbChqb2JTY2hlZHVsZXIgPSA8YW55Pnt9KTogUG9Kb2JTY2hlZHVsZXJJbnRlcm5hbCB7XG4gICAgY29uc3Qgam9iU2NoZWR1bGVySW50ZXJuYWwgPSB7IC4uLmpvYlNjaGVkdWxlciB9O1xuXG4gICAgaWYgKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbikge1xuICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyID0gdGhpcy5nZXRIb3VyRmlyc3RFeGVjdXRpb24oam9iU2NoZWR1bGVyLmZpcnN0RXhlY3V0aW9uKTtcbiAgICB9XG5cbiAgICBPYmplY3QuYXNzaWduKGpvYlNjaGVkdWxlckludGVybmFsLCB0aGlzLmNvbnZlcnRUb1BlcmlvZGljaXR5SW50ZXJuYWwoam9iU2NoZWR1bGVyKSk7XG5cbiAgICBpZiAoam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucykge1xuICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwucmFuZ2VMaW1pdEhvdXIgPSBgJHtcbiAgICAgICAgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LmhvdXIgPCAxMFxuICAgICAgICAgID8gJzAnICsgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LmhvdXJcbiAgICAgICAgICA6IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5ob3VyXG4gICAgICB9OiR7XG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5taW51dGUgPCAxMFxuICAgICAgICAgID8gJzAnICsgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0Lm1pbnV0ZVxuICAgICAgICAgIDogam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0Lm1pbnV0ZVxuICAgICAgfWA7XG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5yYW5nZUxpbWl0RGF5ID0gam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LmRheTtcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZyZXF1ZW5jeSA9IHtcbiAgICAgICAgdHlwZTogam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5mcmVxdWVuY3kudHlwZSxcbiAgICAgICAgdmFsdWU6IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMuZnJlcXVlbmN5LnZhbHVlXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVySW50ZXJuYWwsIFsnd2Vla2x5JywgJ21vbnRobHknLCAnZGFpbHknXSk7XG5cbiAgICByZXR1cm4gam9iU2NoZWR1bGVySW50ZXJuYWw7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb1BlcmlvZGljaXR5KHZhbHVlOiB7XG4gICAgcGVyaW9kaWNpdHk6IHN0cmluZztcbiAgICBkYXlPZk1vbnRoPzogc3RyaW5nO1xuICAgIGRheXNPZldlZWs/OiBudW1iZXI7XG4gICAgaG91cj86IHN0cmluZztcbiAgfSkge1xuICAgIGNvbnN0IG5ld1ZhbHVlID0ge307XG4gICAgY29uc3QgdmFsdWVQZXJpb2RpY2l0eSA9IHZhbHVlLnBlcmlvZGljaXR5O1xuXG4gICAgaWYgKHZhbHVlUGVyaW9kaWNpdHkpIHtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldID0ge307XG5cbiAgICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5ID09PSAnbW9udGhseScpIHtcbiAgICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uZGF5ID0gdmFsdWUuZGF5T2ZNb250aCA/IHBhcnNlSW50KHZhbHVlLmRheU9mTW9udGgsIDEwKSA6IDA7XG4gICAgICB9IGVsc2UgaWYgKHZhbHVlUGVyaW9kaWNpdHkgPT09ICd3ZWVrbHknKSB7XG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheXNPZldlZWsgPSB2YWx1ZS5kYXlzT2ZXZWVrO1xuICAgICAgfVxuXG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5ob3VyID0gdmFsdWUuaG91ciA/IHBhcnNlSW50KHZhbHVlLmhvdXIuc3BsaXQoJzonKVswXSwgMTApIDogMDtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLm1pbnV0ZSA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMV0sIDEwKSA6IDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1ZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKHZhbHVlID0gPGFueT57fSkge1xuICAgIGlmICh2YWx1ZS5tb250aGx5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ21vbnRobHknLFxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLm1vbnRobHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5tb250aGx5Lm1pbnV0ZSl9YCxcbiAgICAgICAgZGF5T2ZNb250aDogdmFsdWUubW9udGhseS5kYXlcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZS5kYWlseSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdkYWlseScsXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUuZGFpbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5kYWlseS5taW51dGUpfWBcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh2YWx1ZS53ZWVrbHkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBlcmlvZGljaXR5OiAnd2Vla2x5JyxcbiAgICAgICAgaG91cjogYCR7YWRkWmVybyh2YWx1ZS53ZWVrbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS53ZWVrbHkubWludXRlKX1gLFxuICAgICAgICBkYXlzT2ZXZWVrOiBbLi4udmFsdWUud2Vla2x5LmRheXNPZldlZWtdXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ3NpbmdsZSdcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50SG91cihkYXRlOiBEYXRlKTogc3RyaW5nIHtcbiAgICBjb25zdCBob3VycyA9IGFkZFplcm8oZGF0ZS5nZXRIb3VycygpKTtcbiAgICBjb25zdCBtaW51dGVzID0gYWRkWmVybyhkYXRlLmdldE1pbnV0ZXMoKSk7XG5cbiAgICByZXR1cm4gYCR7aG91cnN9OiR7bWludXRlc31gO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIb3VyRmlyc3RFeGVjdXRpb24oZmlyc3RFeGVjdXRpb25EYXRlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRIb3VyKG5ldyBEYXRlKGZpcnN0RXhlY3V0aW9uRGF0ZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVJbnZhbGlkS2V5cyh2YWx1ZTogb2JqZWN0LCBrZXlzPzogQXJyYXk8c3RyaW5nPikge1xuICAgIGNvbnN0IGludmFsaWRLZXlzID0ga2V5cyB8fCBbXG4gICAgICAncGVyaW9kaWNpdHknLFxuICAgICAgJ2hvdXInLFxuICAgICAgJ21pbnV0ZScsXG4gICAgICAnZGF5JyxcbiAgICAgICdkYXlzT2ZXZWVrJyxcbiAgICAgICdkYXlPZk1vbnRoJyxcbiAgICAgICdmaXJzdEV4ZWN1dGlvbkhvdXInLFxuICAgICAgJ2ZyZXF1ZW5jeScsXG4gICAgICAncmFuZ2VMaW1pdEhvdXInLFxuICAgICAgJ3JhbmdlTGltaXREYXknXG4gICAgXTtcblxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAoaW52YWxpZEtleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICBkZWxldGUgdmFsdWVba2V5XTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncmFuZ2VFeGVjdXRpb25zJyAmJiB2YWx1ZVsncGVyaW9kaWNpdHknXSA9PT0gJ3NpbmdsZScpIHtcbiAgICAgICAgZGVsZXRlIHZhbHVlW2tleV07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oZGF0ZTogc3RyaW5nLCB0aW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGZpcnN0RXhlY3V0aW9uRGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuXG4gICAgY29uc3QgdGltZVNwbGl0ZWQgPSB0aW1lLnNwbGl0KCc6Jyk7XG5cbiAgICBjb25zdCBob3VycyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzBdLCAxMCk7XG4gICAgY29uc3QgbWludXRlcyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzFdLCAxMCk7XG5cbiAgICBmaXJzdEV4ZWN1dGlvbkRhdGUuc2V0SG91cnMoaG91cnMsIG1pbnV0ZXMpO1xuXG4gICAgcmV0dXJuIGNvbnZlcnREYXRlVG9JU09FeHRlbmRlZChmaXJzdEV4ZWN1dGlvbkRhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXR1cm5WYWxpZEV4ZWN1dGlvblBhcmFtZXRlcihwYXJhbWV0ZXI6IG9iamVjdCkge1xuICAgIGNvbnN0IG5ld1BhcmFtZXRlciA9IHsgLi4ucGFyYW1ldGVyIH07XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBuZXdQYXJhbWV0ZXIpIHtcbiAgICAgIGlmIChuZXdQYXJhbWV0ZXIuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBuZXdQYXJhbWV0ZXJba2V5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRlbGV0ZSBuZXdQYXJhbWV0ZXJba2V5XTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3UGFyYW1ldGVyO1xuICB9XG59XG4iXX0=