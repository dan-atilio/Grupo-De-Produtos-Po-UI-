import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { generateRandomId, valueIsNull } from '../../../util';
import * as i0 from "@angular/core";
export class ProJsToAdvplService {
    constructor() { }
    hasDialog() {
        return (typeof dialog !== 'undefined' && typeof dialog.jsToAdvpl === 'function');
    }
    hasWebChannel() {
        return (typeof twebchannel !== 'undefined' &&
            typeof twebchannel.jsToAdvpl === 'function');
    }
    getWebChannel() {
        if (this.hasWebChannel()) {
            return twebchannel;
        }
        if (this.hasDialog()) {
            return dialog;
        }
    }
    jsToAdvpl(type, content) {
        const webChannel = this.getWebChannel();
        if (valueIsNull(webChannel)) {
            return false;
        }
        else {
            webChannel.jsToAdvpl(type, content);
            return true;
        }
    }
    /**
     * @description Método responsável por fechar app na camada advpl
     *
     * @param {string} value Valor que será enviado a camada advpl, sendo vazia ou force
     */
    AdvplCloseApp(value = '') {
        this.jsToAdvpl('close', value);
    }
    buildListener(id, callBack) {
        const webChannel = this.getWebChannel();
        if (webChannel && webChannel['eventTarget']) {
            webChannel['eventTarget'].addEventListener(id, callBack);
        }
    }
    buildObservable(callBack, options) {
        if (!options.receiveId && options.sendInfo && !options.sendInfo.content) {
            options.receiveId = options.sendInfo.type + '-' + this.generateEventId();
        }
        const buildedObservable = new Observable(subscriber => {
            const webChannel = this.getWebChannel();
            webChannel[options.receiveId] = {};
            webChannel[options.receiveId]['subscriber'] = subscriber;
            if (options.autoDestruct) {
                webChannel[options.receiveId]['autoDestruct'] = this.buildAutoDestruct(options.receiveId, callBack);
                webChannel['eventTarget'].addEventListener(options.receiveId, webChannel[options.receiveId]['autoDestruct']);
            }
            else {
                webChannel['eventTarget'].addEventListener(options.receiveId, callBack);
            }
        });
        if (options.sendInfo) {
            this.connectedJsToAdvpl(options.sendInfo.type, options.sendInfo.content ? options.sendInfo.content : options.receiveId);
        }
        return buildedObservable;
    }
    /**
     * @description Remove e apaga o evento
     * @param id ID do evento
     * @param callBack callback do evento
     * @returns
     */
    buildAutoDestruct(id, callBack) {
        return ({ protheusResponse, subscriber }) => {
            const webChannel = this.getWebChannel();
            callBack({ protheusResponse, subscriber });
            if (webChannel[id]) {
                webChannel['eventTarget'].removeEventListener(id, webChannel[id]['autoDestruct']);
                delete webChannel[id];
            }
        };
    }
    protheusConnected() {
        const webChannel = this.getWebChannel();
        return !valueIsNull(webChannel) && webChannel['gotConnection'];
    }
    connectedJsToAdvpl(type, value, retryCounter = 99, timeout = 50) {
        if (this.protheusConnected()) {
            this.jsToAdvpl(type, value);
        }
        else {
            if (retryCounter > 0) {
                retryCounter--;
                setTimeout(() => {
                    this.connectedJsToAdvpl(type, value, retryCounter, timeout);
                }, timeout);
            }
            else {
                console.log('jsToAdvpl type ' + type + ' not executed!');
            }
        }
    }
    generateEventId() {
        return generateRandomId();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProJsToAdvplService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProJsToAdvplService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProJsToAdvplService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvLWpzLXRvLWFkdnBsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9wcm90aGV1cy1saWItY29yZS9zcmMvc2VydmljZXMvcHJvLWpzLXRvLWFkdnBsL3NlcnZpY2VzL3Byby1qcy10by1hZHZwbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUdsQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDOztBQVE5RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLGdCQUFnQixDQUFDO0lBRWpCLFNBQVM7UUFDUCxPQUFPLENBQ0wsT0FBTyxNQUFNLEtBQUssV0FBVyxJQUFJLE9BQU8sTUFBTSxDQUFDLFNBQVMsS0FBSyxVQUFVLENBQ3hFLENBQUM7SUFDSixDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sQ0FDTCxPQUFPLFdBQVcsS0FBSyxXQUFXO1lBQ2xDLE9BQU8sV0FBVyxDQUFDLFNBQVMsS0FBSyxVQUFVLENBQzVDLENBQUM7SUFDSixDQUFDO0lBRUQsYUFBYTtRQUNYLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFO1lBQ3hCLE9BQU8sV0FBVyxDQUFDO1NBQ3BCO1FBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDcEIsT0FBTyxNQUFNLENBQUM7U0FDZjtJQUNILENBQUM7SUFFRCxTQUFTLENBQUMsSUFBWSxFQUFFLE9BQWU7UUFDckMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3hDLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7YUFBTTtZQUNMLFVBQVUsQ0FBQyxTQUFTLENB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QUNILENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxpQkFBaUI7UUFDZixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDeEMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVELGtCQUFrQixDQUNoQixJQUFZLEVBQ1osS0FBYSxFQUNiLGVBQXVCLEVBQUUsRUFDekIsVUFBa0IsRUFBRTtRQUVwQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxFQUFFO1lBQzVCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzdCO2FBQU07WUFDTCxJQUFJLFlBQVksR0FBRyxDQUFDLEVBQUU7Z0JBQ3BCLFlBQVksRUFBRSxDQUFDO2dCQUNmLFVBQVUsQ0FBQyxHQUFHLEVBQUU7b0JBQ2QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUM5RCxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDYjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDO2FBQzFEO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsZUFBZTtRQUNiLE9BQU8sZ0JBQWdCLEVBQUUsQ0FBQztJQUM1QixDQUFDOzhHQWxJVSxtQkFBbUI7a0hBQW5CLG1CQUFtQixjQUZsQixNQUFNOzsyRkFFUCxtQkFBbUI7a0JBSC9CLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBQcm9Kc1RvQWR2cGwgfSBmcm9tICcuLic7XHJcbmltcG9ydCB7IGdlbmVyYXRlUmFuZG9tSWQsIHZhbHVlSXNOdWxsIH0gZnJvbSAnLi4vLi4vLi4vdXRpbCc7XHJcblxyXG5kZWNsYXJlIHZhciBkaWFsb2c6IGFueTtcclxuZGVjbGFyZSB2YXIgdHdlYmNoYW5uZWw6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb0pzVG9BZHZwbFNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gIGhhc0RpYWxvZygpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIHR5cGVvZiBkaWFsb2cgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBkaWFsb2cuanNUb0FkdnBsID09PSAnZnVuY3Rpb24nXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgaGFzV2ViQ2hhbm5lbCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIHR5cGVvZiB0d2ViY2hhbm5lbCAhPT0gJ3VuZGVmaW5lZCcgJiZcclxuICAgICAgdHlwZW9mIHR3ZWJjaGFubmVsLmpzVG9BZHZwbCA9PT0gJ2Z1bmN0aW9uJ1xyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGdldFdlYkNoYW5uZWwoKSB7XHJcbiAgICBpZiAodGhpcy5oYXNXZWJDaGFubmVsKCkpIHtcclxuICAgICAgcmV0dXJuIHR3ZWJjaGFubmVsO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuaGFzRGlhbG9nKCkpIHtcclxuICAgICAgcmV0dXJuIGRpYWxvZztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGpzVG9BZHZwbCh0eXBlOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qgd2ViQ2hhbm5lbCA9IHRoaXMuZ2V0V2ViQ2hhbm5lbCgpO1xyXG4gICAgaWYgKHZhbHVlSXNOdWxsKHdlYkNoYW5uZWwpKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHdlYkNoYW5uZWwuanNUb0FkdnBsKHR5cGUsIGNvbnRlbnQpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBkZXNjcmlwdGlvbiBNw6l0b2RvIHJlc3BvbnPDoXZlbCBwb3IgZmVjaGFyIGFwcCBuYSBjYW1hZGEgYWR2cGxcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWxvciBxdWUgc2Vyw6EgZW52aWFkbyBhIGNhbWFkYSBhZHZwbCwgc2VuZG8gdmF6aWEgb3UgZm9yY2VcclxuICAgKi9cclxuICBBZHZwbENsb3NlQXBwKHZhbHVlOiBzdHJpbmcgPSAnJyk6IHZvaWQge1xyXG4gICAgdGhpcy5qc1RvQWR2cGwoJ2Nsb3NlJywgdmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgYnVpbGRMaXN0ZW5lcihpZDogc3RyaW5nLCBjYWxsQmFjayk6IHZvaWQge1xyXG4gICAgY29uc3Qgd2ViQ2hhbm5lbCA9IHRoaXMuZ2V0V2ViQ2hhbm5lbCgpO1xyXG4gICAgaWYgKHdlYkNoYW5uZWwgJiYgd2ViQ2hhbm5lbFsnZXZlbnRUYXJnZXQnXSkge1xyXG4gICAgICB3ZWJDaGFubmVsWydldmVudFRhcmdldCddLmFkZEV2ZW50TGlzdGVuZXIoaWQsIGNhbGxCYWNrKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGJ1aWxkT2JzZXJ2YWJsZTxUPihjYWxsQmFjaywgb3B0aW9uczogUHJvSnNUb0FkdnBsKSB7XHJcbiAgICBpZiAoIW9wdGlvbnMucmVjZWl2ZUlkICYmIG9wdGlvbnMuc2VuZEluZm8gJiYgIW9wdGlvbnMuc2VuZEluZm8uY29udGVudCkge1xyXG4gICAgICBvcHRpb25zLnJlY2VpdmVJZCA9IG9wdGlvbnMuc2VuZEluZm8udHlwZSArICctJyArIHRoaXMuZ2VuZXJhdGVFdmVudElkKCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBidWlsZGVkT2JzZXJ2YWJsZSA9IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xyXG4gICAgICBjb25zdCB3ZWJDaGFubmVsID0gdGhpcy5nZXRXZWJDaGFubmVsKCk7XHJcbiAgICAgIHdlYkNoYW5uZWxbb3B0aW9ucy5yZWNlaXZlSWRdID0ge307XHJcbiAgICAgIHdlYkNoYW5uZWxbb3B0aW9ucy5yZWNlaXZlSWRdWydzdWJzY3JpYmVyJ10gPSBzdWJzY3JpYmVyO1xyXG5cclxuICAgICAgaWYgKG9wdGlvbnMuYXV0b0Rlc3RydWN0KSB7XHJcbiAgICAgICAgd2ViQ2hhbm5lbFtvcHRpb25zLnJlY2VpdmVJZF1bJ2F1dG9EZXN0cnVjdCddID0gdGhpcy5idWlsZEF1dG9EZXN0cnVjdChcclxuICAgICAgICAgIG9wdGlvbnMucmVjZWl2ZUlkLFxyXG4gICAgICAgICAgY2FsbEJhY2tcclxuICAgICAgICApO1xyXG4gICAgICAgIHdlYkNoYW5uZWxbJ2V2ZW50VGFyZ2V0J10uYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgIG9wdGlvbnMucmVjZWl2ZUlkLFxyXG4gICAgICAgICAgd2ViQ2hhbm5lbFtvcHRpb25zLnJlY2VpdmVJZF1bJ2F1dG9EZXN0cnVjdCddXHJcbiAgICAgICAgKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB3ZWJDaGFubmVsWydldmVudFRhcmdldCddLmFkZEV2ZW50TGlzdGVuZXIob3B0aW9ucy5yZWNlaXZlSWQsIGNhbGxCYWNrKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZiAob3B0aW9ucy5zZW5kSW5mbykge1xyXG4gICAgICB0aGlzLmNvbm5lY3RlZEpzVG9BZHZwbChcclxuICAgICAgICBvcHRpb25zLnNlbmRJbmZvLnR5cGUsXHJcbiAgICAgICAgb3B0aW9ucy5zZW5kSW5mby5jb250ZW50ID8gb3B0aW9ucy5zZW5kSW5mby5jb250ZW50IDogb3B0aW9ucy5yZWNlaXZlSWRcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIHJldHVybiBidWlsZGVkT2JzZXJ2YWJsZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgZSBhcGFnYSBvIGV2ZW50b1xyXG4gICAqIEBwYXJhbSBpZCBJRCBkbyBldmVudG9cclxuICAgKiBAcGFyYW0gY2FsbEJhY2sgY2FsbGJhY2sgZG8gZXZlbnRvXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkQXV0b0Rlc3RydWN0KGlkLCBjYWxsQmFjaykge1xyXG4gICAgcmV0dXJuICh7IHByb3RoZXVzUmVzcG9uc2UsIHN1YnNjcmliZXIgfSkgPT4ge1xyXG4gICAgICBjb25zdCB3ZWJDaGFubmVsID0gdGhpcy5nZXRXZWJDaGFubmVsKCk7XHJcbiAgICAgIGNhbGxCYWNrKHsgcHJvdGhldXNSZXNwb25zZSwgc3Vic2NyaWJlciB9KTtcclxuXHJcbiAgICAgIGlmICh3ZWJDaGFubmVsW2lkXSkge1xyXG4gICAgICAgIHdlYkNoYW5uZWxbJ2V2ZW50VGFyZ2V0J10ucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgd2ViQ2hhbm5lbFtpZF1bJ2F1dG9EZXN0cnVjdCddXHJcbiAgICAgICAgKTtcclxuICAgICAgICBkZWxldGUgd2ViQ2hhbm5lbFtpZF07XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm90aGV1c0Nvbm5lY3RlZCgpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHdlYkNoYW5uZWwgPSB0aGlzLmdldFdlYkNoYW5uZWwoKTtcclxuICAgIHJldHVybiAhdmFsdWVJc051bGwod2ViQ2hhbm5lbCkgJiYgd2ViQ2hhbm5lbFsnZ290Q29ubmVjdGlvbiddO1xyXG4gIH1cclxuXHJcbiAgY29ubmVjdGVkSnNUb0FkdnBsKFxyXG4gICAgdHlwZTogc3RyaW5nLFxyXG4gICAgdmFsdWU6IHN0cmluZyxcclxuICAgIHJldHJ5Q291bnRlcjogbnVtYmVyID0gOTksXHJcbiAgICB0aW1lb3V0OiBudW1iZXIgPSA1MFxyXG4gICk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMucHJvdGhldXNDb25uZWN0ZWQoKSkge1xyXG4gICAgICB0aGlzLmpzVG9BZHZwbCh0eXBlLCB2YWx1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAocmV0cnlDb3VudGVyID4gMCkge1xyXG4gICAgICAgIHJldHJ5Q291bnRlci0tO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWRKc1RvQWR2cGwodHlwZSwgdmFsdWUsIHJldHJ5Q291bnRlciwgdGltZW91dCk7XHJcbiAgICAgICAgfSwgdGltZW91dCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2pzVG9BZHZwbCB0eXBlICcgKyB0eXBlICsgJyBub3QgZXhlY3V0ZWQhJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdlbmVyYXRlRXZlbnRJZCgpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIGdlbmVyYXRlUmFuZG9tSWQoKTtcclxuICB9XHJcbn1cclxuIl19