import { HttpHeaders, HttpParams } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../../../pro-js-to-advpl";
import * as i3 from "./../../pro-company/services/pro-company.service";
const CACHE_KEY = 'ProBranch';
export class ProBranchService {
    constructor(http, advplService, proCompanyService) {
        this.http = http;
        this.advplService = advplService;
        this.proCompanyService = proCompanyService;
        this.url = '/api/framework/environment/v1/branches';
        this.useHTTP = true;
        this.EVENT_SET_LIST_ID = 'setBranchesList';
        this.EVENT_GET_LIST_ID = 'getBranchesList';
        this.EVENT_SET_ONE_ID = 'setBranchInfo';
        this.EVENT_GET_ONE_ID = 'getBranchInfo';
    }
    getListOfBranches(Description = '', page = 1, _pageSize = 100) {
        const pageSize = 100;
        if (this.useHTTP) {
            return this.getListOfBranchesFromApi(Description, page, pageSize);
        }
        return this.getListOfBranchesFromAdvpl(Description, page, pageSize);
    }
    /**
     * @description Retorna as filiais do usuário
     * @param description string, descrição da filial
     * @param page number, número da página
     * @param pageSize number, número de registros da página
     * @returns ProBranchList, lista de filiais do usuário
     */
    getUserBranches(description = '', page = 1, pageSize = 10) {
        return this.getListOfBranchesFromApi(description, page, pageSize, false);
    }
    /**
     * @description Retorna as filiais do usuário via requisição http
     * @param description string, descrição da filial
     * @param page number, número da página
     * @param pageSize number, número de registros da página
     * @param isToFilterEnterpriseGroup boolean, indica se as filiais devem ser filtradas por empresa
     * @returns ProBranchList, lista de filiais do usuário
     */
    getListOfBranchesFromApi(Description, page, pageSize, isToFilterEnterpriseGroup = true) {
        let params = new HttpParams()
            .append('page', page.toString())
            .append('pageSize', pageSize.toString()); // Alterado o tamanho da página para melhorar a experiência do usuário.
        const company = this.proCompanyService.company;
        if (Description !== '') {
            params = params.append('Description', Description);
        }
        if (isToFilterEnterpriseGroup) {
            params = params.append('EnterpriseGroup', company.Code);
        }
        const headers = new HttpHeaders().append('Accept', 'application/json; charset=utf-8');
        return this.http.get(this.url, {
            headers,
            params
        });
    }
    getListOfBranchesFromAdvpl(Description, page, pageSize) {
        if (!this.advplService.protheusConnected()) {
            return this.advplNotPrepared();
        }
        const company = this.proCompanyService.company;
        const stringContent = JSON.stringify({
            Description,
            EnterpriseGroup: company.Code,
            page,
            pageSize
        });
        const observableParams = {
            sendInfo: {
                type: this.EVENT_GET_LIST_ID,
                content: stringContent
            },
            autoDestruct: true,
            receiveId: this.EVENT_SET_LIST_ID
        };
        const observableCallback = ({ protheusResponse, subscriber }) => {
            if (protheusResponse.length === 0) {
                subscriber.error({
                    status: 400,
                    description: `branch ${Description} could not be found`
                });
            }
            else {
                const branchesData = JSON.parse(protheusResponse);
                subscriber.next(branchesData);
            }
            subscriber.complete();
        };
        return this.advplService.buildObservable(observableCallback, observableParams);
    }
    getBranch(branch, company = '') {
        if (this.useHTTP) {
            return this.getBranchFromApi(branch, company);
        }
        return this.getBranchFromAdvpl(branch, company);
    }
    getBranchFromApi(branch, company) {
        if (company === '') {
            company = this.proCompanyService.company.Code;
        }
        const headers = new HttpHeaders().append('Accept', 'application/json; charset=utf-8');
        return this.http.get(`${this.url}/${company}|${branch}`, {
            headers
        });
    }
    getBranchFromAdvpl(branch, company) {
        if (!this.advplService.protheusConnected()) {
            return this.advplNotPrepared();
        }
        if (company === '') {
            company = this.proCompanyService.company.Code;
        }
        const stringContent = JSON.stringify({
            branch,
            company
        });
        const observableParams = {
            sendInfo: {
                type: this.EVENT_GET_ONE_ID,
                content: stringContent
            },
            autoDestruct: true,
            receiveId: this.EVENT_SET_ONE_ID
        };
        const observableCallback = ({ protheusResponse, subscriber }) => {
            let isOk = (protheusResponse.length > 0);
            const response = (isOk ? JSON.parse(protheusResponse) : {});
            isOk = (isOk && response && response.success);
            if (!isOk) {
                subscriber.error({
                    status: 400,
                    description: `branch ${branch} could not be found`
                });
            }
            else {
                const branchData = JSON.parse(response.payload);
                subscriber.next(branchData);
            }
            subscriber.complete();
        };
        return this.advplService.buildObservable(observableCallback, observableParams);
    }
    get branch() {
        if (sessionStorage[CACHE_KEY]) {
            return JSON.parse(sessionStorage[CACHE_KEY]);
        }
        else {
            return { Code: '', EnterpriseGroup: '', Description: '' };
        }
    }
    set branch(branch) {
        sessionStorage[CACHE_KEY] = JSON.stringify(branch);
    }
    advplNotPrepared() {
        return new Observable(subscriber => {
            subscriber.error({
                status: 400,
                description: 'advplService not prepared in ProBranchService'
            });
            subscriber.complete();
        });
    }
    isChannelHTTP() {
        return this.useHTTP;
    }
    setChannelAsHTTP(value) {
        this.useHTTP = value;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProBranchService, deps: [{ token: i1.HttpClient }, { token: i2.ProJsToAdvplService }, { token: i3.ProCompanyService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProBranchService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProBranchService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient }, { type: i2.ProJsToAdvplService }, { type: i3.ProCompanyService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvLWJyYW5jaC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcHJvdGhldXMtbGliLWNvcmUvc3JjL3NlcnZpY2VzL3Byby10ZW5hbnQvcHJvLWJyYW5jaC9zZXJ2aWNlcy9wcm8tYnJhbmNoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFjLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7Ozs7O0FBTWxDLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQztBQUs5QixNQUFNLE9BQU8sZ0JBQWdCO0lBUzNCLFlBQ1UsSUFBZ0IsRUFDaEIsWUFBaUMsRUFDakMsaUJBQW9DO1FBRnBDLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsaUJBQVksR0FBWixZQUFZLENBQXFCO1FBQ2pDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFYdEMsUUFBRyxHQUFHLHdDQUF3QyxDQUFDO1FBQy9DLFlBQU8sR0FBRyxJQUFJLENBQUM7UUFFUCxzQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztRQUN0QyxzQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztRQUN0QyxxQkFBZ0IsR0FBRyxlQUFlLENBQUM7UUFDbkMscUJBQWdCLEdBQUcsZUFBZSxDQUFDO0lBTS9DLENBQUM7SUFFTCxpQkFBaUIsQ0FDZixXQUFXLEdBQUcsRUFBRSxFQUNoQixJQUFJLEdBQUcsQ0FBQyxFQUNSLFNBQVMsR0FBRyxHQUFHO1FBRWYsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDO1FBQ3JCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ25FO1FBQ0QsT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsZUFBZSxDQUFDLGNBQXNCLEVBQUUsRUFBRSxPQUFlLENBQUMsRUFBRSxXQUFtQixFQUFFO1FBQy9FLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0ssd0JBQXdCLENBQzlCLFdBQW1CLEVBQ25CLElBQVksRUFDWixRQUFnQixFQUNoQiw0QkFBcUMsSUFBSTtRQUV6QyxJQUFJLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRTthQUMxQixNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUMvQixNQUFNLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsdUVBQXVFO1FBRW5ILE1BQU0sT0FBTyxHQUFlLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUM7UUFFM0QsSUFBSSxXQUFXLEtBQUssRUFBRSxFQUFFO1lBQ3RCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUNwRDtRQUVELElBQUkseUJBQXlCLEVBQUU7WUFDN0IsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3pEO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQ3RDLFFBQVEsRUFDUixpQ0FBaUMsQ0FDbEMsQ0FBQztRQUNGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQWdCLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDNUMsT0FBTztZQUNQLE1BQU07U0FDUCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sMEJBQTBCLENBQ2hDLFdBQVcsRUFDWCxJQUFJLEVBQ0osUUFBUTtRQUVSLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixFQUFFLEVBQUU7WUFDMUMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUNoQztRQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUM7UUFFL0MsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNuQyxXQUFXO1lBQ1gsZUFBZSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQzdCLElBQUk7WUFDSixRQUFRO1NBQ1QsQ0FBQyxDQUFDO1FBRUgsTUFBTSxnQkFBZ0IsR0FBRztZQUN2QixRQUFRLEVBQUU7Z0JBQ1IsSUFBSSxFQUFFLElBQUksQ0FBQyxpQkFBaUI7Z0JBQzVCLE9BQU8sRUFBRSxhQUFhO2FBQ3ZCO1lBQ0QsWUFBWSxFQUFFLElBQUk7WUFDbEIsU0FBUyxFQUFFLElBQUksQ0FBQyxpQkFBaUI7U0FDbEMsQ0FBQztRQUVGLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUU7WUFDOUQsSUFBSSxnQkFBZ0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNqQyxVQUFVLENBQUMsS0FBSyxDQUFDO29CQUNmLE1BQU0sRUFBRSxHQUFHO29CQUNYLFdBQVcsRUFBRSxVQUFVLFdBQVcscUJBQXFCO2lCQUN4RCxDQUFDLENBQUM7YUFDSjtpQkFBTTtnQkFDTCxNQUFNLFlBQVksR0FBa0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUNqRSxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQy9CO1lBQ0QsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3hCLENBQUMsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQ3RDLGtCQUFrQixFQUNsQixnQkFBZ0IsQ0FDakIsQ0FBQztJQUNKLENBQUM7SUFFRCxTQUFTLENBQUMsTUFBYyxFQUFFLE9BQU8sR0FBRyxFQUFFO1FBQ3BDLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDL0M7UUFDRCxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVPLGdCQUFnQixDQUFDLE1BQWMsRUFBRSxPQUFlO1FBQ3RELElBQUksT0FBTyxLQUFLLEVBQUUsRUFBRTtZQUNsQixPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7U0FDL0M7UUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDLE1BQU0sQ0FDdEMsUUFBUSxFQUNSLGlDQUFpQyxDQUNsQyxDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBWSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksT0FBTyxJQUFJLE1BQU0sRUFBRSxFQUFFO1lBQ2xFLE9BQU87U0FDUixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sa0JBQWtCLENBQUMsTUFBYyxFQUFFLE9BQWU7UUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtZQUMxQyxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ2hDO1FBRUQsSUFBSSxPQUFPLEtBQUssRUFBRSxFQUFFO1lBQ2xCLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztTQUMvQztRQUVELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkMsTUFBTTtZQUNOLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCxNQUFNLGdCQUFnQixHQUFHO1lBQ3ZCLFFBQVEsRUFBRTtnQkFDUixJQUFJLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtnQkFDM0IsT0FBTyxFQUFFLGFBQWE7YUFDdkI7WUFDRCxZQUFZLEVBQUUsSUFBSTtZQUNsQixTQUFTLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtTQUNqQyxDQUFDO1FBRUYsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRTtZQUM5RCxJQUFJLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUV6QyxNQUFNLFFBQVEsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM1RCxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksUUFBUSxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUU5QyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULFVBQVUsQ0FBQyxLQUFLLENBQUM7b0JBQ2YsTUFBTSxFQUFFLEdBQUc7b0JBQ1gsV0FBVyxFQUFFLFVBQVUsTUFBTSxxQkFBcUI7aUJBQ25ELENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLE1BQU0sVUFBVSxHQUFjLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUMzRCxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzdCO1lBQ0QsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3hCLENBQUMsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQ3RDLGtCQUFrQixFQUNsQixnQkFBZ0IsQ0FDakIsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLE1BQU07UUFDUixJQUFJLGNBQWMsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUM3QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7U0FDOUM7YUFBTTtZQUNMLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDO1NBQzNEO0lBQ0gsQ0FBQztJQUVELElBQUksTUFBTSxDQUFDLE1BQWlCO1FBQzFCLGNBQWMsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNqQyxVQUFVLENBQUMsS0FBSyxDQUFDO2dCQUNmLE1BQU0sRUFBRSxHQUFHO2dCQUNYLFdBQVcsRUFBRSwrQ0FBK0M7YUFDN0QsQ0FBQyxDQUFDO1lBQ0gsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGFBQWE7UUFDWCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVELGdCQUFnQixDQUFDLEtBQWM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQzs4R0F6TlUsZ0JBQWdCO2tIQUFoQixnQkFBZ0IsY0FGZixNQUFNOzsyRkFFUCxnQkFBZ0I7a0JBSDVCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJvQ29tcGFueSB9IGZyb20gJy4vLi4vLi4vcHJvLWNvbXBhbnkvbW9kZWxzL3Byby1jb21wYW55JztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMsIEh0dHBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgUHJvSnNUb0FkdnBsU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3Byby1qcy10by1hZHZwbCc7XHJcbmltcG9ydCB7IFByb0NvbXBhbnlTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi9wcm8tY29tcGFueS9zZXJ2aWNlcy9wcm8tY29tcGFueS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUHJvQnJhbmNoLCBQcm9CcmFuY2hMaXN0IH0gZnJvbSAnLi8uLi9tb2RlbHMvcHJvLWJyYW5jaCc7XHJcblxyXG5jb25zdCBDQUNIRV9LRVkgPSAnUHJvQnJhbmNoJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb0JyYW5jaFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgdXJsID0gJy9hcGkvZnJhbWV3b3JrL2Vudmlyb25tZW50L3YxL2JyYW5jaGVzJztcclxuICBwcml2YXRlIHVzZUhUVFAgPSB0cnVlO1xyXG5cclxuICBwdWJsaWMgcmVhZG9ubHkgRVZFTlRfU0VUX0xJU1RfSUQgPSAnc2V0QnJhbmNoZXNMaXN0JztcclxuICBwdWJsaWMgcmVhZG9ubHkgRVZFTlRfR0VUX0xJU1RfSUQgPSAnZ2V0QnJhbmNoZXNMaXN0JztcclxuICBwdWJsaWMgcmVhZG9ubHkgRVZFTlRfU0VUX09ORV9JRCA9ICdzZXRCcmFuY2hJbmZvJztcclxuICBwdWJsaWMgcmVhZG9ubHkgRVZFTlRfR0VUX09ORV9JRCA9ICdnZXRCcmFuY2hJbmZvJztcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICBwcml2YXRlIGFkdnBsU2VydmljZTogUHJvSnNUb0FkdnBsU2VydmljZSxcclxuICAgIHByaXZhdGUgcHJvQ29tcGFueVNlcnZpY2U6IFByb0NvbXBhbnlTZXJ2aWNlXHJcbiAgKSB7IH1cclxuXHJcbiAgZ2V0TGlzdE9mQnJhbmNoZXMoXHJcbiAgICBEZXNjcmlwdGlvbiA9ICcnLFxyXG4gICAgcGFnZSA9IDEsXHJcbiAgICBfcGFnZVNpemUgPSAxMDBcclxuICApOiBPYnNlcnZhYmxlPFByb0JyYW5jaExpc3Q+IHtcclxuICAgIGNvbnN0IHBhZ2VTaXplID0gMTAwO1xyXG4gICAgaWYgKHRoaXMudXNlSFRUUCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRMaXN0T2ZCcmFuY2hlc0Zyb21BcGkoRGVzY3JpcHRpb24sIHBhZ2UsIHBhZ2VTaXplKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmdldExpc3RPZkJyYW5jaGVzRnJvbUFkdnBsKERlc2NyaXB0aW9uLCBwYWdlLCBwYWdlU2l6ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAZGVzY3JpcHRpb24gUmV0b3JuYSBhcyBmaWxpYWlzIGRvIHVzdcOhcmlvXHJcbiAgICogQHBhcmFtIGRlc2NyaXB0aW9uIHN0cmluZywgZGVzY3Jpw6fDo28gZGEgZmlsaWFsXHJcbiAgICogQHBhcmFtIHBhZ2UgbnVtYmVyLCBuw7ptZXJvIGRhIHDDoWdpbmFcclxuICAgKiBAcGFyYW0gcGFnZVNpemUgbnVtYmVyLCBuw7ptZXJvIGRlIHJlZ2lzdHJvcyBkYSBww6FnaW5hXHJcbiAgICogQHJldHVybnMgUHJvQnJhbmNoTGlzdCwgbGlzdGEgZGUgZmlsaWFpcyBkbyB1c3XDoXJpb1xyXG4gICAqL1xyXG4gIGdldFVzZXJCcmFuY2hlcyhkZXNjcmlwdGlvbjogc3RyaW5nID0gJycsIHBhZ2U6IG51bWJlciA9IDEsIHBhZ2VTaXplOiBudW1iZXIgPSAxMCk6IE9ic2VydmFibGU8UHJvQnJhbmNoTGlzdD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0TGlzdE9mQnJhbmNoZXNGcm9tQXBpKGRlc2NyaXB0aW9uLCBwYWdlLCBwYWdlU2l6ZSwgZmFsc2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQGRlc2NyaXB0aW9uIFJldG9ybmEgYXMgZmlsaWFpcyBkbyB1c3XDoXJpbyB2aWEgcmVxdWlzacOnw6NvIGh0dHBcclxuICAgKiBAcGFyYW0gZGVzY3JpcHRpb24gc3RyaW5nLCBkZXNjcmnDp8OjbyBkYSBmaWxpYWxcclxuICAgKiBAcGFyYW0gcGFnZSBudW1iZXIsIG7Dum1lcm8gZGEgcMOhZ2luYVxyXG4gICAqIEBwYXJhbSBwYWdlU2l6ZSBudW1iZXIsIG7Dum1lcm8gZGUgcmVnaXN0cm9zIGRhIHDDoWdpbmFcclxuICAgKiBAcGFyYW0gaXNUb0ZpbHRlckVudGVycHJpc2VHcm91cCBib29sZWFuLCBpbmRpY2Egc2UgYXMgZmlsaWFpcyBkZXZlbSBzZXIgZmlsdHJhZGFzIHBvciBlbXByZXNhXHJcbiAgICogQHJldHVybnMgUHJvQnJhbmNoTGlzdCwgbGlzdGEgZGUgZmlsaWFpcyBkbyB1c3XDoXJpb1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TGlzdE9mQnJhbmNoZXNGcm9tQXBpKFxyXG4gICAgRGVzY3JpcHRpb246IHN0cmluZyxcclxuICAgIHBhZ2U6IG51bWJlcixcclxuICAgIHBhZ2VTaXplOiBudW1iZXIsXHJcbiAgICBpc1RvRmlsdGVyRW50ZXJwcmlzZUdyb3VwOiBib29sZWFuID0gdHJ1ZVxyXG4gICk6IE9ic2VydmFibGU8UHJvQnJhbmNoTGlzdD4ge1xyXG4gICAgbGV0IHBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKClcclxuICAgICAgLmFwcGVuZCgncGFnZScsIHBhZ2UudG9TdHJpbmcoKSlcclxuICAgICAgLmFwcGVuZCgncGFnZVNpemUnLCBwYWdlU2l6ZS50b1N0cmluZygpKTsgLy8gQWx0ZXJhZG8gbyB0YW1hbmhvIGRhIHDDoWdpbmEgcGFyYSBtZWxob3JhciBhIGV4cGVyacOqbmNpYSBkbyB1c3XDoXJpby5cclxuXHJcbiAgICBjb25zdCBjb21wYW55OiBQcm9Db21wYW55ID0gdGhpcy5wcm9Db21wYW55U2VydmljZS5jb21wYW55O1xyXG5cclxuICAgIGlmIChEZXNjcmlwdGlvbiAhPT0gJycpIHtcclxuICAgICAgcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgnRGVzY3JpcHRpb24nLCBEZXNjcmlwdGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGlzVG9GaWx0ZXJFbnRlcnByaXNlR3JvdXApIHtcclxuICAgICAgcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgnRW50ZXJwcmlzZUdyb3VwJywgY29tcGFueS5Db2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCkuYXBwZW5kKFxyXG4gICAgICAnQWNjZXB0JyxcclxuICAgICAgJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8UHJvQnJhbmNoTGlzdD4odGhpcy51cmwsIHtcclxuICAgICAgaGVhZGVycyxcclxuICAgICAgcGFyYW1zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0TGlzdE9mQnJhbmNoZXNGcm9tQWR2cGwoXHJcbiAgICBEZXNjcmlwdGlvbixcclxuICAgIHBhZ2UsXHJcbiAgICBwYWdlU2l6ZVxyXG4gICk6IE9ic2VydmFibGU8UHJvQnJhbmNoTGlzdD4ge1xyXG4gICAgaWYgKCF0aGlzLmFkdnBsU2VydmljZS5wcm90aGV1c0Nvbm5lY3RlZCgpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmFkdnBsTm90UHJlcGFyZWQoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb21wYW55ID0gdGhpcy5wcm9Db21wYW55U2VydmljZS5jb21wYW55O1xyXG5cclxuICAgIGNvbnN0IHN0cmluZ0NvbnRlbnQgPSBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgIERlc2NyaXB0aW9uLFxyXG4gICAgICBFbnRlcnByaXNlR3JvdXA6IGNvbXBhbnkuQ29kZSxcclxuICAgICAgcGFnZSxcclxuICAgICAgcGFnZVNpemVcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IG9ic2VydmFibGVQYXJhbXMgPSB7XHJcbiAgICAgIHNlbmRJbmZvOiB7XHJcbiAgICAgICAgdHlwZTogdGhpcy5FVkVOVF9HRVRfTElTVF9JRCxcclxuICAgICAgICBjb250ZW50OiBzdHJpbmdDb250ZW50XHJcbiAgICAgIH0sXHJcbiAgICAgIGF1dG9EZXN0cnVjdDogdHJ1ZSxcclxuICAgICAgcmVjZWl2ZUlkOiB0aGlzLkVWRU5UX1NFVF9MSVNUX0lEXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG9ic2VydmFibGVDYWxsYmFjayA9ICh7IHByb3RoZXVzUmVzcG9uc2UsIHN1YnNjcmliZXIgfSkgPT4ge1xyXG4gICAgICBpZiAocHJvdGhldXNSZXNwb25zZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBzdWJzY3JpYmVyLmVycm9yKHtcclxuICAgICAgICAgIHN0YXR1czogNDAwLFxyXG4gICAgICAgICAgZGVzY3JpcHRpb246IGBicmFuY2ggJHtEZXNjcmlwdGlvbn0gY291bGQgbm90IGJlIGZvdW5kYFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGJyYW5jaGVzRGF0YTogUHJvQnJhbmNoTGlzdCA9IEpTT04ucGFyc2UocHJvdGhldXNSZXNwb25zZSk7XHJcbiAgICAgICAgc3Vic2NyaWJlci5uZXh0KGJyYW5jaGVzRGF0YSk7XHJcbiAgICAgIH1cclxuICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5hZHZwbFNlcnZpY2UuYnVpbGRPYnNlcnZhYmxlPFByb0JyYW5jaExpc3Q+KFxyXG4gICAgICBvYnNlcnZhYmxlQ2FsbGJhY2ssXHJcbiAgICAgIG9ic2VydmFibGVQYXJhbXNcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRCcmFuY2goYnJhbmNoOiBzdHJpbmcsIGNvbXBhbnkgPSAnJyk6IE9ic2VydmFibGU8UHJvQnJhbmNoPiB7XHJcbiAgICBpZiAodGhpcy51c2VIVFRQKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldEJyYW5jaEZyb21BcGkoYnJhbmNoLCBjb21wYW55KTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmdldEJyYW5jaEZyb21BZHZwbChicmFuY2gsIGNvbXBhbnkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRCcmFuY2hGcm9tQXBpKGJyYW5jaDogc3RyaW5nLCBjb21wYW55OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb0JyYW5jaD4ge1xyXG4gICAgaWYgKGNvbXBhbnkgPT09ICcnKSB7XHJcbiAgICAgIGNvbXBhbnkgPSB0aGlzLnByb0NvbXBhbnlTZXJ2aWNlLmNvbXBhbnkuQ29kZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKS5hcHBlbmQoXHJcbiAgICAgICdBY2NlcHQnLFxyXG4gICAgICAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCdcclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxQcm9CcmFuY2g+KGAke3RoaXMudXJsfS8ke2NvbXBhbnl9fCR7YnJhbmNofWAsIHtcclxuICAgICAgaGVhZGVyc1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEJyYW5jaEZyb21BZHZwbChicmFuY2g6IHN0cmluZywgY29tcGFueTogc3RyaW5nKTogT2JzZXJ2YWJsZTxQcm9CcmFuY2g+IHtcclxuICAgIGlmICghdGhpcy5hZHZwbFNlcnZpY2UucHJvdGhldXNDb25uZWN0ZWQoKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5hZHZwbE5vdFByZXBhcmVkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNvbXBhbnkgPT09ICcnKSB7XHJcbiAgICAgIGNvbXBhbnkgPSB0aGlzLnByb0NvbXBhbnlTZXJ2aWNlLmNvbXBhbnkuQ29kZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdHJpbmdDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICBicmFuY2gsXHJcbiAgICAgIGNvbXBhbnlcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IG9ic2VydmFibGVQYXJhbXMgPSB7XHJcbiAgICAgIHNlbmRJbmZvOiB7XHJcbiAgICAgICAgdHlwZTogdGhpcy5FVkVOVF9HRVRfT05FX0lELFxyXG4gICAgICAgIGNvbnRlbnQ6IHN0cmluZ0NvbnRlbnRcclxuICAgICAgfSxcclxuICAgICAgYXV0b0Rlc3RydWN0OiB0cnVlLFxyXG4gICAgICByZWNlaXZlSWQ6IHRoaXMuRVZFTlRfU0VUX09ORV9JRFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBvYnNlcnZhYmxlQ2FsbGJhY2sgPSAoeyBwcm90aGV1c1Jlc3BvbnNlLCBzdWJzY3JpYmVyIH0pID0+IHtcclxuICAgICAgbGV0IGlzT2sgPSAocHJvdGhldXNSZXNwb25zZS5sZW5ndGggPiAwKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gKGlzT2sgPyBKU09OLnBhcnNlKHByb3RoZXVzUmVzcG9uc2UpIDoge30pO1xyXG4gICAgICBpc09rID0gKGlzT2sgJiYgcmVzcG9uc2UgJiYgcmVzcG9uc2Uuc3VjY2Vzcyk7XHJcblxyXG4gICAgICBpZiAoIWlzT2spIHtcclxuICAgICAgICBzdWJzY3JpYmVyLmVycm9yKHtcclxuICAgICAgICAgIHN0YXR1czogNDAwLFxyXG4gICAgICAgICAgZGVzY3JpcHRpb246IGBicmFuY2ggJHticmFuY2h9IGNvdWxkIG5vdCBiZSBmb3VuZGBcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBicmFuY2hEYXRhOiBQcm9CcmFuY2ggPSBKU09OLnBhcnNlKHJlc3BvbnNlLnBheWxvYWQpO1xyXG4gICAgICAgIHN1YnNjcmliZXIubmV4dChicmFuY2hEYXRhKTtcclxuICAgICAgfVxyXG4gICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiB0aGlzLmFkdnBsU2VydmljZS5idWlsZE9ic2VydmFibGU8UHJvQnJhbmNoPihcclxuICAgICAgb2JzZXJ2YWJsZUNhbGxiYWNrLFxyXG4gICAgICBvYnNlcnZhYmxlUGFyYW1zXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGJyYW5jaCgpOiBQcm9CcmFuY2gge1xyXG4gICAgaWYgKHNlc3Npb25TdG9yYWdlW0NBQ0hFX0tFWV0pIHtcclxuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2VbQ0FDSEVfS0VZXSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4geyBDb2RlOiAnJywgRW50ZXJwcmlzZUdyb3VwOiAnJywgRGVzY3JpcHRpb246ICcnIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXQgYnJhbmNoKGJyYW5jaDogUHJvQnJhbmNoKSB7XHJcbiAgICBzZXNzaW9uU3RvcmFnZVtDQUNIRV9LRVldID0gSlNPTi5zdHJpbmdpZnkoYnJhbmNoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWR2cGxOb3RQcmVwYXJlZDxUPigpOiBPYnNlcnZhYmxlPFQ+IHtcclxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShzdWJzY3JpYmVyID0+IHtcclxuICAgICAgc3Vic2NyaWJlci5lcnJvcih7XHJcbiAgICAgICAgc3RhdHVzOiA0MDAsXHJcbiAgICAgICAgZGVzY3JpcHRpb246ICdhZHZwbFNlcnZpY2Ugbm90IHByZXBhcmVkIGluIFByb0JyYW5jaFNlcnZpY2UnXHJcbiAgICAgIH0pO1xyXG4gICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGlzQ2hhbm5lbEhUVFAoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy51c2VIVFRQO1xyXG4gIH1cclxuXHJcbiAgc2V0Q2hhbm5lbEFzSFRUUCh2YWx1ZTogYm9vbGVhbikge1xyXG4gICAgdGhpcy51c2VIVFRQID0gdmFsdWU7XHJcbiAgfVxyXG59XHJcbiJdfQ==