import { HttpHeaders, HttpParams } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../../../pro-js-to-advpl";
const CACHE_KEY = 'ProCompany';
export class ProCompanyService {
    constructor(http, advplService) {
        this.http = http;
        this.advplService = advplService;
        this.url = '/api/framework/environment/v1/companies';
        this.useHTTP = true;
        this.EVENT_GET_LIST_ID = 'getCompaniesList';
        this.EVENT_SET_LIST_ID = 'setCompaniesList';
        this.EVENT_GET_ONE_ID = 'getCompanyInfo';
        this.EVENT_SET_ONE_ID = 'setCompanyInfo';
    }
    getListOfCompanies(CorporateName = '', page = 1, _pageSize = 100) {
        const pageSize = 100;
        if (this.useHTTP) {
            return this.getListOfCompaniesFromApi(CorporateName, page, pageSize);
        }
        return this.getListOfCompaniesFromAdvpl(CorporateName, page, pageSize);
    }
    /**
     * @description Retorna as empresas do usuário
     * @param corporateName string, nome da empresa
     * @param page number, número da página
     * @param pageSize number, número de registros da página
     * @returns ProCompanyList, lista de empresas do usuário
     */
    getUserCompanies(corporateName = '', page = 1, pageSize = 10) {
        return this.getListOfCompaniesFromApi(corporateName, page, pageSize);
    }
    getListOfCompaniesFromApi(CorporateName, page, pageSize) {
        let params = new HttpParams()
            .append('page', page.toString())
            .append('pageSize', pageSize.toString()); // Alterado o tamanho da página para melhorar a experiência do usuário.
        if (CorporateName !== '') {
            params = params.append('CorporateName', CorporateName);
        }
        const headers = new HttpHeaders().append('Accept', 'application/json; charset=utf-8');
        return this.http.get(this.url, {
            headers,
            params
        });
    }
    getListOfCompaniesFromAdvpl(CorporateName, page, pageSize) {
        if (!this.advplService.protheusConnected()) {
            return this.advplNotPrepared();
        }
        const stringContent = JSON.stringify({
            CorporateName,
            page,
            pageSize
        });
        const observableParameters = {
            sendInfo: {
                type: this.EVENT_GET_LIST_ID,
                content: stringContent
            },
            autoDestruct: true,
            receiveId: this.EVENT_SET_LIST_ID
        };
        const observableCallback = ({ protheusResponse, subscriber }) => {
            if (protheusResponse.length === 0) {
                subscriber.error({
                    status: 400,
                    description: `company ${CorporateName} could not be found`
                });
            }
            else {
                const companiesData = JSON.parse(protheusResponse);
                subscriber.next(companiesData);
            }
            subscriber.complete();
        };
        return this.advplService.buildObservable(observableCallback, observableParameters);
    }
    getCompany(company) {
        if (this.useHTTP) {
            return this.getCompanyFromApi(company);
        }
        return this.getCompanyFromAdvpl(company);
    }
    getCompanyFromApi(company) {
        const headers = new HttpHeaders().append('Accept', 'application/json; charset=utf-8');
        return this.http.get(`${this.url}/${company}`, { headers });
    }
    getCompanyFromAdvpl(company) {
        if (!this.advplService.protheusConnected()) {
            return this.advplNotPrepared();
        }
        return this.advplService.buildObservable(({ protheusResponse, subscriber }) => {
            if (protheusResponse.length === 0) {
                subscriber.error({
                    status: 400,
                    description: `company ${company} could not be found`
                });
            }
            else {
                const companyData = JSON.parse(protheusResponse);
                subscriber.next(companyData);
            }
            subscriber.complete();
        }, {
            sendInfo: {
                type: this.EVENT_GET_ONE_ID,
                content: company
            },
            autoDestruct: true,
            receiveId: this.EVENT_SET_ONE_ID
        });
    }
    get company() {
        if (sessionStorage[CACHE_KEY]) {
            return JSON.parse(sessionStorage[CACHE_KEY]);
        }
        else {
            return { Code: '', CorporateName: '', InternalId: '' };
        }
    }
    set company(company) {
        sessionStorage[CACHE_KEY] = JSON.stringify(company);
    }
    advplNotPrepared() {
        return new Observable(subscriber => {
            subscriber.error({
                status: 400,
                description: 'advplService not prepared in ProCompanyService'
            });
            subscriber.complete();
        });
    }
    isChannelHTTP() {
        return this.useHTTP;
    }
    setChannelAsHTTP(value) {
        this.useHTTP = value;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProCompanyService, deps: [{ token: i1.HttpClient }, { token: i2.ProJsToAdvplService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProCompanyService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProCompanyService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient }, { type: i2.ProJsToAdvplService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvLWNvbXBhbnkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3Byb3RoZXVzLWxpYi1jb3JlL3NyYy9zZXJ2aWNlcy9wcm8tdGVuYW50L3Byby1jb21wYW55L3NlcnZpY2VzL3Byby1jb21wYW55LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7Ozs7QUFLbEMsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO0FBSS9CLE1BQU0sT0FBTyxpQkFBaUI7SUFRNUIsWUFDVSxJQUFnQixFQUNoQixZQUFpQztRQURqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQVRuQyxRQUFHLEdBQUcseUNBQXlDLENBQUM7UUFDaEQsWUFBTyxHQUFHLElBQUksQ0FBQztRQUNQLHNCQUFpQixHQUFHLGtCQUFrQixDQUFDO1FBQ3ZDLHNCQUFpQixHQUFHLGtCQUFrQixDQUFDO1FBQ3ZDLHFCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3BDLHFCQUFnQixHQUFHLGdCQUFnQixDQUFDO0lBS2hELENBQUM7SUFFTCxrQkFBa0IsQ0FDaEIsYUFBYSxHQUFHLEVBQUUsRUFDbEIsSUFBSSxHQUFHLENBQUMsRUFDUixTQUFTLEdBQUcsR0FBRztRQUVmLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQztRQUNyQixJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsT0FBTyxJQUFJLENBQUMseUJBQXlCLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN0RTtRQUNELE9BQU8sSUFBSSxDQUFD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YUFBTTtZQUNMLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLGFBQWEsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDO1NBQ3hEO0lBQ0gsQ0FBQztJQUVELElBQUksT0FBTyxDQUFDLE9BQW1CO1FBQzdCLGNBQWMsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTyxnQkFBZ0I7UUFDdEIsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNqQyxVQUFVLENBQUMsS0FBSyxDQUFDO2dCQUNmLE1BQU0sRUFBRSxHQUFHO2dCQUNYLFdBQVcsRUFBRSxnREFBZ0Q7YUFDOUQsQ0FBQyxDQUFDO1lBQ0gsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGFBQWE7UUFDWCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVELGdCQUFnQixDQUFDLEtBQWM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQzs4R0EvS1UsaUJBQWlCO2tIQUFqQixpQkFBaUIsY0FGaEIsTUFBTTs7MkZBRVAsaUJBQWlCO2tCQUg3QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7IFByb0pzVG9BZHZwbFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9wcm8tanMtdG8tYWR2cGwnO1xyXG5pbXBvcnQgeyBQcm9Db21wYW55LCBQcm9Db21wYW55TGlzdCB9IGZyb20gJy4uL21vZGVscy9wcm8tY29tcGFueSc7XHJcblxyXG5jb25zdCBDQUNIRV9LRVkgPSAnUHJvQ29tcGFueSc7XHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb0NvbXBhbnlTZXJ2aWNlIHtcclxuICBwcml2YXRlIHVybCA9ICcvYXBpL2ZyYW1ld29yay9lbnZpcm9ubWVudC92MS9jb21wYW5pZXMnO1xyXG4gIHByaXZhdGUgdXNlSFRUUCA9IHRydWU7XHJcbiAgcHVibGljIHJlYWRvbmx5IEVWRU5UX0dFVF9MSVNUX0lEID0gJ2dldENvbXBhbmllc0xpc3QnO1xyXG4gIHB1YmxpYyByZWFkb25seSBFVkVOVF9TRVRfTElTVF9JRCA9ICdzZXRDb21wYW5pZXNMaXN0JztcclxuICBwdWJsaWMgcmVhZG9ubHkgRVZFTlRfR0VUX09ORV9JRCA9ICdnZXRDb21wYW55SW5mbyc7XHJcbiAgcHVibGljIHJlYWRvbmx5IEVWRU5UX1NFVF9PTkVfSUQgPSAnc2V0Q29tcGFueUluZm8nO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcclxuICAgIHByaXZhdGUgYWR2cGxTZXJ2aWNlOiBQcm9Kc1RvQWR2cGxTZXJ2aWNlXHJcbiAgKSB7IH1cclxuXHJcbiAgZ2V0TGlzdE9mQ29tcGFuaWVzKFxyXG4gICAgQ29ycG9yYXRlTmFtZSA9ICcnLFxyXG4gICAgcGFnZSA9IDEsXHJcbiAgICBfcGFnZVNpemUgPSAxMDBcclxuICApOiBPYnNlcnZhYmxlPFByb0NvbXBhbnlMaXN0PiB7XHJcbiAgICBjb25zdCBwYWdlU2l6ZSA9IDEwMDtcclxuICAgIGlmICh0aGlzLnVzZUhUVFApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0TGlzdE9mQ29tcGFuaWVzRnJvbUFwaShDb3Jwb3JhdGVOYW1lLCBwYWdlLCBwYWdlU2l6ZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZXRMaXN0T2ZDb21wYW5pZXNGcm9tQWR2cGwoQ29ycG9yYXRlTmFtZSwgcGFnZSwgcGFnZVNpemUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQGRlc2NyaXB0aW9uIFJldG9ybmEgYXMgZW1wcmVzYXMgZG8gdXN1w6FyaW9cclxuICAgKiBAcGFyYW0gY29ycG9yYXRlTmFtZSBzdHJpbmcsIG5vbWUgZGEgZW1wcmVzYVxyXG4gICAqIEBwYXJhbSBwYWdlIG51bWJlciwgbsO6bWVybyBkYSBww6FnaW5hXHJcbiAgICogQHBhcmFtIHBhZ2VTaXplIG51bWJlciwgbsO6bWVybyBkZSByZWdpc3Ryb3MgZGEgcMOhZ2luYVxyXG4gICAqIEByZXR1cm5zIFByb0NvbXBhbnlMaXN0LCBsaXN0YSBkZSBlbXByZXNhcyBkbyB1c3XDoXJpb1xyXG4gICAqL1xyXG4gIGdldFVzZXJDb21wYW5pZXMoY29ycG9yYXRlTmFtZTogc3RyaW5nID0gJycsIHBhZ2U6IG51bWJlciA9IDEsIHBhZ2VTaXplOiBudW1iZXIgPSAxMCk6IE9ic2VydmFibGU8UHJvQ29tcGFueUxpc3Q+IHtcclxuICAgIHJldHVybiB0aGlzLmdldExpc3RPZkNvbXBhbmllc0Zyb21BcGkoY29ycG9yYXRlTmFtZSwgcGFnZSwgcGFnZVNpemUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRMaXN0T2ZDb21wYW5pZXNGcm9tQXBpKFxyXG4gICAgQ29ycG9yYXRlTmFtZTogc3RyaW5nLFxyXG4gICAgcGFnZTogbnVtYmVyLFxyXG4gICAgcGFnZVNpemU6IG51bWJlclxyXG4gICk6IE9ic2VydmFibGU8UHJvQ29tcGFueUxpc3Q+IHtcclxuICAgIGxldCBwYXJhbXMgPSBuZXcgSHR0cFBhcmFtcygpXHJcbiAgICAgIC5hcHBlbmQoJ3BhZ2UnLCBwYWdlLnRvU3RyaW5nKCkpXHJcbiAgICAgIC5hcHBlbmQoJ3BhZ2VTaXplJywgcGFnZVNpemUudG9TdHJpbmcoKSk7IC8vIEFsdGVyYWRvIG8gdGFtYW5obyBkYSBww6FnaW5hIHBhcmEgbWVsaG9yYXIgYSBleHBlcmnDqm5jaWEgZG8gdXN1w6FyaW8uXHJcblxyXG4gICAgaWYgKENvcnBvcmF0ZU5hbWUgIT09ICcnKSB7XHJcbiAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoJ0NvcnBvcmF0ZU5hbWUnLCBDb3Jwb3JhdGVOYW1lKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKS5hcHBlbmQoXHJcbiAgICAgICdBY2NlcHQnLFxyXG4gICAgICAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCdcclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxQcm9Db21wYW55TGlzdD4odGhpcy51cmwsIHtcclxuICAgICAgaGVhZGVycyxcclxuICAgICAgcGFyYW1zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0TGlzdE9mQ29tcGFuaWVzRnJvbUFkdnBsKFxyXG4gICAgQ29ycG9yYXRlTmFtZTogc3RyaW5nLFxyXG4gICAgcGFnZTogbnVtYmVyLFxyXG4gICAgcGFnZVNpemU6IG51bWJlclxyXG4gICk6IE9ic2VydmFibGU8UHJvQ29tcGFueUxpc3Q+IHtcclxuICAgIGlmICghdGhpcy5hZHZwbFNlcnZpY2UucHJvdGhldXNDb25uZWN0ZWQoKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5hZHZwbE5vdFByZXBhcmVkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RyaW5nQ29udGVudCA9IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgQ29ycG9yYXRlTmFtZSxcclxuICAgICAgcGFnZSxcclxuICAgICAgcGFnZVNpemVcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IG9ic2VydmFibGVQYXJhbWV0ZXJzID0ge1xyXG4gICAgICBzZW5kSW5mbzoge1xyXG4gICAgICAgIHR5cGU6IHRoaXMuRVZFTlRfR0VUX0xJU1RfSUQsXHJcbiAgICAgICAgY29udGVudDogc3RyaW5nQ29udGVudFxyXG4gICAgICB9LFxyXG4gICAgICBhdXRvRGVzdHJ1Y3Q6IHRydWUsXHJcbiAgICAgIHJlY2VpdmVJZDogdGhpcy5FVkVOVF9TRVRfTElTVF9JRFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBvYnNlcnZhYmxlQ2FsbGJhY2sgPSAoeyBwcm90aGV1c1Jlc3BvbnNlLCBzdWJzY3JpYmVyIH0pID0+IHtcclxuXHJcbiAgICAgIGlmIChwcm90aGV1c1Jlc3BvbnNlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHN1YnNjcmliZXIuZXJyb3Ioe1xyXG4gICAgICAgICAgc3RhdHVzOiA0MDAsXHJcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYGNvbXBhbnkgJHtDb3Jwb3JhdGVOYW1lfSBjb3VsZCBub3QgYmUgZm91bmRgXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgY29tcGFuaWVzRGF0YTogUHJvQ29tcGFueUxpc3QgPSBKU09OLnBhcnNlKHByb3RoZXVzUmVzcG9uc2UpO1xyXG4gICAgICAgIHN1YnNjcmliZXIubmV4dChjb21wYW5pZXNEYXRhKTtcclxuICAgICAgfVxyXG4gICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiB0aGlzLmFkdnBsU2VydmljZS5idWlsZE9ic2VydmFibGU8UHJvQ29tcGFueUxpc3Q+KFxyXG4gICAgICBvYnNlcnZhYmxlQ2FsbGJhY2ssXHJcbiAgICAgIG9ic2VydmFibGVQYXJhbWV0ZXJzXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29tcGFueShjb21wYW55OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb0NvbXBhbnk+IHtcclxuICAgIGlmICh0aGlzLnVzZUhUVFApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29tcGFueUZyb21BcGkoY29tcGFueSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZXRDb21wYW55RnJvbUFkdnBsKGNvbXBhbnkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDb21wYW55RnJvbUFwaShjb21wYW55OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb0NvbXBhbnk+IHtcclxuICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKS5hcHBlbmQoXHJcbiAgICAgICdBY2NlcHQnLFxyXG4gICAgICAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCdcclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldDxQcm9Db21wYW55PihgJHt0aGlzLnVybH0vJHtjb21wYW55fWAsIHsgaGVhZGVycyB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Q29tcGFueUZyb21BZHZwbChjb21wYW55OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb0NvbXBhbnk+IHtcclxuXHJcbiAgICBpZiAoIXRoaXMuYWR2cGxTZXJ2aWNlLnByb3RoZXVzQ29ubmVjdGVkKCkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYWR2cGxOb3RQcmVwYXJlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmFkdnBsU2VydmljZS5idWlsZE9ic2VydmFibGU8UHJvQ29tcGFueT4oXHJcbiAgICAgICh7IHByb3RoZXVzUmVzcG9uc2UsIHN1YnNjcmliZXIgfSkgPT4ge1xyXG4gICAgICAgIGlmIChwcm90aGV1c1Jlc3BvbnNlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgc3Vic2NyaWJlci5lcnJvcih7XHJcbiAgICAgICAgICAgIHN0YXR1czogNDAwLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogYGNvbXBhbnkgJHtjb21wYW55fSBjb3VsZCBub3QgYmUgZm91bmRgXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc3QgY29tcGFueURhdGE6IFByb0NvbXBhbnkgPSBKU09OLnBhcnNlKHByb3RoZXVzUmVzcG9uc2UpO1xyXG4gICAgICAgICAgc3Vic2NyaWJlci5uZXh0KGNvbXBhbnlEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xyXG4gICAgICB9LFxyXG4gICAgICB7XHJcbiAgICAgICAgc2VuZEluZm86IHtcclxuICAgICAgICAgIHR5cGU6IHRoaXMuRVZFTlRfR0VUX09ORV9JRCxcclxuICAgICAgICAgIGNvbnRlbnQ6IGNvbXBhbnlcclxuICAgICAgICB9LFxyXG4gICAgICAgIGF1dG9EZXN0cnVjdDogdHJ1ZSxcclxuICAgICAgICByZWNlaXZlSWQ6IHRoaXMuRVZFTlRfU0VUX09ORV9JRFxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGNvbXBhbnkoKTogUHJvQ29tcGFueSB7XHJcbiAgICBpZiAoc2Vzc2lvblN0b3JhZ2VbQ0FDSEVfS0VZXSkge1xyXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShzZXNzaW9uU3RvcmFnZVtDQUNIRV9LRVldKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB7IENvZGU6ICcnLCBDb3Jwb3JhdGVOYW1lOiAnJywgSW50ZXJuYWxJZDogJycgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldCBjb21wYW55KGNvbXBhbnk6IFByb0NvbXBhbnkpIHtcclxuICAgIHNlc3Npb25TdG9yYWdlW0NBQ0hFX0tFWV0gPSBKU09OLnN0cmluZ2lmeShjb21wYW55KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWR2cGxOb3RQcmVwYXJlZDxUPigpOiBPYnNlcnZhYmxlPFQ+IHtcclxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShzdWJzY3JpYmVyID0+IHtcclxuICAgICAgc3Vic2NyaWJlci5lcnJvcih7XHJcbiAgICAgICAgc3RhdHVzOiA0MDAsXHJcbiAgICAgICAgZGVzY3JpcHRpb246ICdhZHZwbFNlcnZpY2Ugbm90IHByZXBhcmVkIGluIFByb0NvbXBhbnlTZXJ2aWNlJ1xyXG4gICAgICB9KTtcclxuICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBpc0NoYW5uZWxIVFRQKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlSFRUUDtcclxuICB9XHJcblxyXG4gIHNldENoYW5uZWxBc0hUVFAodmFsdWU6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMudXNlSFRUUCA9IHZhbHVlO1xyXG4gIH1cclxufVxyXG4iXX0=