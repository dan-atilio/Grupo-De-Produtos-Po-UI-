import { HttpErrorResponse } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { from } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { valueIsNull } from '../../../util';
import { ProAppConfigService } from '../../pro-app-config';
import { ProAuthService } from '../services/pro-auth/pro-auth.service';
import * as i0 from "@angular/core";
import * as i1 from "./../../pro-js-to-advpl/services/pro-js-to-advpl.service";
/**
 * @description
 *
 * Interceptor que pega a requisição html e insere no header o token.
 */
export class ProAuthInteceptor {
    constructor(injector, advplService) {
        this.injector = injector;
        this.advplService = advplService;
    }
    intercept(original_request, next) {
        let requestResult;
        const proAppConfigService = this.injector.get(ProAppConfigService);
        if (this.isUrlNeedsProAuth(original_request.url)) {
            const isProtheus = proAppConfigService.isProtheusRender;
            if (isProtheus) {
                if (this.doIHaveAToken()) {
                    requestResult = this.appendTokenToRequest(original_request);
                }
                else {
                    requestResult = this.callTokenFromADVPL(original_request);
                }
            }
            else {
                return next.handle(original_request);
            }
        }
        else {
            requestResult = original_request.clone();
        }
        return next.handle(requestResult).pipe(catchError((error, caught) => {
            if (!this.isAuthError(error)) {
                throw error;
            }
            if (this.isUrlNeedsProAuth(original_request.url) &&
                this.doIHaveAToken()) {
                return from(this.appendTokenOnError(original_request, next));
            }
            else {
                return next.handle(original_request.clone());
            }
        }));
    }
    isAuthError(error) {
        return error instanceof HttpErrorResponse && error.status === 401;
    }
    doIHaveAToken() {
        const proAuthService = this.injector.get(ProAuthService);
        const token = proAuthService.token;
        return !valueIsNull(token);
    }
    callTokenFromADVPL(request) {
        this.advplService.jsToAdvpl('internalToken', '');
        return request.clone();
    }
    appendTokenToRequest(request) {
        const proAuthService = this.injector.get(ProAuthService);
        if (!proAuthService.isTokenValid()) {
            proAuthService.updateToken();
        }
        return this.cloneAuthRequest(request, proAuthService.token);
    }
    async appendTokenOnError(request, next) {
        const proAuthService = this.injector.get(ProAuthService);
        if (!proAuthService.isTokenValid()) {
            await proAuthService.updateToken();
        }
        return next.handle(this.cloneAuthRequest(request, proAuthService.token)).toPromise();
    }
    cloneAuthRequest(request, token) {
        return request.clone({
            headers: request.headers.set('Authorization', `Bearer ${token.access_token}`)
        });
    }
    isUrlNeedsProAuth(url) {
        let needProAuth = true;
        const whiteList = [/token/, /assets/];
        for (const whiteUrl of whiteList) {
            if (url.search(whiteUrl) >= 0) {
                needProAuth = false;
                break;
            }
        }
        return needProAuth;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthInteceptor, deps: [{ token: i0.Injector }, { token: i1.ProJsToAdvplService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthInteceptor, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthInteceptor, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i0.Injector }, { type: i1.ProJsToAdvplService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvLWF1dGguaW50ZWNlcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3Byb3RoZXVzLWxpYi1jb3JlL3NyYy9zZXJ2aWNlcy9wcm8tYXV0aG9yaXphdGlvbi9pbnRlcmNlcHRvcnMvcHJvLWF1dGguaW50ZWNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQXdELE1BQU0sc0JBQXNCLENBQUM7QUFDL0csT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU1QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7O0FBSXZFOzs7O0dBSUc7QUFLSCxNQUFNLE9BQU8saUJBQWlCO0lBQzVCLFlBQ1UsUUFBa0IsRUFDbEIsWUFBaUM7UUFEakMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBcUI7SUFDdkMsQ0FBQztJQUVMLFNBQVMsQ0FDUCxnQkFBa0MsRUFDbEMsSUFBaUI7UUFFakIsSUFBSSxhQUErQixDQUFDO1FBQ3BDLE1BQU0sbUJBQW1CLEdBQXdCLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUNoRSxtQkFBbUIsQ0FDcEIsQ0FBQztRQUVGLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2hELE1BQU0sVUFBVSxHQUFHLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDO1lBRXhELElBQUksVUFBVSxFQUFFO2dCQUNk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LGVBQWUsRUFDZixVQUFVLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FDL0I7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsaUJBQWlCLENBQUMsR0FBVztRQUMzQixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsTUFBTSxTQUFTLEdBQUcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFdEMsS0FBSyxNQUFNLFFBQVEsSUFBSSxTQUFTLEVBQUU7WUFDaEMsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0IsV0FBVyxHQUFHLEtBQUssQ0FBQztnQkFDcEIsTUFBTTthQUNQO1NBQ0Y7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDOzhHQXRHVSxpQkFBaUI7a0hBQWpCLGlCQUFpQixjQUZoQixNQUFNOzsyRkFFUCxpQkFBaUI7a0JBSDdCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IHZhbHVlSXNOdWxsIH0gZnJvbSAnLi4vLi4vLi4vdXRpbCc7XHJcbmltcG9ydCB7IFByb0FwcENvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm8tYXBwLWNvbmZpZyc7XHJcbmltcG9ydCB7IFByb0F1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcHJvLWF1dGgvcHJvLWF1dGguc2VydmljZSc7XHJcbmltcG9ydCB7IFByb0F1dGhUb2tlbiB9IGZyb20gJy4uL21vZGVscy9wcm8tYXV0aC10b2tlbic7XHJcbmltcG9ydCB7IFByb0pzVG9BZHZwbFNlcnZpY2UgfSBmcm9tICcuLy4uLy4uL3Byby1qcy10by1hZHZwbC9zZXJ2aWNlcy9wcm8tanMtdG8tYWR2cGwuc2VydmljZSc7XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqXHJcbiAqIEludGVyY2VwdG9yIHF1ZSBwZWdhIGEgcmVxdWlzacOnw6NvIGh0bWwgZSBpbnNlcmUgbm8gaGVhZGVyIG8gdG9rZW4uXHJcbiAqL1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUHJvQXV0aEludGVjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIGFkdnBsU2VydmljZTogUHJvSnNUb0FkdnBsU2VydmljZVxyXG4gICkgeyB9XHJcblxyXG4gIGludGVyY2VwdChcclxuICAgIG9yaWdpbmFsX3JlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sXHJcbiAgICBuZXh0OiBIdHRwSGFuZGxlclxyXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcclxuICAgIGxldCByZXF1ZXN0UmVzdWx0OiBIdHRwUmVxdWVzdDxhbnk+O1xyXG4gICAgY29uc3QgcHJvQXBwQ29uZmlnU2VydmljZTogUHJvQXBwQ29uZmlnU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFxyXG4gICAgICBQcm9BcHBDb25maWdTZXJ2aWNlXHJcbiAgICApO1xyXG5cclxuICAgIGlmICh0aGlzLmlzVXJsTmVlZHNQcm9BdXRoKG9yaWdpbmFsX3JlcXVlc3QudXJsKSkge1xyXG4gICAgICBjb25zdCBpc1Byb3RoZXVzID0gcHJvQXBwQ29uZmlnU2VydmljZS5pc1Byb3RoZXVzUmVuZGVyO1xyXG5cclxuICAgICAgaWYgKGlzUHJvdGhldXMpIHtcclxuICAgICAgICBpZiAodGhpcy5kb0lIYXZlQVRva2VuKCkpIHtcclxuICAgICAgICAgIHJlcXVlc3RSZXN1bHQgPSB0aGlzLmFwcGVuZFRva2VuVG9SZXF1ZXN0KG9yaWdpbmFsX3JlcXVlc3QpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXF1ZXN0UmVzdWx0ID0gdGhpcy5jYWxsVG9rZW5Gcm9tQURWUEwob3JpZ2luYWxfcmVxdWVzdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBuZXh0LmhhbmRsZShvcmlnaW5hbF9yZXF1ZXN0KTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVxdWVzdFJlc3VsdCA9IG9yaWdpbmFsX3JlcXVlc3QuY2xvbmUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0UmVzdWx0KS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKChlcnJvciwgY2F1Z2h0KSA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlzQXV0aEVycm9yKGVycm9yKSkge1xyXG4gICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIHRoaXMuaXNVcmxOZWVkc1Byb0F1dGgob3JpZ2luYWxfcmVxdWVzdC51cmwpICYmXHJcbiAgICAgICAgICB0aGlzLmRvSUhhdmVBVG9rZW4oKVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgcmV0dXJuIGZyb20odGhpcy5hcHBlbmRUb2tlbk9uRXJyb3Iob3JpZ2luYWxfcmVxdWVzdCwgbmV4dCkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUob3JpZ2luYWxfcmVxdWVzdC5jbG9uZSgpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0F1dGhFcnJvcihlcnJvcjogYW55KTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBIdHRwRXJyb3JSZXNwb25zZSAmJiBlcnJvci5zdGF0dXMgPT09IDQwMTtcclxuICB9XHJcblxyXG4gIGRvSUhhdmVBVG9rZW4oKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBwcm9BdXRoU2VydmljZTogUHJvQXV0aFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChQcm9BdXRoU2VydmljZSk7XHJcbiAgICBjb25zdCB0b2tlbiA9IHByb0F1dGhTZXJ2aWNlLnRva2VuO1xyXG4gICAgcmV0dXJuICF2YWx1ZUlzTnVsbCh0b2tlbik7XHJcbiAgfVxyXG5cclxuICBjYWxsVG9rZW5Gcm9tQURWUEwocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xyXG4gICAgdGhpcy5hZHZwbFNlcnZpY2UuanNUb0FkdnBsKCdpbnRlcm5hbFRva2VuJywgJycpO1xyXG4gICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoKTtcclxuICB9XHJcblxyXG4gIGFwcGVuZFRva2VuVG9SZXF1ZXN0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcclxuICAgIGNvbnN0IHByb0F1dGhTZXJ2aWNlOiBQcm9BdXRoU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFByb0F1dGhTZXJ2aWNlKTtcclxuXHJcbiAgICBpZiAoIXByb0F1dGhTZXJ2aWNlLmlzVG9rZW5WYWxpZCgpKSB7XHJcbiAgICAgIHByb0F1dGhTZXJ2aWNlLnVwZGF0ZVRva2VuKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY2xvbmVBdXRoUmVxdWVzdChyZXF1ZXN0LCBwcm9BdXRoU2VydmljZS50b2tlbik7XHJcbiAgfVxyXG5cclxuICBhc3luYyBhcHBlbmRUb2tlbk9uRXJyb3IocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBQcm9taXNlPEh0dHBFdmVudDxhbnk+PiB7XHJcbiAgICBjb25zdCBwcm9BdXRoU2VydmljZTogUHJvQXV0aFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChQcm9BdXRoU2VydmljZSk7XHJcblxyXG4gICAgaWYgKCFwcm9BdXRoU2VydmljZS5pc1Rva2VuVmFsaWQoKSkge1xyXG4gICAgICBhd2FpdCBwcm9BdXRoU2VydmljZS51cGRhdGVUb2tlbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXh0LmhhbmRsZSh0aGlzLmNsb25lQXV0aFJlcXVlc3QocmVxdWVzdCwgcHJvQXV0aFNlcnZpY2UudG9rZW4pKS50b1Byb21pc2UoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xvbmVBdXRoUmVxdWVzdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCB0b2tlbjogUHJvQXV0aFRva2VuKTogSHR0cFJlcXVlc3Q8YW55PiB7XHJcbiAgICByZXR1cm4gcmVxdWVzdC5jbG9uZSh7XHJcbiAgICAgIGhlYWRlcnM6IHJlcXVlc3QuaGVhZGVycy5zZXQoXHJcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nLFxyXG4gICAgICAgIGBCZWFyZXIgJHt0b2tlbi5hY2Nlc3NfdG9rZW59YFxyXG4gICAgICApXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGlzVXJsTmVlZHNQcm9BdXRoKHVybDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgbmVlZFByb0F1dGggPSB0cnVlO1xyXG4gICAgY29uc3Qgd2hpdGVMaXN0ID0gWy90b2tlbi8sIC9hc3NldHMvXTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IHdoaXRlVXJsIG9mIHdoaXRlTGlzdCkge1xyXG4gICAgICBpZiAodXJsLnNlYXJjaCh3aGl0ZVVybCkgPj0gMCkge1xyXG4gICAgICAgIG5lZWRQcm9BdXRoID0gZmFsc2U7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBuZWVkUHJvQXV0aDtcclxuICB9XHJcbn1cclxuIl19