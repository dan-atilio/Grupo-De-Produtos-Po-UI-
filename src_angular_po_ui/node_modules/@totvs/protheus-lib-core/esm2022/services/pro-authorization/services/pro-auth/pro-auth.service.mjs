import { HttpHeaders, HttpParams } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable, Subject } from 'rxjs';
import { environment } from '../../../../environments/environment';
import { valueIsNull } from '../../../../util';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../pro-user-info/pro-user-info.service";
import * as i3 from "../../../pro-js-to-advpl/services/pro-js-to-advpl.service";
const CACHE_KEY_TOKEN = 'ERPTOKEN';
const TOKEN_ENDPOINT = '/api/oauth2/v1/token';
export class ProAuthService {
    constructor(http, proUserInfoService, advplService) {
        this.http = http;
        this.proUserInfoService = proUserInfoService;
        this.advplService = advplService;
        this.proUserInfoService.setChannelAsHTTP(environment.useHTTP);
    }
    requestLoginDefaults() {
        if (!valueIsNull(this.advplService.getWebChannel())) {
            return this.advplService.buildObservable(({ protheusResponse, subscriber }) => {
                if (protheusResponse.length === 0) {
                    subscriber.next({
                        username: '',
                        username_when: true,
                        password: '',
                        remember_user: false,
                        show_remember_user: false
                    });
                }
                else {
                    const startKeys = JSON.parse(protheusResponse);
                    subscriber.next(startKeys);
                }
                subscriber.complete();
            }, {
                sendInfo: {
                    type: 'getLoginStart'
                },
                autoDestruct: true
            });
        }
        else {
            return new Observable(subscriber => {
                subscriber.next({
                    username: '',
                    username_when: true,
                    password: '',
                    remember_user: false,
                    show_remember_user: false
                });
                subscriber.complete();
            });
        }
    }
    requestToken(user) {
        if (this.advplService.protheusConnected()) {
            return this.advplService.buildObservable(({ protheusResponse, subscriber }) => {
                if (protheusResponse.length === 0) {
                    subscriber.error({ status: 401 });
                }
                else {
                    const tokenInside = JSON.parse(protheusResponse);
                    subscriber.next(tokenInside);
                }
                subscriber.complete();
            }, {
                sendInfo: {
                    type: 'loginInside',
                    content: btoa(JSON.stringify({ "usr": user.username, "psw": user.password, "remember": user.remember_user }))
                },
                autoDestruct: true,
                receiveId: 'setToken'
            });
        }
        else {
            const headers = new HttpHeaders()
                .append('X-Totvs-No-Error', 'true')
                .set('grant_type', 'password')
                .set('username', user.username)
                .set('password', user.password);
            return this.http.post(TOKEN_ENDPOINT, {}, { headers });
        }
    }
    refreshToken(refresh_token) {
        const params = new HttpParams()
            .set('grant_type', 'refresh_token')
            .set('refresh_token', refresh_token);
        return this.http.post(TOKEN_ENDPOINT, {}, { params });
    }
    login(user) {
        const loginSubject = new Subject();
        this.requestToken(user).subscribe({
            next: (token) => {
                const userId = this.getTokenPayload(token.access_token).userid;
                this.saveToken(token);
                this.saveUserInfo(userId);
                loginSubject.next(token);
            },
            error: (error) => {
                loginSubject.error(error);
            }
        });
        return loginSubject.asObservable();
    }
    passwordRecovery(user) {
        this.advplService.jsToAdvpl('openPasswordRecovery', user);
    }
    saveToken(token) {
        sessionStorage[CACHE_KEY_TOKEN] = JSON.stringify(token);
    }
    saveUserInfo(userId) {
        this.proUserInfoService.get(userId).subscribe((userInfo) => {
            this._ProUserInfo = userInfo;
        });
    }
    isTokenValid(now = Date.now()) {
        const date_now = Math.round(now / 1000.0);
        const payload = this.getTokenPayload(this.token.access_token);
        // Faltando 10% do tempo de expiração já peço a renovação
        return payload.exp - date_now > this.token.expires_in / 10;
    }
    async updateToken() {
        const token = await this.refreshToken(this.token.refresh_token).toPromise();
        this.saveToken(token);
        this._token = token;
    }
    get userInfo() {
        return this._ProUserInfo;
    }
    get token() {
        const token_string = sessionStorage[CACHE_KEY_TOKEN];
        if (token_string) {
            this._token = JSON.parse(token_string);
        }
        return this._token;
    }
    get isUserAuthenticate() {
        return !valueIsNull(this.token) && !valueIsNull(this.token.access_token);
    }
    logout() {
        sessionStorage.removeItem(CACHE_KEY_TOKEN);
        this.proUserInfoService.removeFromStorage();
    }
    getTokenPayload(token = this.token.access_token) {
        return JSON.parse(atob(token.split('.')[1]));
    }
    get userId() {
        return this.getTokenPayload().userid;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthService, deps: [{ token: i1.HttpClient }, { token: i2.ProUserInfoService }, { token: i3.ProJsToAdvplService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.9", ngImport: i0, type: ProAuthService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i1.HttpClient }, { type: i2.ProUserInfoService }, { type: i3.ProJsToAdvplService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvLWF1dGguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3Byb3RoZXVzLWxpYi1jb3JlL3NyYy9zZXJ2aWNlcy9wcm8tYXV0aG9yaXphdGlvbi9zZXJ2aWNlcy9wcm8tYXV0aC9wcm8tYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxXQUFXLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0UsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFbkUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7OztBQU8vQyxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUM7QUFDbkMsTUFBTSxjQUFjLEdBQUcsc0JBQXNCLENBQUM7QUFLOUMsTUFBTSxPQUFPLGNBQWM7SUFLekIsWUFDVSxJQUFnQixFQUNoQixrQkFBc0MsRUFDdEMsWUFBaUM7UUFGakMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtRQUV6QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxvQkFBb0I7UUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDLEVBQUU7WUFDbkQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FDdEMsQ0FBQyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUU7Z0JB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Q0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRUQsTUFBTTtRQUNKLGNBQWMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDOUMsQ0FBQztJQUVELGVBQWUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZO1FBQzdDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxDQUFDOzhHQXZLVSxjQUFjO2tIQUFkLGNBQWMsY0FGYixNQUFNOzsyRkFFUCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZW52aXJvbm1lbnQgfSBmcm9tICcuLi8uLi8uLi8uLi9lbnZpcm9ubWVudHMvZW52aXJvbm1lbnQnO1xyXG5cclxuaW1wb3J0IHsgdmFsdWVJc051bGwgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlsJztcclxuaW1wb3J0IHsgUHJvSnNUb0FkdnBsU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3Byby1qcy10by1hZHZwbC9zZXJ2aWNlcy9wcm8tanMtdG8tYWR2cGwuc2VydmljZSc7XHJcbmltcG9ydCB7IFByb0FjY2Vzc1Rva2VuLCBQcm9BdXRoVG9rZW4gfSBmcm9tICcuLi8uLi9tb2RlbHMvcHJvLWF1dGgtdG9rZW4nO1xyXG5pbXBvcnQgeyBQcm9Vc2VyIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3Byby11c2VyJztcclxuaW1wb3J0IHsgUHJvVXNlckluZm8gfSBmcm9tICcuLi8uLi9tb2RlbHMvcHJvLXVzZXItaW5mbyc7XHJcbmltcG9ydCB7IFByb1VzZXJJbmZvU2VydmljZSB9IGZyb20gJy4uL3Byby11c2VyLWluZm8vcHJvLXVzZXItaW5mby5zZXJ2aWNlJztcclxuXHJcbmNvbnN0IENBQ0hFX0tFWV9UT0tFTiA9ICdFUlBUT0tFTic7XHJcbmNvbnN0IFRPS0VOX0VORFBPSU5UID0gJy9hcGkvb2F1dGgyL3YxL3Rva2VuJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFByb0F1dGhTZXJ2aWNlIHtcclxuICBwdWJsaWMgcmVkaXJlY3RVcmw6IHN0cmluZztcclxuICBwcml2YXRlIF90b2tlbjogUHJvQXV0aFRva2VuO1xyXG4gIHByaXZhdGUgX1Byb1VzZXJJbmZvOiBQcm9Vc2VySW5mbztcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICBwcml2YXRlIHByb1VzZXJJbmZvU2VydmljZTogUHJvVXNlckluZm9TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBhZHZwbFNlcnZpY2U6IFByb0pzVG9BZHZwbFNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMucHJvVXNlckluZm9TZXJ2aWNlLnNldENoYW5uZWxBc0hUVFAoZW52aXJvbm1lbnQudXNlSFRUUCk7XHJcbiAgfVxyXG5cclxuICByZXF1ZXN0TG9naW5EZWZhdWx0cygpOiBPYnNlcnZhYmxlPFByb1VzZXI+IHtcclxuICAgIGlmICghdmFsdWVJc051bGwodGhpcy5hZHZwbFNlcnZpY2UuZ2V0V2ViQ2hhbm5lbCgpKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5hZHZwbFNlcnZpY2UuYnVpbGRPYnNlcnZhYmxlPFByb1VzZXI+KFxyXG4gICAgICAgICh7IHByb3RoZXVzUmVzcG9uc2UsIHN1YnNjcmliZXIgfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHByb3RoZXVzUmVzcG9uc2UubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHN1YnNjcmliZXIubmV4dCh7XHJcbiAgICAgICAgICAgICAgdXNlcm5hbWU6ICcnLFxyXG4gICAgICAgICAgICAgIHVzZXJuYW1lX3doZW46IHRydWUsXHJcbiAgICAgICAgICAgICAgcGFzc3dvcmQ6ICcnLFxyXG4gICAgICAgICAgICAgIHJlbWVtYmVyX3VzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICAgIHNob3dfcmVtZW1iZXJfdXNlcjogZmFsc2VcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBzdGFydEtleXMgPSBKU09OLnBhcnNlKHByb3RoZXVzUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICBzdWJzY3JpYmVyLm5leHQoc3RhcnRLZXlzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHNlbmRJbmZvOiB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdnZXRMb2dpblN0YXJ0J1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGF1dG9EZXN0cnVjdDogdHJ1ZVxyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxQcm9Vc2VyPihzdWJzY3JpYmVyID0+IHtcclxuICAgICAgICBzdWJzY3JpYmVyLm5leHQoe1xyXG4gICAgICAgICAgdXNlcm5hbWU6ICcnLFxyXG4gICAgICAgICAgdXNlcm5hbWVfd2hlbjogdHJ1ZSxcclxuICAgICAgICAgIHBhc3N3b3JkOiAnJyxcclxuICAgICAgICAgIHJlbWVtYmVyX3VzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgc2hvd19yZW1lbWJlcl91c2VyOiBmYWxzZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXF1ZXN0VG9rZW4odXNlcjogUHJvVXNlcik6IE9ic2VydmFibGU8UHJvQXV0aFRva2VuPiB7XHJcbiAgICBpZiAodGhpcy5hZHZwbFNlcnZpY2UucHJvdGhldXNDb25uZWN0ZWQoKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5hZHZwbFNlcnZpY2UuYnVpbGRPYnNlcnZhYmxlPFByb0F1dGhUb2tlbj4oXHJcbiAgICAgICAgKHsgcHJvdGhldXNSZXNwb25zZSwgc3Vic2NyaWJlciB9KSA9PiB7XHJcbiAgICAgICAgICBpZiAocHJvdGhldXNSZXNwb25zZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgc3Vic2NyaWJlci5lcnJvcih7IHN0YXR1czogNDAxIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW5JbnNpZGUgPSBKU09OLnBhcnNlKHByb3RoZXVzUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICBzdWJzY3JpYmVyLm5leHQodG9rZW5JbnNpZGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgc2VuZEluZm86IHtcclxuICAgICAgICAgICAgdHlwZTogJ2xvZ2luSW5zaWRlJyxcclxuICAgICAgICAgICAgY29udGVudDogYnRvYShcclxuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IFwidXNyXCI6IHVzZXIudXNlcm5hbWUsIFwicHN3XCI6IHVzZXIucGFzc3dvcmQsIFwicmVtZW1iZXJcIjogdXNlci5yZW1lbWJlcl91c2VyIH0pXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBhdXRvRGVzdHJ1Y3Q6IHRydWUsXHJcbiAgICAgICAgICByZWNlaXZlSWQ6ICdzZXRUb2tlbidcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKClcclxuICAgICAgICAuYXBwZW5kKCdYLVRvdHZzLU5vLUVycm9yJywgJ3RydWUnKVxyXG4gICAgICAgIC5zZXQoJ2dyYW50X3R5cGUnLCAncGFzc3dvcmQnKVxyXG4gICAgICAgIC5zZXQoJ3VzZXJuYW1lJywgdXNlci51c2VybmFtZSlcclxuICAgICAgICAuc2V0KCdwYXNzd29yZCcsIHVzZXIucGFzc3dvcmQpO1xyXG4gICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8UHJvQXV0aFRva2VuPihUT0tFTl9FTkRQT0lOVCwge30sIHsgaGVhZGVycyB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlZnJlc2hUb2tlbihyZWZyZXNoX3Rva2VuOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFByb0F1dGhUb2tlbj4ge1xyXG4gICAgY29uc3QgcGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKVxyXG4gICAgICAuc2V0KCdncmFudF90eXBlJywgJ3JlZnJlc2hfdG9rZW4nKVxyXG4gICAgICAuc2V0KCdyZWZyZXNoX3Rva2VuJywgcmVmcmVzaF90b2tlbik7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PFByb0F1dGhUb2tlbj4oVE9LRU5fRU5EUE9JTlQsIHt9LCB7IHBhcmFtcyB9KTtcclxuICB9XHJcblxyXG4gIGxvZ2luKHVzZXI6IFByb1VzZXIpOiBPYnNlcnZhYmxlPFByb0F1dGhUb2tlbj4ge1xyXG4gICAgY29uc3QgbG9naW5TdWJqZWN0ID0gbmV3IFN1YmplY3Q8UHJvQXV0aFRva2VuPigpO1xyXG5cclxuICAgIHRoaXMucmVxdWVzdFRva2VuKHVzZXIpLnN1YnNjcmliZShcclxuICAgICAge1xyXG4gICAgICAgIG5leHQ6ICh0b2tlbjogUHJvQXV0aFRva2VuKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB1c2VySWQgPSB0aGlzLmdldFRva2VuUGF5bG9hZCh0b2tlbi5hY2Nlc3NfdG9rZW4pLnVzZXJpZDtcclxuICAgICAgICAgIHRoaXMuc2F2ZVRva2VuKHRva2VuKTtcclxuICAgICAgICAgIHRoaXMuc2F2ZVVzZXJJbmZvKHVzZXJJZCk7XHJcbiAgICAgICAgICBsb2dpblN1YmplY3QubmV4dCh0b2tlbik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICBsb2dpblN1YmplY3QuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gbG9naW5TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xyXG4gIH1cclxuXHJcbiAgcGFzc3dvcmRSZWNvdmVyeSh1c2VyOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuYWR2cGxTZXJ2aWNlLmpzVG9BZHZwbCgnb3BlblBhc3N3b3JkUmVjb3ZlcnknLCB1c2VyKTtcclxuICB9XHJcblxyXG4gIHNhdmVUb2tlbih0b2tlbjogUHJvQXV0aFRva2VuKSB7XHJcbiAgICBzZXNzaW9uU3RvcmFnZVtDQUNIRV9LRVlfVE9LRU5dID0gSlNPTi5zdHJpbmdpZnkodG9rZW4pO1xyXG4gIH1cclxuXHJcbiAgc2F2ZVVzZXJJbmZvKHVzZXJJZDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnByb1VzZXJJbmZvU2VydmljZS5nZXQodXNlcklkKS5zdWJzY3JpYmUoKHVzZXJJbmZvOiBQcm9Vc2VySW5mbykgPT4ge1xyXG4gICAgICB0aGlzLl9Qcm9Vc2VySW5mbyA9IHVzZXJJbmZvO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBpc1Rva2VuVmFsaWQobm93ID0gRGF0ZS5ub3coKSk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZGF0ZV9ub3cgPSBNYXRoLnJvdW5kKG5vdyAvIDEwMDAuMCk7XHJcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5nZXRUb2tlblBheWxvYWQodGhpcy50b2tlbi5hY2Nlc3NfdG9rZW4pO1xyXG4gICAgLy8gRmFsdGFuZG8gMTAlIGRvIHRlbXBvIGRlIGV4cGlyYcOnw6NvIGrDoSBwZcOnbyBhIHJlbm92YcOnw6NvXHJcbiAgICByZXR1cm4gcGF5bG9hZC5leHAgLSBkYXRlX25vdyA+IHRoaXMudG9rZW4uZXhwaXJlc19pbiAvIDEwO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgdXBkYXRlVG9rZW4oKSB7XHJcbiAgICBjb25zdCB0b2tlbjogUHJvQXV0aFRva2VuID0gYXdhaXQgdGhpcy5yZWZyZXNoVG9rZW4odGhpcy50b2tlbi5yZWZyZXNoX3Rva2VuKS50b1Byb21pc2UoKTtcclxuICAgIHRoaXMuc2F2ZVRva2VuKHRva2VuKTtcclxuICAgIHRoaXMuX3Rva2VuID0gdG9rZW47XHJcbiAgfVxyXG5cclxuICBnZXQgdXNlckluZm8oKTogUHJvVXNlckluZm8ge1xyXG4gICAgcmV0dXJuIHRoaXMuX1Byb1VzZXJJbmZvO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHRva2VuKCk6IFByb0F1dGhUb2tlbiB7XHJcbiAgICBjb25zdCB0b2tlbl9zdHJpbmcgPSBzZXNzaW9uU3RvcmFnZVtDQUNIRV9LRVlfVE9LRU5dO1xyXG4gICAgaWYgKHRva2VuX3N0cmluZykge1xyXG4gICAgICB0aGlzLl90b2tlbiA9IEpTT04ucGFyc2UodG9rZW5fc3RyaW5nKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl90b2tlbjtcclxuICB9XHJcblxyXG4gIGdldCBpc1VzZXJBdXRoZW50aWNhdGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gIXZhbHVlSXNOdWxsKHRoaXMudG9rZW4pICYmICF2YWx1ZUlzTnVsbCh0aGlzLnRva2VuLmFjY2Vzc190b2tlbik7XHJcbiAgfVxyXG5cclxuICBsb2dvdXQoKTogdm9pZCB7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKENBQ0hFX0tFWV9UT0tFTik7XHJcbiAgICB0aGlzLnByb1VzZXJJbmZvU2VydmljZS5yZW1vdmVGcm9tU3RvcmFnZSgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0VG9rZW5QYXlsb2FkKHRva2VuID0gdGhpcy50b2tlbi5hY2Nlc3NfdG9rZW4pOiBQcm9BY2Nlc3NUb2tlbiB7XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShhdG9iKHRva2VuLnNwbGl0KCcuJylbMV0pKTtcclxuICB9XHJcblxyXG4gIGdldCB1c2VySWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmdldFRva2VuUGF5bG9hZCgpLnVzZXJpZDtcclxuICB9XHJcbn1cclxuIl19